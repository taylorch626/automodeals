/**
 * Calculate the width of the window, minus padding, and modal padding
 * @param {number} windowWidth - window width in pixels
 */
var doCssCalc = function(windowWidth) {
  var css = 40 + (windowWidth * .0625); /* .ksl-assets-modal, .ddm-modal has 3.125% padding and .ddm-modal__body has 20px padding on each side */
  return Math.floor(windowWidth - css);
};

/**
 * submit page has 25px more to account for
 */
var isSubmitPage = function() {
  return location.href.indexOf('submit') > -1 ? 25 : 0;
};

/**
 * The trade in valet method
 */
var tradeInValet = {
  closeModal: function () {
    ddm.modal($('.trade_in_valet_modal')).close();
  },

  openModal: function () {
    var tradeInUrl = window.location.href.toString().split(window.location.host)[1];
    var tradeInIndex = tradeInUrl.indexOf('tradeInValet=true');
    if (tradeInIndex > -1) {
      // Setting a wait so the modals will be wired,
      // and the page is loaded more completely before the trade-In Valet form is opened.
      // We want to click so the tracking will be recorded
      $('.vdp-contact-info a.trade_in_valet_modal_link').click();
    }
  }
};

/**
 * Modal-only code
 */
$(document).ready(function () {
  var tradeInValetModalInner = $('.trade_in_valet_modal .ddm-modal__inner');
  if(tradeInValetModalInner.length > 0) {
    setTimeout(function () {
      tradeInValet.openModal();
    }, 500);


    var isMobile = doCssCalc(window.innerWidth) < 738; // find out if it is mobile
    var extraWidth = isSubmitPage(); // submit page has 25px more to account for

    if (isMobile) {
      tradeInValetModalInner.css({'max-width': 783 - extraWidth});
    } else {
      tradeInValetModalInner.css({'max-width': 990 - extraWidth});
    }
  }
});


/**
 * Iframe-specific code
 */

/**
 * handles interactions between trade in valet iframe and ksl
 */
function handlePostMessage() {
  // no need to continue since there is no data to send
  if (!window.tivPostMessage) {
    return;
  }

  var tivFrame = window.frames['trade-in-valet']

  // if da frame ain't there they ain't no point in movin' forward is dey?
  if (!tivFrame) {
    return;
  }

  // make the data object and replace null values with empty strings
  var data = {
    vin: tivPostMessage.vin || '',
    odometer: tivPostMessage.odometer || '',
    name: tivPostMessage.name || '',
    email: tivPostMessage.email || '',
    zip: tivPostMessage.zip || ''
  };

  var origin = /https?:\/\/(dealer|mobile)\.tradeinvalet\.com/;

  window.addEventListener("message", function(e) {
    // assume this is them telling us that they are ready
    if (e.origin.match(origin) && tivPostMessage) {
      // has to be in specific order comma separated
      var message = data.vin + ','
          + data.odometer + ','
          + data.name + ','
          + data.email + ','
          + data.zip;
      tivFrame.postMessage(message, e.origin);
    }
  }, false);
}

$(document).ready(function () {
  var tradeInValetIframe = $('#trade-in-valet');
  var dealerId = tradeInValetIframe.attr('data-dealer-id') || 809;
  tradeInValetIframe.css("border", "none");

  // gotta talk to trade in valet to send them info if we have it
  handlePostMessage();

  // index of window widths that map to the size of the trade in valet content -- this may be replaced with postMessage if we can get them to do that
  var sizeIndex = {"157":{"windowWidth":157,"windowHeight":2024,"containerWidth":127,"containerHeight":3540},"158":{"windowWidth":158,"windowHeight":2024,"containerWidth":128,"containerHeight":3541},"160":{"windowWidth":160,"windowHeight":2024,"containerWidth":130,"containerHeight":3541},"162":{"windowWidth":162,"windowHeight":2024,"containerWidth":132,"containerHeight":3542},"166":{"windowWidth":166,"windowHeight":2024,"containerWidth":136,"containerHeight":3543},"168":{"windowWidth":168,"windowHeight":2024,"containerWidth":138,"containerHeight":3543},"169":{"windowWidth":169,"windowHeight":2024,"containerWidth":139,"containerHeight":3543},"172":{"windowWidth":172,"windowHeight":2024,"containerWidth":142,"containerHeight":3544},"178":{"windowWidth":178,"windowHeight":2024,"containerWidth":148,"containerHeight":3546},"182":{"windowWidth":182,"windowHeight":2024,"containerWidth":152,"containerHeight":3547},"186":{"windowWidth":186,"windowHeight":2024,"containerWidth":156,"containerHeight":3548},"189":{"windowWidth":189,"windowHeight":2024,"containerWidth":159,"containerHeight":3548},"192":{"windowWidth":192,"windowHeight":2024,"containerWidth":162,"containerHeight":3549},"194":{"windowWidth":194,"windowHeight":2024,"containerWidth":164,"containerHeight":3550},"197":{"windowWidth":197,"windowHeight":2024,"containerWidth":167,"containerHeight":3551},"200":{"windowWidth":200,"windowHeight":2024,"containerWidth":170,"containerHeight":3551},"207":{"windowWidth":207,"windowHeight":2024,"containerWidth":177,"containerHeight":3553},"211":{"windowWidth":211,"windowHeight":2024,"containerWidth":181,"containerHeight":3554},"217":{"windowWidth":217,"windowHeight":2024,"containerWidth":187,"containerHeight":3556},"229":{"windowWidth":229,"windowHeight":2024,"containerWidth":199,"containerHeight":3559},"237":{"windowWidth":237,"windowHeight":2024,"containerWidth":207,"containerHeight":3521},"246":{"windowWidth":246,"windowHeight":2024,"containerWidth":216,"containerHeight":3511},"257":{"windowWidth":257,"windowHeight":2024,"containerWidth":227,"containerHeight":3433},"269":{"windowWidth":269,"windowHeight":2024,"containerWidth":239,"containerHeight":3384},"270":{"windowWidth":270,"windowHeight":2024,"containerWidth":240,"containerHeight":3372},"280":{"windowWidth":280,"windowHeight":2024,"containerWidth":250,"containerHeight":3355},"297":{"windowWidth":297,"windowHeight":2024,"containerWidth":267,"containerHeight":3282},"312":{"windowWidth":312,"windowHeight":2024,"containerWidth":282,"containerHeight":3178},"317":{"windowWidth":317,"windowHeight":2024,"containerWidth":287,"containerHeight":3179},"333":{"windowWidth":333,"windowHeight":2024,"containerWidth":303,"containerHeight":3163},"346":{"windowWidth":346,"windowHeight":2024,"containerWidth":316,"containerHeight":3114},"361":{"windowWidth":361,"windowHeight":2024,"containerWidth":331,"containerHeight":3089},"374":{"windowWidth":374,"windowHeight":2024,"containerWidth":344,"containerHeight":3093},"398":{"windowWidth":398,"windowHeight":2024,"containerWidth":368,"containerHeight":3099},"401":{"windowWidth":401,"windowHeight":2024,"containerWidth":371,"containerHeight":3099},"409":{"windowWidth":409,"windowHeight":2024,"containerWidth":379,"containerHeight":3101},"411":{"windowWidth":411,"windowHeight":2024,"containerWidth":381,"containerHeight":3102},"413":{"windowWidth":413,"windowHeight":2024,"containerWidth":383,"containerHeight":3102},"416":{"windowWidth":416,"windowHeight":2024,"containerWidth":386,"containerHeight":3103},"417":{"windowWidth":417,"windowHeight":2024,"containerWidth":387,"containerHeight":3104},"427":{"windowWidth":427,"windowHeight":2024,"containerWidth":397,"containerHeight":3106},"430":{"windowWidth":430,"windowHeight":2024,"containerWidth":400,"containerHeight":3107},"445":{"windowWidth":445,"windowHeight":2024,"containerWidth":415,"containerHeight":3111},"469":{"windowWidth":469,"windowHeight":2024,"containerWidth":439,"containerHeight":3079},"507":{"windowWidth":507,"windowHeight":2024,"containerWidth":477,"containerHeight":2760},"522":{"windowWidth":522,"windowHeight":2024,"containerWidth":492,"containerHeight":2764},"533":{"windowWidth":533,"windowHeight":2024,"containerWidth":503,"containerHeight":2767},"537":{"windowWidth":537,"windowHeight":2024,"containerWidth":507,"containerHeight":2768},"544":{"windowWidth":544,"windowHeight":2024,"containerWidth":514,"containerHeight":2770},"559":{"windowWidth":559,"windowHeight":2024,"containerWidth":529,"containerHeight":2774},"560":{"windowWidth":560,"windowHeight":2024,"containerWidth":530,"containerHeight":2774},"571":{"windowWidth":571,"windowHeight":2024,"containerWidth":541,"containerHeight":2777},"583":{"windowWidth":583,"windowHeight":2024,"containerWidth":553,"containerHeight":2779},"598":{"windowWidth":598,"windowHeight":2024,"containerWidth":568,"containerHeight":2779},"614":{"windowWidth":614,"windowHeight":2024,"containerWidth":584,"containerHeight":2779},"626":{"windowWidth":626,"windowHeight":2024,"containerWidth":596,"containerHeight":2779},"627":{"windowWidth":627,"windowHeight":2024,"containerWidth":597,"containerHeight":2779},"629":{"windowWidth":629,"windowHeight":2024,"containerWidth":599,"containerHeight":2779},"630":{"windowWidth":630,"windowHeight":2024,"containerWidth":600,"containerHeight":2779},"637":{"windowWidth":637,"windowHeight":2024,"containerWidth":607,"containerHeight":2767},"643":{"windowWidth":643,"windowHeight":2024,"containerWidth":613,"containerHeight":2767},"645":{"windowWidth":645,"windowHeight":2024,"containerWidth":615,"containerHeight":2767},"649":{"windowWidth":649,"windowHeight":2024,"containerWidth":619,"containerHeight":2767},"653":{"windowWidth":653,"windowHeight":2024,"containerWidth":623,"containerHeight":2767},"655":{"windowWidth":655,"windowHeight":2024,"containerWidth":625,"containerHeight":2767},"656":{"windowWidth":656,"windowHeight":2024,"containerWidth":626,"containerHeight":2767},"665":{"windowWidth":665,"windowHeight":2024,"containerWidth":635,"containerHeight":2767},"666":{"windowWidth":666,"windowHeight":2024,"containerWidth":636,"containerHeight":2767},"679":{"windowWidth":679,"windowHeight":2024,"containerWidth":649,"containerHeight":2767},"689":{"windowWidth":689,"windowHeight":2024,"containerWidth":659,"containerHeight":2767},"694":{"windowWidth":694,"windowHeight":2024,"containerWidth":664,"containerHeight":2767},"695":{"windowWidth":695,"windowHeight":2024,"containerWidth":665,"containerHeight":2767},"723":{"windowWidth":723,"windowHeight":2024,"containerWidth":693,"containerHeight":2767},"727":{"windowWidth":727,"windowHeight":2024,"containerWidth":697,"containerHeight":2767},"728":{"windowWidth":728,"windowHeight":2024,"containerWidth":698,"containerHeight":2767},"738":{"windowWidth":738,"windowHeight":2024,"containerWidth":708,"containerHeight":1409},"741":{"windowWidth":741,"windowHeight":2024,"containerWidth":711,"containerHeight":1409},"744":{"windowWidth":744,"windowHeight":2024,"containerWidth":714,"containerHeight":2767},"756":{"windowWidth":756,"windowHeight":2024,"containerWidth":726,"containerHeight":1409},"764":{"windowWidth":764,"windowHeight":2024,"containerWidth":734,"containerHeight":1409},"770":{"windowWidth":770,"windowHeight":2024,"containerWidth":740,"containerHeight":974},"786":{"windowWidth":786,"windowHeight":2024,"containerWidth":756,"containerHeight":974},"806":{"windowWidth":806,"windowHeight":2024,"containerWidth":776,"containerHeight":960},"812":{"windowWidth":812,"windowHeight":2024,"containerWidth":782,"containerHeight":960},"829":{"windowWidth":829,"windowHeight":2024,"containerWidth":799,"containerHeight":946},"830":{"windowWidth":830,"windowHeight":2024,"containerWidth":800,"containerHeight":946},"851":{"windowWidth":851,"windowHeight":2024,"containerWidth":821,"containerHeight":946},"861":{"windowWidth":861,"windowHeight":2024,"containerWidth":831,"containerHeight":946},"869":{"windowWidth":869,"windowHeight":2024,"containerWidth":839,"containerHeight":831},"884":{"windowWidth":884,"windowHeight":2024,"containerWidth":854,"containerHeight":723},"891":{"windowWidth":891,"windowHeight":2024,"containerWidth":861,"containerHeight":723},"896":{"windowWidth":896,"windowHeight":2024,"containerWidth":866,"containerHeight":723},"899":{"windowWidth":899,"windowHeight":2024,"containerWidth":869,"containerHeight":709},"903":{"windowWidth":903,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"905":{"windowWidth":905,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"906":{"windowWidth":906,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"907":{"windowWidth":907,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"909":{"windowWidth":909,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"911":{"windowWidth":911,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"913":{"windowWidth":913,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"914":{"windowWidth":914,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"915":{"windowWidth":915,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"916":{"windowWidth":916,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"918":{"windowWidth":918,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"920":{"windowWidth":920,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"922":{"windowWidth":922,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"923":{"windowWidth":923,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"924":{"windowWidth":924,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"926":{"windowWidth":926,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"929":{"windowWidth":929,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"930":{"windowWidth":930,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"931":{"windowWidth":931,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"932":{"windowWidth":932,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"933":{"windowWidth":933,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"934":{"windowWidth":934,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"935":{"windowWidth":935,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"936":{"windowWidth":936,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"939":{"windowWidth":939,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"941":{"windowWidth":941,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"942":{"windowWidth":942,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"943":{"windowWidth":943,"windowHeight":2024,"containerWidth":870,"containerHeight":709},"949":{"windowWidth":949,"windowHeight":2024,"containerWidth":870,"containerHeight":709}};


  /**
   * Finds the trade in valet iframe size data that is closest to the window size
   * @param {number} width the width to check against
   * @param {Object} sizeIndex the map of window sizes to their corresponding iframe data
   */
  var findSize = function(width, sizeIndex) {
    if (sizeIndex[width]) { // if data exists for width
      return sizeIndex[width];
    } else if (width > 943) { // if the width is greater than the widest width that there is data for
      return sizeIndex[943];
    } else if (width < 157) { // if the width is less than the widest width that there is data for
      return sizeIndex[157];
    } else { // the width isn't in the data set. So find the closest one above it
      for (var i = width; i > 157; i++) {
        if (sizeIndex[i]) {
          return sizeIndex[i];
        }
      }
    }
  };

  var isMobile = doCssCalc(window.innerWidth) < 738; // find out if it is mobile
  var extraWidth = isSubmitPage(); // submit page has 25px more to account for

  if (isMobile) {
    /*
     * Trade In Valet is dumb and can't figure out how to make a consistent url structure so I have to make this stupid ...
     * ternary to check if the dealer id is the generic one because the url structure is difrerent for one specific id.
     * I wish I could express my anger adequeately in this comment, but, alas, I don't think I will be able to properly
     * convey it through this medium. Please refer to this gif to see how I looked writing this fix.
     * https://media3.giphy.com/media/9rv3RJwRmXWkISOUQc/giphy-downsized.gif
     */
    var link = [809, 1102].indexOf(dealerId * 1) > -1 ?
      'https://mobile.tradeinvalet.com/TradeInValet/LandingPage?SalesStaffId=0&IsFirsTime=True&DealerId='+dealerId :
      'https://mobile.tradeinvalet.com/TradeInValet/KSL/LandingPage/' + dealerId + '?SalesStaffId=0&IsFirsTime=True';
    tradeInValetIframe.attr('src', link);
  } else {
    /*
     * Same as above, but somehow more angry.
     * Even worse: https://dealer.tradeinvalet.com/TradeInVallet/TradeInValet?EncryptDealerId=oCI8LcKCrdRcPnJ4s1wOow==
     */
    
    var skipLandingLink = dealerId == 809 ? 
    "https://dealer.tradeinvalet.com/TradeInVallet/TradeInValet?EncryptDealerId=oCI8LcKCrdRcPnJ4s1wOow==" : 
    "https://Dealer.TradeinValet.com/TradeInValet/Index?id=" + dealerId;

    var link = [809, 1102].indexOf(dealerId * 1) > -1 ? 
       skipLandingLink :
      'https://Dealer.tradeinvalet.com/TradeInValet/KSL/Index?id='+dealerId;
    tradeInValetIframe.attr('src', link);
  }

  $(window).on('resize', function() {
    var windowWidth = this.innerWidth;
    var width = doCssCalc(windowWidth);
    var size = findSize(width, sizeIndex); // find the size data
    if (width < 738 && isMobile || width >= 738 && !isMobile) { // check whether it should resize or not
      tradeInValetIframe.width(size.windowWidth - 10 - extraWidth); // set the width
      tradeInValetIframe.height(size.containerHeight + 22); // set the height plus some additional space to prevent scroll bars
    }
  }).trigger('resize'); // trigger the resize event
});
