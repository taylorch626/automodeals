lpTag.callback({"taglets":[{"name":"caoServiceMap","code":"window.lpTag = window.lpTag || {};\nlpTag.taglets = lpTag.taglets || {};\nlpTag.caoServiceMap = lpTag.caoServiceMap || {};\n\nlpTag.taglets.caoServiceMap = lpTag.taglets.caoServiceMap || function () {\n\tvar name = \"caoServiceMap\",\n\t\tv = \"\",\n\t\t_currentEnvironment = \"us\",\n\t\tcaoServiceMap = lpTag.caoServiceMap,\n\t\tenvServiceDomains,\n\t\tmapping = {};\n\t\t\n\tfunction init() {\n\t\tif(lpTag.env) {\n\t\t\t_currentEnvironment = lpTag.env;\n\t\t}\n\t\t\n\t\tenvServiceDomains = new lpTag.caoServiceMap.envServiceDomains();\n\t\tsetDomains(envServiceDomains.envServiceMap);\n\t}\n\t\n\tfunction setEnvironment(environment) {\n\t\t_currentEnvironment = environment;\n\t}\n\t\n\tfunction setDomain(environment, service, domain) {\n\t\tmapping[environment][service] = domain;\n\t}\n\t\n\tfunction setDomains(serviceMap) {\n\t\tvar i, j, envMap;\n\t\tfor(i = 0; i < serviceMap.length; i++) {\n\t\t\tenvMap = serviceMap[i];\n\t\t\tmapping[envMap.env] = {};\n\t\t\tfor(j = 0; j < serviceMap[i].services.length; j++) {\n\t\t\t\tmapping[envMap.env][envMap.services[j].name] = envMap.services[j].domain;\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction getDomain(service) {\n\t\treturn mapping[_currentEnvironment][service];\n\t}\n\t\n\tfunction getDomainByEnvironment(environment, service) {\n\t\treturn mapping[environment][service];\n\t}\n\t\n\tfunction getMap() {\n\t\treturn mapping;\n\t}\n\t\n\treturn {\n\t\tv: v,\n\t\tname: name,\n\t\tinit: init,\n\t\tsetDomain: setDomain,\n\t\tsetDomains: setDomains,\n\t\tgetDomain: getDomain,\n        getDomainByEnvironment: getDomainByEnvironment,\n\t\tgetMap: getMap,\n        setEnvironment: setEnvironment\n\t};\n}();\n\n/****************************************************************/\n\n\nwindow.lpTag = window.lpTag || {};\nlpTag.caoServiceMap = lpTag.caoServiceMap || {};\nlpTag.caoServiceMap.envServiceDomains = lpTag.caoServiceMap.envServiceDomains || function (serviceMap) {\n\t\n\tvar envServiceMap = serviceMap || [\n\t\t{\n\t\t\t\"env\": \"dev\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"tag.caodev.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"localhost.caodev.net/ContactAtOnce\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"localhost.caodev.net/MTC\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"ci-vehicle-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"ci-ogs.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"tag.caodev.net\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"tag.caodev.net\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"qa.cobrowse.dev.lprnd.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"localhost.caodev.net/AgentPresence\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"qa-portal.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"localhost:59311\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"ci-event-api.contactatonce.com\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"qa\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"qa-tag.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"qa-chat.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"qa-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"qa-vehicle-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"qa-ogs.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"qa-tag.contactatonce.com\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"qa-tag.contactatonce.com\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"qa.cobrowse.dev.lprnd.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"qa-agentpresence.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"qa-portal.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"qa-cdapi.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"qa-event-api.contactatonce.com\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"ci\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"ci-tag.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"ci-chat.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"ci-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"ci-vehicle-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"ci-ogs.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"ci-tag.contactatonce.com\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"ci-tag.contactatonce.com\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"ctvr-hap01.dev.lprnd.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"ci-agentpresence.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"qa-portal.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"qa-cdapi.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"qa-event-api.contactatonce.com\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"itest\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"itest-tag.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"itest-chat.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"itest-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"itest-vehicle-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"itest-ogs.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"itest-tag.contactatonce.com\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"itest-tag.contactatonce.com\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"va.cobrowse.liveperson.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"itest-agentpresence.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"itestportal.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"itest-cdapi.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"itest-event-api.contactatonce.com\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"staging\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"stg-tag.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"stg-chat.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"stg-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"stg-vehicle-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"stg-ogs.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"stg-tag.contactatonce.com\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"stg-tag.contactatonce.com\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"va.cobrowse.liveperson.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"stg-agentpresence.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"stg-portal.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"stg-cdapi.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"stg-event-api.contactatonce.com\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"us\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"tag.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"chat.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"vehicle-api.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"ogs.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"tag.contactatonce.com\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"tag.contactatonce.com\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"va.cobrowse.liveperson.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"agentpresence.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"portal.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"cdapi.contactatonce.com\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"event-api.contactatonce.com\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"uk\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"tag.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"chat.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"api.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"vehicle-api.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"ogs.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"tag.contactatonce.co.uk\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"tag.contactatonce.co.uk\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"lo.cobrowse.liveperson.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"agentpresence.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"portal.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"cdapi.contactatonce.co.uk\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"event-api.contactatonce.co.uk\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"env\": \"au\",\n\t\t\t\"services\": [\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"contentCDN\",\n\t\t\t\t\t\"domain\": \"tag.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"chatAPI\",\n\t\t\t\t\t\"domain\": \"chat.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"mtcAPI\",\n\t\t\t\t\t\"domain\": \"api.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"vehicleAPI\",\n\t\t\t\t\t\"domain\": \"vehicle-api.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"ogsAPI\",\n\t\t\t\t\t\"domain\": \"ogs.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\t\n\t\t\t\t\t\"name\": \"tagDomain\",\n\t\t\t\t\t\"domain\": \"tag.contactatonce.com.au\"\n\t\t\t\t},\n                {\n                    \"name\": \"configurationCDN\",\n                    \"domain\": \"tag.contactatonce.com.au\"\n                },\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"coBrowse\",\n\t\t\t\t\t\"domain\": \"sy.cobrowse.liveperson.net\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"presence\",\n\t\t\t\t\t\"domain\": \"agentpresence.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"portal\",\n\t\t\t\t\t\"domain\": \"portal.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"consumerDataAPI\",\n\t\t\t\t\t\"domain\": \"cdapi.contactatonce.com.au\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"name\": \"eventAPI\",\n\t\t\t\t\t\"domain\": \"event-api.contactatonce.com.au\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t];\n\t\n\treturn {\n\t\tenvServiceMap: envServiceMap\n\t};\n};\n","parameters":null},{"name":"eventAPI","code":"/**\r\n * eventAPI.js (CAO-eventAPI.js)\r\n * This is a JavaScript taglet for interfacing with the Contact At Once Event API\r\n * \r\n * @author Kelvin\r\n * @depend lpTag.log\r\n * @depend lpTag.taglets.caoServiceMap\r\n*/\r\n\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\nwindow.lpTag.taglets.eventAPI = (function () {\r\n    var version = '1.0';\r\n    var name = 'eventAPI';\r\n    var eventTypes = {\r\n        OVERLAY_ENGAGEMENT_PRESENCE_CHECKED: 0,\r\n        EMBEDDED_ENGAGEMENT_PRESENCE_CHECKED: 1,\r\n        OVERLAY_ENGAGEMENT_SHOWN: 2,\r\n        ONLINE_EMBEDDED_ENGAGEMENT_SHOWN: 3,\r\n        OFFLINE_EMBEDDED_ENGAGEMENT_SHOWN: 4,\r\n        CHAT_ENGAGEMENT_CLICKED: 5,\r\n        TEXT_ENGAGEMENT_CLICKED: 6,\r\n        LOCATION_SELECTOR_SHOWN: 7,\r\n        LOCATION_SELECTED: 8,\r\n        DEPARTMENT_SELECTOR_SHOWN: 9,\r\n        DEPARTMENT_SELECTED: 10\r\n    };\r\n\r\n    var _eventApiUrl;\r\n\r\n    function init(configuration) {\r\n        var protocol = typeof lpTag.protocol === 'undefined' ? location.protocol : lpTag.protocol;\r\n        _eventApiUrl = protocol + '//' + lpTag.taglets.caoServiceMap.getDomain('eventAPI') + '/api/preconversationevent';\r\n    }\r\n\t\r\n\tfunction start() {\r\n    }\r\n\r\n    function sendAnalyticEvent(providerId, sessionId, engagementId, type) {\r\n        try {\r\n            var payload = [{ \r\n                providerId: providerId, \r\n                sessionId: sessionId,\r\n                engagementId: engagementId,\r\n                type: type,\r\n                timeStamp: JSON.parse(JSON.stringify(new Date()))\r\n            }];\r\n            _tryToSendAnalyticEvent(payload);\r\n        } catch (error) {\r\n            _log('Error occured while sending analytic event: ' + error.message, 'ERROR');\r\n        }\r\n\t}\r\n\r\n\tfunction _tryToSendAnalyticEvent(payload, attemptNumber) {\r\n\t\tattemptNumber = attemptNumber || 1;\r\n\t\tvar request = new XMLHttpRequest();\r\n\t\trequest.onreadystatechange = function() {\r\n\t\t\tif (this.readyState == 4) {\r\n\t\t\t\tif (this.status >= 200 && this.status <= 299) {\r\n                    _log('Analytic event sent: ' + JSON.stringify(payload), 'DEBUG');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (attemptNumber < 3) {\r\n                        _log('Analytic event failed to send. Trying again in one second (attempt ' + (attemptNumber + 1) + '): ' + JSON.stringify(payload), 'ERROR');\r\n\t\t\t\t\t\tsetTimeout(function() { _tryToSendAnalyticEvent(payload, ++attemptNumber); }, 1000);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t\trequest.open(\"POST\", _eventApiUrl);\r\n\t\trequest.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\r\n\t\trequest.send(JSON.stringify(payload));\r\n\t}\r\n\r\n    function _log(message, type) {\r\n        if (window.lpTag && window.lpTag.log) {\r\n            window.lpTag.log(message, type, name);\r\n        }\r\n    }\r\n\r\n    return {\r\n        v: version,\r\n        name: name,\r\n        eventTypes: eventTypes,\r\n        init: init,\r\n        start: start,\r\n        sendAnalyticEvent: sendAnalyticEvent,\r\n        includes: [\r\n            { name: \"caoServiceMap\" }\r\n        ]\r\n    };\r\n\r\n})();\r\n","parameters":null},{"name":"lpUnifiedWindow","code":"window.lpTag=window.lpTag||{};lpTag.taglets=lpTag.taglets||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.taglets.lpUtil=lpTag.taglets.lpUtil||function(){function indexOf(a,b){if(\"function\"==typeof[].indexOf&&\"function\"==typeof a.indexOf)return a.indexOf(b);if(a.constructor===Array)for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1}function trim(a){return\"string\"!=typeof a?a:a.trim?a.trim():a.replace(/^\\s+|\\s+$/gm,\"\")}function trimAndLower(a){return\"string\"!=typeof a?a:trim(a).toLowerCase()}function getURLParams(a){var b,c,d={};b=a.substr(1).split(\"&\");for(var e=0;e<b.length;e++)if(b[e].indexOf(\"=\")>-0){c=b[e].split(\"=\");2==c.length&&(d[decodeURIComponent(c[0])]=decodeURIComponent(c[1]))}return d}function addQueryParams(a,b){if(\"string\"==typeof a&&a.length>0){if(Array.isArray(b))return _addQueryParamsFromArray(a,b);if(_isValidKeyValueInput(b))return _addQueryParam(a,b)}return a}function _addQueryParamsFromArray(a,b){for(var c,d=a,e=0;e<b.length;e++){c=b[e];if(!d||\"object\"!=typeof c)break;d=_addQueryParam(d,c)}return d}function _addQueryParam(a,b){var c,d,e=/(\\?|&|\\/|\\\\)$/;if(!_isValidInput(a,b))return a;e.test(a)&&(a=a.substr(0,a.length-1));c=new RegExp(\"([?&])\"+b.key+\"=.*?(&|$)\",\"ig\");d=-1===a.indexOf(\"?\")?\"?\":\"&\";return a.match(c)?a.replace(c,\"$1\"+b.key+\"=\"+b.value+\"$2\"):a+d+b.key+\"=\"+b.value}function _isValidInput(a,b){return\"string\"==typeof a&&a.length>0&&_isValidKeyValueInput(b)}function _isValidKeyValueInput(a){var b=a&&a.key,c=a&&a.value;return a&&\"string\"==typeof b&&b.length>0&&(\"number\"==typeof c||\"string\"==typeof c&&c.length>0)}function cloneExtend(a,b,c){var d;if(!a||\"object\"!=typeof a)return a;if(!b)return clone(a);d=b||a.constructor()||{};for(var e in a)d[e]!==a[e]&&a.hasOwnProperty(e)&&(d[e]=c?cloneExtend(a[e],void 0,c):a[e]);return d}function clone(a){try{return JSON.parse(stringify(a))}catch(a){lpTag.log(\"unable to clone object:\"+JSON.stringify(a),\"ERROR\",name);return}}function convertConfig(conf,_config){if(void 0!==_config){if(conf)for(var i=0;i<conf.length;i++){var val=conf[i].value;if(\"string\"==typeof val&&\"\"!==val)if(\"true\"===val)val=!0;else if(\"false\"===val)val=!1;else if(\"[\"==val.charAt(0)||\"{\"==val.charAt(0))try{val=\"undefined\"!=typeof JSON&&JSON.parse?JSON.parse(val):eval(\"(\"+val+\")\")}catch(a){lpTag.log(\"unable to parse JSON:\"+JSON.stringify(a),\"ERROR\",name)}_config[conf[i].id]=val}}else lpTag.log(\"_config is passed as undefined\",\"ERROR\",name)}function addStyleTag(a,b){if(a&&\"string\"==typeof a){b=b||{};var c,d=b.document||window.document,e=b.id;if(void 0!==e){c=d.getElementById(e)||d.createElement(\"style\");c.id=e}else c=d.createElement(\"style\");c.type=\"text/css\";d.getElementsByTagName(\"head\")[0].appendChild(c);c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a));return c}}function objectKeys(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=c);return b}function waitForBody(a,b){function c(){e.body?runCallback(a,d):setTimeout(c,50)}b=b||{};var d=b.context,e=b.document||window.document;c()}function stringify(a){var b,c;if(\"function\"==typeof Array.prototype.toJSON){c=Array.prototype.toJSON;delete Array.prototype.toJSON;try{b=JSON.stringify(a)}catch(a){Array.prototype.toJSON=c;throw a}Array.prototype.toJSON=c}else b=JSON.stringify(a);return b}function getUID(){return\"tttttttt-tttt-4ttt-fttt-t7ttttttttttt\".replace(/[tf]/g,function(a){var b=16*Math.random()|0;return(\"t\"==a?b:3&b|8).toString(16)})+\"-\"+Math.floor(1e5*Math.random())}function runCallback(a,b){b=b||window;if(\"function\"==typeof a){var c=Array.prototype.slice.call(arguments,2);try{return a.apply(b,c)}catch(a){lpTag.log(\"Failed to execute callback exc= \"+a.message,\"ERROR\",name)}}}function registerEvent(a,b,c){a&&b&&c&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent(\"on\"+b,c))}function unregisterEvent(a,b,c){a&&b&&c&&(a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent(\"on\"+b,c))}function buildClassString(a,b,c){var d,e;a=\"string\"==typeof a?a:\"\";d=a.split(\" \");e=b&&b.constructor===Array?b:\"string\"==typeof b?[b]:[];c=c&&c.constructor===Array?c:\"string\"==typeof c?[c]:[];for(var f=0;f<d.length;f++)indexOf(c,d[f])<0&&indexOf(e,d[f])<0&&e.push(d[f]);return e.join(\" \").replace(/$\\s/gi,\"\")}function isEmpty(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function getPropertyFromObject(a,b,c){var d,e=a;if(\"string\"==typeof b){d=b.split(\".\");for(var f=0;f<d.length;f++){if(void 0===e||null===e||void 0===e[d[f]]||null===e[d[f]]){e=void 0!==c?c:void 0;break}e=e[d[f]]}}else lpTag.log(\"Empty path sent to lookup getPropertyFromObject\",\"DEBUG\",\"utils\");return e}function addClass(a,b){if(a.className.indexOf(b)<0){a.className=[a.className,b].join(\" \");a.className=_removeSpaces(a.className)}}function removeClass(a,b){a.className=a.className.replace(new RegExp(b,\"g\"),\"\");a.className=_removeSpaces(a.className)}function _removeSpaces(a){return trim(a.replace(/\\s\\s*/g,\" \"))}function mapString(a,b,c){var d={};if(a&&\"string\"==typeof a){c&&(a=decodeURIComponent(a));for(var e,f=a.split(b),g=0;g<f.length;g++){e=f[g].split(\"=\");d[e[0]]=e[1]}}return d}var name=\"Utils\",cookieActions={delimiter:\"|\",set:function(a,b,c,d,e){if(\"string\"==typeof a&&b.join&&\"function\"==typeof b.join){var f=encodeURIComponent(a)+\"=\"+encodeURIComponent(b.join(this.delimiter))+\";path=/\";void 0!==c&&(f+=\";domain=\"+c);void 0!==d&&(f+=\";samesite=\"+d);e&&(f+=\";secure\");document.cookie=f;return!0}},get:function(a){if(\"string\"==typeof a){var b=document.cookie.replace(new RegExp(\"(?:(?:^|.*;)\\\\s*\"+encodeURIComponent(a).replace(/[\\-\\.\\+\\*]/g,\"\\\\$&\")+\"\\\\s*\\\\=\\\\s*([^;]*).*$)|^.*$\"),\"$1\")||null;if(\"string\"==typeof b){var c=decodeURIComponent(b);if(c)return c.split(this.delimiter)}}},remove:function(a,b){if(\"string\"==typeof a){this.set(a,[\"null\"],b);return!0}}};return{indexOf:indexOf,trim:trim,trimAndLower:trimAndLower,getURLParams:getURLParams,addQueryParams:addQueryParams,cloneExtend:cloneExtend,clone:clone,convertConfig:convertConfig,addStyleTag:addStyleTag,objectKeys:objectKeys,waitForBody:waitForBody,stringify:stringify,cookieActions:cookieActions,getUID:getUID,runCallback:runCallback,registerEvent:registerEvent,unregisterEvent:unregisterEvent,buildClassString:buildClassString,isEmpty:isEmpty,getPropertyFromObject:getPropertyFromObject,addClass:addClass,removeClass:removeClass,mapString:mapString}}();window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.AppConfigurationManager=lpTag.unifiedWindow.AppConfigurationManager||function(a){function b(a,b,c){return l(d(a,b,!1,c),a,b)}function c(a,b,c){return l(d(a,b,c),a,b)}function d(a,b,c,d){var e={accountId:b.accountId,env:b.env,providerId:b.providerId,referenceId:b.referenceId,departmentRef:b.departmentRef,consumerId:b.consumerId,channel:a.channel,sessionId:a.sessionId};b.pcgTrackingId&&(e.pcgTrackingId=b.pcgTrackingId);b.merkleChatInfo&&(e.merkleChatInfo=b.merkleChatInfo);if(b.tealiumChatInfo){e.tealiumChatInfo=b.tealiumChatInfo;e.tealiumEnvironment=b.tealiumEnvironment}b.googleAwId&&(e.googleAwId=b.googleAwId);b.visualIQImageUrl&&(e.visualIQImageUrl=b.visualIQImageUrl);b.pixallChatInfo&&(e.pixallChatInfo=b.pixallChatInfo);b.zmotEnvironment&&(e.zmotEnvironment=b.zmotEnvironment);if(b.gaAgentAccepted||b.gaAgentSent||b.gaConsumerSent||b.gaClientId){e.gaAgentSent=b.gaAgentSent;e.gaConsumerSent=b.gaConsumerSent;e.gaAgentAccepted=b.gaAgentAccepted;e.gaClientId=b.gaClientId}if(b.cdkPartnerAccountName){e.cdkPartnerAccountName=b.cdkPartnerAccountName;e.cdkWebId=b.cdkWebId}b.tagServerLocation&&(e.tagServerLocation=b.tagServerLocation);c?j(e,a,b):k(e,a,b,d);return e}function e(a){return a.connector&&0===a.connector.type}function f(){return void 0!==t.taglets.lpUnifiedWindowRecaptcha}function g(){s=a.utils;t=a.lpTag}function h(a){var b=document.createElement(\"a\");b.href=a;return{search:b.search,port:b.port,protocol:b.protocol,hostname:b.hostname,pathname:i(b.pathname)}}function i(a){return 0===a.indexOf(\"/\")?a:\"/\"+a}function j(a,b,c){a.poppedOut=!0;a.sessionId=c.sessionId;a.supportBlockCCPattern=c.supportBlockCCPattern;a.engConf={lewid:b.lewid};c.widgetSDK&&(a.widgetSDK=a.widgetSDK||c.widgetSDK);c.hide_lp_logo&&(a.hide_lp_logo=c.hide_lp_logo);var d=s.getURLParams(location.search);d&&d.lpDebug&&(a.lpDebug=d.lpDebug)}function k(a,b,c,d){a.external=!0;a.sessionId=c.sessionId;a.chatSessionTimeout=c.chatSessionTimeout;a.supportBlockCCPattern=c.supportBlockCCPattern;a.secureStorageType=c.secureStorageType;a.vars=c.vars;a.caoOriginationUrl=c.caoOriginationUrl;a.caoTitle=c.caoTitle;a.engConf={async:b.async,scid:b.scid,cid:b.cid,eid:b.eid,language:b.language,svid:b.svid,ssid:c.sessionId,lewid:b.lewid,connector:b.connector,referenceId:b.referenceId,departmentRef:b.departmentRef,departmentSelector:b.departmentSelector,disableLocationSelector:b.disableLocationSelector,channel:b.channel,origination:b.origination,sessionId:b.sessionId};b.isOffline&&(a.engConf.isOffline=!0);f()&&(a.useRecaptcha=!0);c.sessionTimeout&&(a.sessionTimeout=c.sessionTimeout);c.displayShortlyMessage&&(a.displayShortlyMessage=c.displayShortlyMessage);c.widgetSDK&&(a.widgetSDK=c.widgetSDK);c.hide_lp_logo&&(a.hide_lp_logo=c.hide_lp_logo);e(b)&&(a.engConf.authConnId=b.connector.id);b.skill&&(a.engConf.skill=b.skill);b.preChatLines&&(a.engConf.preChatLines=q(b.preChatLines));a.engConf.connector&&a.engConf.connector.configuration&&delete a.engConf.connector.configuration.jwtPublicKey;var g=s.getURLParams(location.search);g&&g.lpDebug&&(a.lpDebug=g.lpDebug);if(d){a.smsClientLaunch=!0;a.smsConf={mtcAPI:d.mtcAPI};a.smsConf.launchProperties={phoneNumber:d.launchProperties.phoneNumber,message:d.launchProperties.message};a.resource=\"/taptotext.html\"}else a.resource=\"/index.html\"}function l(a,b,c){var d=\"\";b.connector?b.connector.type===u?d=n(a,b,c):b.connector.type!==v&&b.connector.type!==w||(d=m(a,b,c)):d=o(a,c);return d}function m(a,b,c){b.connector=b.connector||{};if(p(b.connector)){var d=1===b.connector.type?\"token\":\"code\";return s.addQueryParams(b.connector.configuration.authorizationEndpoint,[{key:\"client_id\",value:b.connector.configuration.clientId},{key:\"response_type\",value:d},{key:\"redirect_uri\",value:o(a,c,!0)}])}a.invalidAuthConnector=!0;return o(a,c)}function n(a,b,c){var d=b.connector.configuration.genKeyUrl,e=h(d);e.search=s.addQueryParams(e.search,[{key:\"rt\",value:\"redir\"},{key:\"redirect\",value:encodeURIComponent(c.codeRepository+a.resource)},{key:\"lpUnifiedWindowConfig\",value:encodeURIComponent(s.stringify(a))}]);return e.protocol+\"//\"+e.hostname+(e.port?\":\"+e.port:\"\")+e.pathname+e.search}function o(a,b,c){var d=h(b.codeRepository+a.resource),e=d.protocol+\"//\"+d.hostname+(d.port?\":\"+d.port:\"\")+d.pathname+\"?lpUnifiedWindowConfig=\";return(c?encodeURIComponent(e):e)+encodeURIComponent(s.stringify(a))}function p(a){a.configuration=a.configuration||{};return a.configuration.authorizationEndpoint&&a.type}function q(a){var b={},c=0;for(var d in a){b[d]=a[d];if(c>=1500)break;c+=d.length+a[d].length}return b}function r(a){var b;t.features&&\"function\"==typeof t.features.getFeature&&(b=t.features.getFeature(a));return b}var s,t,u=0,v=1,w=2;g(a);return{createExternalConfiguration:d,isRecaptchaEnabled:f,isAuthenticatedEnabled:e,getExternalResourceURL:c,getSMSClientLaunchResourceURL:b,getFeatureById:r}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.BrowserStateManager=function(a){function b(a){w=\"boolean\"==typeof navigator.onLine;x=!w||navigator.onLine;E=a;z=i();y=window.innerWidth;F=q();var b=p();A=b.hiddenAttr;B=b.visibilityChange;l()}function c(a,b,c){J[a]=J[a]||[];J[a].push({callback:b,context:c})}function d(a,b){v(a,b)}function e(){w&&(x=navigator.onLine);return x}function f(){return!!A}function g(){return K}function h(){return document[A]}function i(){var a;if(void 0!==window.orientation){var b=window.orientation;a=90===b||-90===b}else a=window.innerWidth>window.screen.availHeight;return a}function j(){for(var a in J){J[a]&&J[a].constructor===Array&&(J[a].length=0);J[a]=null;delete J[a]}}function k(){j();F&&L.unregisterEvent(window,F,r);L.unregisterEvent(window,\"resize\",t);L.unregisterEvent(window,\"focus\",m);L.unregisterEvent(window,\"blur\",o)}function l(){F&&L.registerEvent(window,F,r);L.registerEvent(window,\"resize\",t);L.registerEvent(window,\"focus\",m);L.registerEvent(window,\"blur\",o);L.registerEvent(document,B,n)}function m(){K=!0;if(void 0!==J[I.FOCUS_CHANGE])for(var a=0;a<J[I.FOCUS_CHANGE].length;a++)L.runCallback(J[I.FOCUS_CHANGE][a].callback,J[I.FOCUS_CHANGE][a].context,{focus:K});G.info(\"_onFocus: trigger window focus event\",H)}function n(){if(void 0!==J[I.VISIBILITY_CHANGE])for(var a=0;a<J[I.VISIBILITY_CHANGE].length;a++)L.runCallback(J[I.VISIBILITY_CHANGE][a].callback,J[I.VISIBILITY_CHANGE][a].context,{visible:!document[A]});G.info(\"_onVisibilityChange: trigger visibility change event\",H)}function o(){K=!1;if(void 0!==J[I.FOCUS_CHANGE])for(var a=0;a<J[I.FOCUS_CHANGE].length;a++)L.runCallback(J[I.FOCUS_CHANGE][a].callback,J[I.FOCUS_CHANGE][a].context,{focus:K});G.info(\"_onBlur: trigger window blur event\",H)}function p(){var a,b;if(void 0!==document.webkitHidden){a=\"webkitHidden\";b=\"webkitvisibilitychange\"}else if(void 0!==document.mozHidden){a=\"mozHidden\";b=\"mozvisibilitychange\"}else if(void 0!==document.msHidden){a=\"msHidden\";b=\"msvisibilitychange\"}else if(void 0!==document.hidden){a=\"hidden\";b=\"visibilitychange\"}return{hiddenAttr:a,visibilityChange:b}}function q(){return E.isAndroid()||E.isIOS()?\"orientationchange\":\"resize\"}function r(a){D&&clearTimeout(D);var b=300;E.isAndroid()&&(b=y===window.innerWidth?900:400);D=setTimeout(s,b)}function s(){var a,b,c;a=i();b=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0;c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0;if(a!==z&&void 0!==J[I.ORIENTATION_CHANGE]){for(var d=0;d<J[I.ORIENTATION_CHANGE].length;d++){L.runCallback(J[I.ORIENTATION_CHANGE][d].callback,J[I.ORIENTATION_CHANGE][d].context,{landscape:a,height:c,width:b});z=a}G.info(\"_triggerOrientationChange: trigger orientation changed event. landscape: \"+z,H)}y=window.innerWidth}function t(){C?clearTimeout(C):u();C=setTimeout(function(){var a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0,b=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0,c={height:b,width:a};if(void 0!==J[I.RESIZE])for(var d=0;d<J[I.RESIZE].length;d++)L.runCallback(J[I.RESIZE][d].callback,J[I.RESIZE][d].context,c);C=null},300)}function u(){if(void 0!==J[I.RESIZE_START])for(var a=0;a<J[I.RESIZE_START].length;a++)L.runCallback(J[I.RESIZE_START][a].callback,J[I.RESIZE_START][a].context)}function v(a,b){var c=J[a];if(c){for(var d=[],e=0;e<c.length;e++)c[e].callback!==b&&d.push(c[e]);c.length=0;J[a]=d}}var w,x,y,z,A,B,C,D,E,F,G=lpTag.unifiedWindow.log,H=\"BrowserStateManager\",I={RESIZE_START:\"resizeStart\",ORIENTATION_CHANGE:\"orientationChange\",RESIZE:\"resize\",FOCUS_CHANGE:\"focusChange\",VISIBILITY_CHANGE:\"visibilityChange\"},J={},K=!0,L=lpTag.taglets.lpUtil;b(a);return{EVENT_NAME:I,on:c,off:d,visibilitySupported:f,isConnected:e,isHidden:h,isFocus:g,isLandscape:i,unregisterAllEvents:j,dispose:k}};window.lpTag=window.lpTag||{};lpTag.taglets=lpTag.taglets||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.DeviceDetector=function(){function a(){return U===Q.familyEnum.desktop}function b(){return U===Q.familyEnum.mobile}function c(){return U===Q.familyEnum.tablet}function d(){return T===Q.osEnum.iOS}function e(){return Q.browser()===Q.browserEnum.chromeios}function f(){return Q.browser()===Q.browserEnum.safari}function g(){return T===Q.osEnum.android}function h(){return g()&&!R.match(/Chrome/)}function i(){return X}function j(){return I}function k(){return J}function l(){return L}function m(){if(\"boolean\"==typeof M)return M;var a=!0;try{new Audio}catch(b){a=!1}return a}function n(){return K}function o(){return V}function p(){return W}function q(){if(d())return V[1]<=\"7\"||!1}function r(){if(d())return V[1]<=\"6\"||!1}function s(){if(d())return!isNaN(V[1])&&parseInt(V[1],10)>=8}function t(){if(d())return!isNaN(V[1])&&(parseInt(V[1],10)>11||11==parseInt(V[1],10)&&parseInt(V[2],10)>=3)}function u(){return T===Q.osEnum.windows}function v(){return T===Q.osEnum.mac}function w(){return\"Microsoft Internet Explorer\"===S||x()}function x(){return R.match(/Trident.*rv[ :]*11\\./)}function y(){return\"Tablet\"===Q.familyName()?\"Desktop\":Q.familyName()}function z(){return b()&&!c()&&!w()}function A(){var a=document.createElement(\"DIV\");E(a);F(a);a=null}function B(){var a;g()?a=R.match(/Android (\\d+)\\.(\\d+)(?:\\.(\\d+))?;+/i):d()&&(a=R.match(/OS (\\d+)_(\\d+)(?:_(\\d+))?\\s+/i));return a}function C(){var a;if(w())if(x())a=11;else{var b=new RegExp(\"MSIE ([0-9]{1,}[.0-9]{0,})\");try{null!=b.exec(R)&&(a=parseFloat(RegExp.$1))}catch(a){O.error(\"_detectBrowserVersion: Could not detect IE version\",N)}}return a}function D(){var a=document.getElementsByName(\"viewport\");if(a.length>0)for(var b=0;b<a.length;b++){var c=H(a[b].content);if(\"device-width\"===c.width)return!0}return!1}function E(a){J=G(a,\"AnimationName\");J.supported&&(I=!0)}function F(a){K=G(a,\"Transition\");K.supported&&(L=!0)}function G(a,b){var c,d={Webkit:\"-webkit-\",Moz:\"-moz-\",O:\"-o-\",ms:\"-ms-\",Khtml:\"-khtml-\"},e=!1,f=b?b.substring(0,1).toLowerCase()+b.substr(1):\"\",g=f,h=b;if(f&&void 0!==a.style[f]){e=!0;c=\"\"}if(!e)for(var i in d)if(b&&d.hasOwnProperty(i)&&void 0!==a.style[i+b]){c=d[i];g=c+f;h=i+b;e=!0;break}return{supported:e,preFix:e?c:\"\",propertyName:e?h:\"\",cssPropertyName:e?g:\"\"}}function H(a){for(var b,c=a.split(\",\"),d={},e=0;e<c.length;e++){b=c[e].split(\"=\");d[P.trimAndLower(b[0])]=P.trimAndLower(b[1])}return d}var I,J,K,L,M,N=\"DeviceDetector\",O=lpTag.unifiedWindow.log,P=lpTag.taglets.lpUtil,Q=lpTag.device,R=navigator.userAgent,S=navigator.appName,T=Q.os(),U=Q.family(),V=B(),W=C(),X=D();A();return{isDesktop:a,isMobile:b,isTablet:c,isMobileOptimized:i,isAnimationSupported:j,getAnimationData:k,isTransitionSupported:l,isAudioSupported:m,getTransitionData:n,isAndroid:g,isNativeAndroid:h,isIOS:d,isChromeIOS:e,isSafari:f,isWindows:u,isMacOS:v,getDeviceFamilyName:y,osVersion:o,browserVersion:p,isIOS6:r,isIOS7:q,isIOS8OrAbove:s,isIOS113OrAbove:t,isIE:w,canAttemptSMSClientLaunch:z}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.Events=function(a){function b(a){g=new lpTag.Events(a);h=g.trigger;g.trigger=c;i=lpTag.taglets.lpUtil}function c(a,b,c){h(a,b,c);d(a)}function d(a){var b,c,d;j||(j=i.getPropertyFromObject(lpTag,\"unifiedWindow.publicEvents\"));a=\"object\"==typeof a?a:null;c=a&&j&&j[a.appName]&&j[a.appName][a.eventName];if(lpTag.events&&a&&(a.global||c)){if(a.global){a.passDataByRef=!1;a.aSync=!0;lpTag.events.trigger(a)}if(c){b=Array.isArray(c)?c:[c];for(var f=0;f<b.length;f++){d=e(a,b[f]);lpTag.events.trigger(d)}}}}function e(a,b){var c=i.clone(b);c.passDataByRef=!1;c.aSync=!0;c.data=f(a,c.data);return c}function f(a,b){var c={};if(\"object\"==typeof b)for(var d in b)c[d]=i.getPropertyFromObject(a,b[d]);else c=i.getPropertyFromObject(a,b);return c}var g,h,i,j;b(a);return g};!function(){function a(){function a(a){return g[f]&&g[f][a]||lpTag.unifiedWindow.defaultDictionary[a]}function b(a){return a&&(a[f]||a[h])}function c(a){return!0===i[a]}function d(a){f=a||h}function e(a,b){b=b||{};g[b.locale]=a;b.locale===h&&lpTag.taglets.lpUtil.cloneExtend(a,lpTag.unifiedWindow.defaultDictionary)}var f,g={},h=\"en-US\",i={\"he-IL\":!0,\"ar-AE\":!0};return{getString:a,getCustomText:b,isRTL:c,add:e,setLocale:d}}window.lpTag=window.lpTag||{};lpTag.unifiedWindow.language=new a;lpTag.unifiedWindow.addLanguage=function(a,b){lpTag.unifiedWindow.language.add(a,b)}}();window.lpTag=window.lpTag||{};lpTag.taglets=lpTag.taglets||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.log=lpTag.unifiedWindow.log||function(){function a(a){i=lpTag.taglets.lpUtil;var c=i.getURLParams(window.location.search),d=c.lpDebug;if(a.debug||\"1\"===d){g(\"DEBUG\");b()}}function b(){window.lpTaglogListeners=window.lpTaglogListeners||[];window.lpTaglogListeners.push(function(a,b,d){window.console&&b&&k[b]<=m&&-1===i.indexOf(l,d)&&console.log(c()+\" \"+d+\" : \"+a+\" LEVEL: \"+b)})}function c(){var a=new Date;return a.getHours()+\":\"+(a.getMinutes()<10?\"0\"+a.getMinutes():a.getMinutes())+\":\"+(a.getSeconds()<10?\"0\"+a.getSeconds():a.getSeconds())}function d(a,b){h(a,\"ERROR\",b||j)}function e(a,b){h(a,\"INFO\",b||j)}function f(a,b){h(a,\"DEBUG\",b||j)}function g(a){k[a]&&(m=k[a])}function h(a,b,c){window.lpTag&&lpTag.log&&a&&lpTag.log(a,b,c||j)}var i,j=\"UnifiedWindowLogger\",k={ERROR:1,INFO:2,DEBUG:3},l=[\"lp_SMT\",\"lp_monitoringSDK\",\"LP_OFFER\"],m=k.ERROR;return{init:a,error:d,info:e,debug:f,setLogLevel:g,logLevels:k}}();window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.apps=lpTag.unifiedWindow.apps||{UNIFIED_WINDOW:\"lpUnifiedWindow\"};lpTag.unifiedWindow.MerchantConfigurationManager=function(a){function b(a){if(\"object\"==typeof a&&a.accountId&&a.secureStorageLocation&&a.domain){k=a.accountId;l=a.secureStorageLocation;m=a.domain;n=a.providerId;o=[]}else r.error(\"init: no configuration given\",p)}function c(a,b,c){r.info(\"getConf\",p);var d=j(b,c);o[d]?s.runCallback(a,null,o[d]):t.getValue({key:d,site:k,app:u,success:g(a,b,c),error:g(a,b,c),appName:q,domain:l})}function d(){for(var a=Object.keys(o),b=0;b<a.length;b++)t.removeValue({key:a[b],site:k,app:u,appName:q,success:i,error:i,domain:l})}function e(a,b,c){r.info(\"_setConf\",p);t.setValue({key:j(b,c),site:k,app:u,value:{conf:a,referenceId:b,departmentRef:c},success:f,error:f,appName:q,domain:l,expires:108e5})}function f(a){r.info(\"_setCallback: data=\"+JSON.stringify(a),p)}function g(a,b,c){return function(d){if(a)if(d){var e=j(b,c);o[e]=d.conf;s.runCallback(a,null,o[e])}else h(a,b,c)}}function h(a,b,c){var d;r.info(\"_getConfiguration\",p);if(n){d=\"https://\"+lpTag.taglets.caoServiceMap.getDomain(\"configurationCDN\")+\"/api/v1.0/configuration/merchant?callback=merchantConfigCallback&providerId=\"+n;b&&(d+=\"&referenceId=\"+b);c&&(d+=\"&departmentRef=\"+c);var f=j(b,c);lpTag.taglets.jsonp.issueCall({callbackName:\"merchantConfigCallback\",url:d,timeout:5e3,retries:0,success:function(d){if(d&&!d.error){r.info(\"_getConfiguration - got configuration: \"+JSON.stringify(d),p);o[f]=d;s.runCallback(a,null,o[f]);e(o[f],b,c)}else{r.info(\"_getConfiguration - NO CONFIGURATION FOUND\",p);s.runCallback(a)}},error:function(){r.info(\"_getConfiguration - ERROR FROM SERVER\",p);s.runCallback(a)}})}else{r.error(\"_getConfiguration: No providerid provided, fallback to default configuration\",p);s.runCallback(a,null,{})}}function i(){}function j(a,b){return a?b?a+\"_\"+b:a:b||null}var k,l,m,n,o,p=\"MerchantConfigurationManager\",q=\"MerchantConf\",r=lpTag.unifiedWindow.log,s=lpTag.taglets.lpUtil,t=lpTag.taglets.lpSecureStorage,u=lpTag.unifiedWindow.apps.UNIFIED_WINDOW;b(a);return{getConf:c,clear:d}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.SessionCookieManager=function(a){function b(a){if(\"object\"==typeof a&&a.accountId&&\"string\"==typeof a.accountId){v=a.getSelectedStorage;D+=a.accountId;x=a.sessionId;w=a.events;y=a.external;u=a.cookieRefreshTimeout||5e3;z=n(a)}else C.error(\"init: no conf was provided\",A)}function c(){C.info(\"getSessionId  - before = \"+x,A);var a,b=B.cookieActions.get(D);C.info(\"_getCookieValue sessionCookie = \"+b,A);b&&(a=b[1]||\"null\");!x&&b&&(x=b[0]);x=j(x,a);C.info(\"getSessionId  - result = \"+x,A);return x}function d(){C.info(\"getSessionTime\",A);var a=B.cookieActions.get(D);C.debug(\"getSessionTime: cookie=\"+JSON.stringify(a));if(a)return a[1]}function e(){return z}function f(){var a;C.info(\"getSessionTime\",A);var b=B.cookieActions.get(D);C.debug(\"getSessionTime: cookie=\"+JSON.stringify(b));b&&b.length>=4&&(a=parseInt(b[3],10));return a}function g(){C.info(\"getSessionCookie\",A);return B.cookieActions.get(D)}function h(){if(!y){C.info(\"refresh\",A);F=!1;c();s()}}function i(a){clearTimeout(t);m();C.info(\"dispose\",A);x=null;F=!0;!0===a||y||B.cookieActions.remove(D,E)}function j(a,b,c){C.info(\"_setSession sessionId=\"+a+\" timestamp=\"+b,A);var d=B.cookieActions.get(D);if(!a||\"null\"===a&&!c){a=B.getUID();C.info(\"_setSession getUID sid=\"+a,A)}else if(a&&d&&a!==d[0]&&c){w.trigger({appName:A,eventName:\"sessionChanged\",data:d[0]});F=!0;return}var e=[a,b||\"null\"],f=k(d);e.push(f||\"null\");e.push(z||\"null\");C.info(\"_setSession setCookie = \"+D+\" cookieValue = \"+e,A);y||B.cookieActions.set(D,e,E,\"lax\");return a}function k(a){var b=a||B.cookieActions.get(D);return v()||b&&b[2]}function l(){w.bind({appName:\"ChatStateManager\",eventName:\"startChatInfo\",func:p})}function m(){w.unbind({appName:\"ChatStateManager\",eventName:\"startChatInfo\",func:p})}function n(a){return y?o()||a.sessionTimeout:a.echoedSessionTimeout||f()||a.sessionTimeout}function o(){var a,b=q();b.CT&&(a=parseInt(b.CT,10));return a}function p(a){if(a.chatTimeout){C.info(\"_updateChatTimeout : echoed chatTimeout = \"+a.chatTimeout,A);z=a.chatTimeout;if(y){var b=q();b.CT=z;window.location.hash=r(b)}}}function q(){return B.mapString(window.location.hash.substring(1),\"&\",!0)}function r(a){var b=[];for(var c in a)b.push(c+\"=\"+a[c]);return encodeURIComponent(b.join(\"&\"))}function s(){C.info(\"_refreshCookie : disposed = \"+F,A);t&&clearTimeout(t);if(!F){var a=(new Date).getTime();C.info(\"Refresh Cookie: timestamp = \"+a,A);j(x,a,!0);t=setTimeout(s,u)}}var t,u,v,w,x,y,z,A=\"SessionManager\",B=lpTag.taglets.lpUtil,C=lpTag.unifiedWindow.log,D=\"LPCKEY-\",E=lpTag.domainUtil.getParentDomain(window.location.host),F=!1;b(a);l();return{dispose:i,refresh:h,getSessionId:c,getSessionTime:d,getSessionSelectedStorage:k,getSessionCookie:g,getSessionTimeout:e}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.SessionManager=function(a){function b(a){if(\"object\"==typeof a&&a.accountId&&a.secureStorageLocation&&\"string\"==typeof a.accountId){x=a.accountId;y=a.sessionId;w=a.events;z=a.external;A=a.secureStorageLocation;v=a.cookieRefreshTimeout||5e3;B=a.sessionTimeout;n(a,function(a){B=a})}else F.error(\"init: no conf was provided\",C)}function c(a,b){var c;G.getValue({key:H,site:x,app:J,success:function(d){d&&(c=d.timestamp||\"null\");!y&&d&&(y=d.sid);k(y,c,!1,function(c){E.runCallback(a,null,c);\"function\"==typeof b&&E.runCallback(b)})},error:function(a){F.error(\"getSessionId - ERROR: \"+a,C)},appName:D,domain:A})}function d(a){var b;G.getValue({key:H,site:x,app:J,success:function(c){c&&(b=c.timestamp);E.runCallback(a,null,b)},error:function(a){F.error(\"getSessionTime - ERROR: \"+a,C)},appName:D,domain:A})}function e(){return B}function f(a,b,c){g(function(d){E.runCallback(c,null,a||d||b)})}function g(a){G.getValue({key:H,site:x,app:J,success:function(b){b&&E.runCallback(a,null,parseInt(b.sessionTimeout,10))},error:function(a){F.error(\"_getCookieSessionTimeout - ERROR: \"+a,C)},appName:D,domain:A})}function h(a){G.getValue({key:H,site:x,app:J,success:function(b){b&&E.runCallback(a,null,b)},error:function(a){F.error(\"getSessionCookie - ERROR: \"+a,C)},appName:D,domain:A})}function i(a){if(z)E.runCallback(a);else{I=!1;c(s,a)}}function j(a){clearTimeout(u);m();y=null;I=!0;!0===a||z||G.removeValue({key:H,site:x,app:J,appName:D,success:t,error:t,domain:A})}function k(a,b,c,d){G.getValue({key:H,site:x,app:J,success:function(e){if(!a||\"null\"===a&&!c)a=E.getUID();else if(a&&e&&a!==e.sid&&c){w.trigger({appName:C,eventName:\"sessionChanged\",data:e.sid});I=!0;return}z?E.runCallback(d,null,a):G.setValue({key:H,site:x,app:J,value:{sid:a,timestamp:b||\"null\",sessionTimeout:B||\"null\"},success:function(){E.runCallback(d,null,a)},error:function(a){F.error(\"_setSession - setValue - ERROR: \"+a,C)},appName:D,domain:A})},error:function(a){F.error(\"_setSession - getValue - ERROR: \"+a,C)},appName:D,domain:A})}function l(){w.bind({appName:\"ChatStateManager\",eventName:\"startChatInfo\",func:p})}function m(){w.unbind({appName:\"ChatStateManager\",eventName:\"startChatInfo\",func:p})}function n(a,b){z?E.runCallback(b,null,o()||a.sessionTimeout):f(a.echoedSessionTimeout,a.sessionTimeout,function(a){E.runCallback(b,null,a)})}function o(){var a,b=q();b.CT&&(a=parseInt(b.CT,10));return a}function p(a){if(a.chatTimeout){F.info(\"_updateChatTimeout : echoed chatTimeout = \"+a.chatTimeout,C);B=a.chatTimeout;if(z){var b=q();b.CT=B;window.location.hash=r(b)}}}function q(){return E.mapString(window.location.hash.substring(1),\"&\",!0)}function r(a){var b=[];for(var c in a)b.push(c+\"=\"+a[c]);return encodeURIComponent(b.join(\"&\"))}function s(){F.info(\"_refreshCookie : disposed = \"+I,C);u&&clearTimeout(u);if(!I){var a=(new Date).getTime();F.info(\"Refresh Cookie: timestamp = \"+a,C);k(y,a,!0,function(){u=setTimeout(s,v)})}}function t(){}var u,v,w,x,y,z,A,B,C=\"SessionManager\",D=\"SessionState\",E=lpTag.taglets.lpUtil,F=lpTag.unifiedWindow.log,G=lpTag.taglets.lpSecureStorage,H=\"-lpuw\",I=!1,J=lpTag.unifiedWindow.apps.UNIFIED_WINDOW;b(a);l();return{dispose:j,refresh:i,getSessionId:c,getSessionTime:d,getSessionCookie:h,getSessionTimeout:e}};window.lpTag=window.lpTag||{};lpTag.taglets=lpTag.taglets||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.StateAnalyzer=function(a,b){function c(a){if(\"object\"==typeof a&&b&&a.sessionId&&a.accountId&&a.secureStorageLocation){j=b;k=a.sessionId;l=a.accountId;m=a.secureStorageLocation}else p.error(\"init: no conf was provided\",n)}function d(a,b){p.info(\"getState\",n);lpTag.taglets.lpSecureStorage.getValue({key:k,site:l,app:s,success:g(a),error:i(b),appName:o,domain:m})}function e(b){var c=(new Date).getTime(),d=1e3*j.getSessionTimeout(),e=null;if(!a.crossDomainEnabled){var g=j.getSessionTime();e=void 0===g||\"null\"===g?r.NOT_STARTED:c-g<=d?r.IN_SESSION:r.EXPIRED;p.info(\"_getSessionState: now=\"+c+\" sessionTime=\"+g+\" sessionTimeout=\"+d+\" sessionState=\"+e,n);return e}j.getSessionTime(f.bind(this,b,c,d,e))}function f(a,b,c,d,e){d=void 0===e||\"null\"===e?r.NOT_STARTED:b-e<=c?r.IN_SESSION:r.EXPIRED;p.info(\"_getSessionState: now=\"+b+\" sessionTime=\"+e+\" sessionTimeout=\"+c+\" sessionState=\"+d,n);a(d)}function g(b){return a.crossDomainEnabled?function(a){var c=r.NOT_STARTED;e(h.bind(this,b,a,c))}:function(a){var c=e(),d=r.NOT_STARTED;a&&c===r.EXPIRED?d=r.EXPIRED:a?d=r.IN_SESSION:c===r.IN_SESSION&&(d=r.INVALID);p.info(\"_success: data = \"+JSON.stringify(a)+\" analyzerState=\"+d,n);q.runCallback(b,null,a,d)}}function h(a,b,c,d){b&&d===r.EXPIRED?c=r.EXPIRED:b?c=r.IN_SESSION:d===r.IN_SESSION&&(c=r.INVALID);p.info(\"_success: data = \"+JSON.stringify(b)+\" analyzerState=\"+c,n);q.runCallback(a,null,b,c)}function i(a){return function(b){p.info(\"_error: data = \"+JSON.stringify(b),n);q.runCallback(a,null,b,r.NOT_STARTED)}}var j,k,l,m,n=\"StateAnalyzer\",o=\"UIState\",p=lpTag.unifiedWindow.log,q=lpTag.taglets.lpUtil,r={NOT_STARTED:0,IN_SESSION:1,INVALID:2,EXPIRED:3},s=lpTag.unifiedWindow.apps.UNIFIED_WINDOW;c(a);return{getState:d,state:q.clone(r)}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.WindowConfigurationManager=function(a){function b(a){if(\"object\"==typeof a&&a.sessionId&&a.accountId&&a.secureStorageLocation&&a.domain){l=a.sessionId;k=a.accountId;m=a.secureStorageLocation;n=a.domain;p=a.windowId;o=l+u;q=a.providerId;r=a.referenceId}else v.error(\"init: no configuration given\",t)}function c(a){v.info(\"getConf\",t);s?w.runCallback(a,null,s):x.getValue({key:o,site:k,app:y,success:g(a),error:h(a),appName:u,domain:m})}function d(){x.removeValue({key:o,site:k,app:y,appName:u,success:j,error:j,domain:m})}function e(a){v.info(\"_setConf\",t);x.setValue({key:o,site:k,app:y,value:{conf:a,windowId:p},success:f,error:f,appName:u,domain:m,expires:108e5})}function f(a){v.info(\"_setCallback: data=\"+JSON.stringify(a),t)}function g(a){return function(b){v.info(\"_createSuccessCallback: windowConf = \"+JSON.stringify(b),t);if(a)if(b){s=b.conf;p=b.windowId;w.runCallback(a,null,s)}else i(a)}}function h(a){return function(b){v.info(\"_createErrorCallback: windowConf = \"+JSON.stringify(b),t);d();s=null;a&&i(a)}}function i(a){var b;v.info(\"_getConfiguration\",t);if(r&&q){b=\"https://\"+lpTag.taglets.caoServiceMap.getDomain(\"configurationCDN\")+\"/api/v1.0/configuration/window?callback=lpcb&referenceId=\"+r+\"&providerId=\"+q;p&&(b+=\"&windowId=\"+p);lpTag.taglets.jsonp.issueCall({callbackName:\"lpcb\",url:b,timeout:5e3,retries:0,success:function(b){if(b&&b.json&&b.json&&!b.error){v.info(\"_getConfiguration - got configuration: \"+JSON.stringify(b.json),t);s=b.json;w.runCallback(a,null,s);e(s)}else{v.info(\"_getConfiguration - NO CONFIGURATION FOUND\",t);w.runCallback(a)}},error:function(){v.info(\"_getConfiguration - ERROR FROM SERVER\",t);w.runCallback(a)}})}else{v.error(\"_getConfiguration: No referenceid/providerid provided, fallback to default configuration\",t);w.runCallback(a,null,{})}}function j(){}var k,l,m,n,o,p,q,r,s,t=\"WindowConfigurationManager\",u=\"UIConf\",v=lpTag.unifiedWindow.log,w=lpTag.taglets.lpUtil,x=lpTag.taglets.lpSecureStorage,y=lpTag.unifiedWindow.apps.UNIFIED_WINDOW;b(a);return{getConf:c,clear:d}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.WrapperWindow=function(a,b,c,d,e){function f(a,b){var c;if(a&&(ma.isDesktop()||ma.isTablet())){if(a.right>=0){c=a.right>document.body.clientWidth?document.body.clientWidth-280:a.right;wa.style.right=c+\"px\";xa.style.right=c+\"px\"}}else b&&ma.isMobile()&&wa.classList.add(b.className);Ta.debug(\"_setWindowPosition: offset=\"+a.right,Oa)}function g(){document.querySelector('[data-lp-point=\"header\"]').style.setProperty(\"border-radius\",\"0px\",\"important\");document.querySelector('[data-lp-point=\"notification_counter\"]').style.setProperty(\"margin-top\",\"22px\");document.querySelector(\".lp_desktop #lpChat>.lp_maximized>.lp_header\").style.setProperty(\"border-radius\",\"0px\",\"important\")}function h(a,b){if(a&&(ma.isDesktop()||ma.isTablet())&&!aa()){a.hasOwnProperty(\"top\")&&g();wa.style.top=xa.style.top=a.top;wa.style.left=xa.style.left=a.left;wa.style.right=xa.style.right=a.right;wa.style.bottom=xa.style.bottom=a.bottom;Ta.debug(\"_setConfiguredWindowPosition: left=\"+a.left+\" right=\"+a.right,Oa)}else b&&ma.isMobile()&&!aa()&&wa.classList.add(b.className)}function i(a){if(a){aa()||f(a.position,a.minMobilePosition);j(a.maximized);k(a.embedded,Xa.external,Xa.poppedOut)}else j(Xa.isMaximized)}function j(a){if(a){Ta.debug(\"maximizing\",Oa);wa.style.display=\"none\";xa.style.display=\"block\"}else{Ta.debug(\"minimizing\",Oa);wa.style.display=\"block\";xa.style.display=\"none\"}}function k(a,b,c){if(!a&&!b&&!c){wa.style.display=\"none\";xa.style.display=\"none\"}}function l(a){ga();var b=Ua[a];if(b&&b!==pa){oa=b.error;C(oa);ma.isDesktop()&&Da.focus();b.title?m(b.title):b.text&&m(b.text);P(b.text,b.imgUrl,b.imgAltText,a);pa=b}}function m(a,b){if(qa!==a){ba(a,b);qa=a;ra=b}}function n(a,b){a&&a.length>0&&ba(a,b)}function o(){ba(qa,ra)}function p(){if(I()){Ta.info(\"showing\",Oa);ta.style.display=\"block\"}}function q(){if(I()){Ta.info(\"hiding\",Oa);ta.style.display=\"none\"}}function r(a,b){I()?Sa.runCallback(b):Sa.waitForBody(function(){_(a);M();Sa.runCallback(b)})}function s(){return ta}function t(){return wa}function u(){return ya}function v(){return xa}function w(){return ua}function x(){return Ea}function y(){return Fa}function z(){return Ga}function A(){return Ha}function B(){return Ia}function C(a){a?Sa.removeClass(Da,\"lp_hidden\"):Sa.addClass(Da,\"lp_hidden\")}function D(a){a?Sa.removeClass(Ja,\"lp_hidden\"):Sa.addClass(Ja,\"lp_hidden\")}function E(a){Ta.info(\"applyConfigStyle\",Oa);a&&la(a)}function F(a){Ta.info(\"adjustWindowHeight\",Oa);xa.style.height=a}function G(){if(!Wa){Ta.info(\"disposing\",Oa);K();pa=null;qa=null;ra=null;H(!1);ua.remove?ua.remove():document.body.removeChild(ua);Wa=!0;Sa.runCallback(Ma)}}function H(a){Va=a}function I(){return!0===Va}function J(){Ta.info(\"_maximize\",Oa);j(!0)}function K(){Ta.info(\"unbinding dom events\",Oa);L();na.off(na.EVENT_NAME.ORIENTATION_CHANGE,ha)}function L(){Sa.unregisterEvent(wa,\"click\",J);Sa.unregisterEvent(Da,\"click\",G)}function M(){Sa.registerEvent(Da,\"click\",G)}function N(a){ga();Ta.info(\"removing current message\",Oa);var b=Ca.querySelector('[data-lp-point=\"message\"]');if(b){b.remove?b.remove():Ca.removeChild(b);a||m(\"\");R()}}function O(){return Xa.iconsRepository}function P(a,b,c,d){p();b=b||\"\";c=c||\"\";a=a||\"\";N();Ta.info(\"setting message to: \"+d,Oa);var e;e=d===sa.WAIT?'<div class=\"lp_message\" data-lp-point=\"message\"><table class=\"lp_centralizer\"><tbody><td><div class=\"lp_rotator-container\"><div class=\"lp_rotator-container-bg\"></div><div class=\"lp_rotator\"><img src=\"{{imagesRepository}}/{{imageUrl}}\" alt=\"\"></div></div></td></tbody></table></div>':'<div class=\"lp_message\" data-lp-point=\"message\" aria-labelledby=\"lp_alert_message\"><table class=\"lp_centralizer\"><tbody><tr><td><img src=\"{{imagesRepository}}/{{imageUrl}}\"><div id=\"lp_alert_message\" class=\"lp_text\">{{text}}</div></td></tr></tbody></table></div>';e=Q(e);e=e.replace(\"{{text}}\",a);e=e.replace(\"{{imageUrl}}\",b);e=e.replace(\"{{imageAltText}}\",c?'alt=\"'+c+'\"':\"\");Ca.innerHTML+=e;setTimeout(function(){Ca.firstChild.setAttribute(\"role\",\"alert\")},0)}function Q(a){a=a.replace(/\\{\\{iconsRepository\\}\\}/g,O());a=a.replace(/\\{\\{imagesRepository\\}\\}/g,Xa.imagesRepository);return a}function R(){Sa.removeClass(Ca,\"lp_centered\")}function S(a,b){if(\"object\"==typeof a)for(var c in a)Xa[c]=a[c];else Xa[a]=b}function T(a,b,c,d,e){ma=b;na=c;Ma=d;Na=e;S(a)}function U(){var a=Qa.WRAPPER_DIV_CSS_CLASS_PREFIX;ma.isMobile()?a+=Qa.MOBILE_CSS_CLASS:(ma.isTablet(),a+=Qa.DESKTOP_CSS_CLASS);Sa.addClass(ua,a);return a}function V(){ma.isNativeAndroid()&&Sa.addClass(ua,Qa.WRAPPER_DIV_CSS_CLASS_PREFIX+Qa.NATIVE_CSS_CLASS);var a=Qa.WRAPPER_DIV_CSS_CLASS_PREFIX;if(ma.isIE())a+=\"ie\"+ma.browserVersion();else if(ma.isIOS()){a+=Qa.IOS_CSS_CLASS;ma.isIOS6()?a+=\" \"+Qa.IOS6_CSS_CLASS:ma.isIOS8OrAbove()&&(a+=\" \"+Qa.WRAPPER_DIV_CSS_CLASS_PREFIX+Qa.IOS8_OR_ABOVE_CSS_CLASS)}else if(ma.isAndroid())a+=Qa.ANDROID_CSS_CLASS;else{if(!ma.isMacOS())return;a+=Qa.MAC_OSX_CSS_CLASS}Sa.addClass(ua,a);return a}function W(){var a='<div class=\"lp_minimized\" data-lp-point=\"minimized\" data-lp-cust-id=\"minimized\" role=\"region\"><div class=\"lp_main\" data-lp-point=\"main\" role=\"navigation\"><div class=\"lp_header\" data-lp-point=\"header\" data-lp-cust-id=\"top\"><div class=\"lp_notification_number lpHide\" data-lp-point=\"notification_counter\"><span class=\"lp_notification_text\" data-lp-point=\"notification_text\">{{notification_number}}</span></div><div class=\"lp_header-content-wrapper\"><div class=\"lp_title\" role=\"heading\"><div class=\"lp_chatting-with-icon lpHide\" data-lp-type=\"icon\" data-lp-point=\"chattingWithIcon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"\" data-lp-cust-id=\"topBarIcon\"></div><span data-lp-point=\"headerText\" data-lp-cust-id=\"top_text\" class=\"lp_top-text\" data-studio-click=\"true\">{{windowTitle}}</span></div><div class=\"lp_header-buttons-container\" role=\"menubar\"><button title=\"{{tooltip_Maximize}}\" class=\"lp_maximize\" data-lp-point=\"maximize\" role=\"menuitem\"><div class=\"lp_maximize-icon\" data-lp-type=\"icon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"{{tooltip_Maximize}}\" aria-hidden=\"true\"></div></button> <button title=\"{{tooltip_Close}}\" class=\"lp_close\" data-lp-point=\"close\" role=\"menuitem\"><div class=\"lp_close-icon\" data-lp-type=\"icon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"{{tooltip_Close}}\" aria-hidden=\"true\"></div></button></div></div></div></div></div>';a=Q(a);a=a.replace(/\\{\\{tooltip_Close\\}\\}/g,Ra.getString(\"tooltip_Close\"));ta.innerHTML+=a}function X(){W();Y();Z()}function Y(){var a='<div class=\"lp_maximized\" data-lp-point=\"maximized\" role=\"region\"><div class=\"lp_header\" data-lp-point=\"header\" data-lp-cust-id=\"top\" data-studio-click=\"true\" role=\"navigation\"><div class=\"lp_header-content-wrapper\"><button title=\"{{tooltip_open_widgets}}\" class=\"lp_hidden lp_slider\" data-lp-point=\"widget_sdk\" role=\"menuitem\"><div class=\"lp-slider-icon\" data-lp-type=\"icon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"\" aria-hidden=\"true\"></div></button><div class=\"lp_notification_number wsdkNotification lpHide\" data-lp-point=\"widgetNotificationContainer\"><span class=\"lp_notification_text\" data-lp-point=\"widgetNotificationText\">0</span></div><div class=\"lp_title\" data-lp-point=\"maximizedTitleContainer\"><div class=\"lp_chatting-with-icon lpHide\" data-lp-type=\"icon\" data-lp-point=\"chattingWithIcon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"\" aria-hidden=\"true\" data-lp-cust-id=\"topBarIcon\"></div><span data-lp-point=\"headerText\" data-lp-cust-id=\"top_text\" class=\"lp_top-text\" data-studio-click=\"true\" aria-live=\"assertive\" role=\"presentation\">{{windowTitle}}</span></div><div class=\"lp_header-buttons-container\" role=\"menubar\"><button title=\"{{tooltip_Minimize}}\" class=\"lp_minimize\" data-lp-point=\"minimize\" role=\"menuitem\"><div class=\"lp_minimize-icon\" data-lp-type=\"icon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"{{tooltip_Minimize}}\" aria-hidden=\"true\"></div></button> <button title=\"{{tooltip_Close}}\" class=\"lp_close\" data-lp-point=\"close\" role=\"menuitem\"><div class=\"lp_close-icon\" data-lp-type=\"icon\"><img src=\"{{iconsRepository}}/sprites_v1.png\" alt=\"{{tooltip_Close}}\" aria-hidden=\"true\"></div></button></div></div></div><div class=\"lp_main\" data-lp-point=\"main\" data-lp-cust-id=\"mainArea\" role=\"main\"></div></div><div data-lp-point=\"buffer-strip\" class=\"lp_buffer-strip\"><div class=\"lp_buffer-strip-container\" data-lp-cust-id=\"mainArea\"></div></div>';a=Q(a);a=a.replace(/\\{\\{tooltip_Close\\}\\}/g,Ra.getString(\"tooltip_Close\"));ta.innerHTML+=a}function Z(){wa=ta.querySelector('[data-lp-point=\"minimized\"]');xa=ta.querySelector('[data-lp-point=\"maximized\"]');ya=ta.querySelector('[data-lp-point=\"buffer-strip\"]')}function $(){ta=document.createElement(\"div\");Qa.WRAPPER_DIV_ID&&(ta.id=Qa.WRAPPER_DIV_ID);ua=document.createElement(\"div\");ua.appendChild(ta);document.body.appendChild(ua)}function _(a){Ta.info(\"rendering\",Oa);$();X();var b=wa.querySelector('[data-lp-point=\"main\"]');Sa.addClass(wa,\"lpHide\");if(Qa.MINIMIZED_VIEW_IFRAME_RENDERING){za=fa(b);Aa=za.body;Sa.addClass(Aa,\"lp_main\")}else Aa=b;var c=xa.querySelector('[data-lp-point=\"main\"]');if(Qa.MAXIMIZED_VIEW_IFRAME_RENDERING){Ba=fa(c);Ca=Ba.body;Sa.addClass(Ca,\"lp_main\")}else Ca=c;Ea=xa.querySelector(['[data-lp-point=\"widget_sdk\"]']);Fa=xa.querySelector(['[data-lp-point=\"widgetNotificationContainer\"]']);Ga=xa.querySelector(['[data-lp-point=\"widgetNotificationText\"]']);Ha=xa.querySelector(['[data-lp-point=\"maximizedTitleContainer\"]']);Ia=xa.querySelector(['[data-lp-point=\"chattingWithIcon\"]']);Da=xa.querySelector(['[data-lp-point=\"close\"]']);Ja=xa.querySelector(['[data-lp-point=\"minimize\"]']);Ka=xa.querySelector(['[data-lp-point=\"popicon\"]']);Ka&&Sa.addClass(Ka,Xa.poppedOut?\"lp_pop-in-icon\":\"lp_pop-out-icon\");if(aa()){ia();ka(Xa.engConf.language);ja()}D(!1);C(!1);i(a);ea();ca();H(!0);da();h(a.position,a.minMobilePosition)}function aa(){return Xa.poppedOut||Xa.external}function ba(a,b){Ta.info('setting title to: \"'+a+'\"',Oa);var c=ta.querySelectorAll('[data-lp-point=\"headerText\"]');b=b||a;for(var d=0;d<c.length;d++)c[d].innerHTML=b}function ca(){La=setTimeout(function(){l(sa.WAIT)},Qa.WAIT_INDICATION_DELAY)}function da(){U();V();if(ma.isMobile()&&!ma.isTablet()){ha({landscape:na.isLandscape()});na.on(na.EVENT_NAME.ORIENTATION_CHANGE,ha)}}function ea(){Ta.info(\"applying style\",Oa);va=Sa.addStyleTag('#lpChat *{box-sizing:border-box;font-weight:normal;letter-spacing:0;font-family:inherit;opacity:1;filter:alpha(opacity=100);max-width:none;direction:inherit;text-align:inherit;text-transform:none;outline:none}#lpChat *::-moz-focus-inner{border:0}#lpChat .lp_main_area *{-webkit-overflow-scrolling:touch;-webkit-text-size-adjust:none;-webkit-font-smoothing:antialiased}#lpChat img{margin:0;padding:0;border:0;vertical-align:bottom;background:inherit;background:initial;position:static;position:initial;color:black;width:auto;height:auto;text-shadow:none;box-shadow:none;-webkit-box-shadow:initial;line-height:normal}#lpChat b,#lpChat strong{font-weight:bold}#lpChat h1,#lpChat h2,#lpChat h3,#lpChat h4,#lpChat h5,#lpChat h6,#lpChat p,#lpChat blockquote,#lpChat pre,#lpChat a,#lpChat abbr,#lpChat acronym,#lpChat address,#lpChat big,#lpChat cite,#lpChat code,#lpChat del,#lpChat dfn,#lpChat em,#lpChat ins,#lpChat kbd,#lpChat q,#lpChat s,#lpChat samp,#lpChat small,#lpChat strike,#lpChat strong,#lpChat sub,#lpChat sup,#lpChat tt,#lpChat var,#lpChat b,#lpChat u,#lpChat i,#lpChat center,#lpChat dl,#lpChat dt,#lpChat dd,#lpChat ol,#lpChat ul,#lpChat li,#lpChat fieldset,#lpChat form,#lpChat select,#lpChat label,#lpChat legend,#lpChat table,#lpChat caption,#lpChat tbody,#lpChat tfoot,#lpChat thead,#lpChat tr,#lpChat th,#lpChat td,#lpChat article,#lpChat aside,#lpChat canvas,#lpChat details,#lpChat embed,#lpChat figure,#lpChat figcaption,#lpChat footer,#lpChat header,#lpChat menu,#lpChat nav,#lpChat output,#lpChat ruby,#lpChat section,#lpChat summary,#lpChat span,#lpChat time,#lpChat mark,#lpChat audio,#lpChat video,#lpChat p{margin:0;padding:0;border:0;vertical-align:baseline;background:inherit;background:initial;position:static;position:initial;color:inherit;width:auto;height:auto;text-shadow:none;box-shadow:none;-webkit-box-shadow:initial;line-height:normal;font-size:inherit}#lpChat input[type=\"text\"]:focus{height:auto;text-indent:0}#lpChat input:not([type=\"radio\"]){margin:0;padding:0;border:0;vertical-align:baseline;background:inherit;background:initial;position:static;position:initial;color:black;width:auto;height:auto;text-shadow:none;text-indent:0;box-shadow:none;-webkit-box-shadow:initial;line-height:normal;float:none}#lpChat input[type=\"radio\"],#lpChat textarea{margin:0;padding:0;border:0;border-radius:0;vertical-align:baseline;position:static;position:initial;color:black;width:auto;height:auto;min-height:0;text-shadow:none;text-indent:0;box-shadow:none;-webkit-box-shadow:initial;line-height:normal;float:none}#lpChat input[type=\"radio\"]{-moz-appearance:radio;-webkit-appearance:radio;appearance:radio}#lpChat input[type=\"radio\"]:checked:after{background:inherit;background:initial;border:0;width:auto;height:auto}#lpChat input[type=\"radio\"]:after{display:inline-block;border-radius:0;box-sizing:content-box;content:normal}#lpChat textarea{font-size:inherit}#lpChat legend{display:block}#lpChat div,#lpChat button{margin:0;padding:0;border:0;vertical-align:baseline;background:inherit;background:initial;position:static;position:initial;font-family:inherit;color:inherit;width:auto;height:auto;text-shadow:none;box-shadow:none;-webkit-box-shadow:initial;line-height:normal;font-size:inherit}#lpChat button{font-size:1em;border-radius:0}#lpChat input[type=\"checkbox\"]{-moz-appearance:checkbox;-webkit-appearance:checkbox;appearance:checkbox}#lpChat input{height:auto;vertical-align:middle}#lpChat [aria-hidden]{display:inherit;display:initial}#lpChat .lpHide{display:none !important}#lpChat .lpNoOutlineFocus{outline:none !important}#lpChat .lpInlineBlock{display:inline-block !important}#lpChat .lpClearfix:after{visibility:hidden;display:block;font-size:0;content:\" \";clear:both;height:0}.lp_desktop #lpChat .lp_close-icon{position:relative !important;display:inline-block;vertical-align:middle;overflow:hidden !important;width:22px !important;height:22px !important}.lp_desktop #lpChat .lp_close-icon.lp_icon-white img{top:-40px !important;left:-480px !important}.lp_desktop #lpChat .lp_close-icon img{top:0 !important;left:-480px !important;position:absolute !important}.lp_desktop #lpChat .lp_minimize-icon{position:relative !important;display:inline-block;vertical-align:middle;overflow:hidden !important;width:22px !important;height:22px !important}.lp_desktop #lpChat .lp_minimize-icon.lp_icon-white img{top:-40px !important;left:-600px !important}.lp_desktop #lpChat .lp_minimize-icon img{top:0 !important;left:-600px !important;position:absolute !important}.lp_desktop #lpChat .lp_maximize-icon{position:relative !important;display:inline-block;vertical-align:middle;overflow:hidden !important;width:22px !important;height:22px !important}.lp_desktop #lpChat .lp_maximize-icon.lp_icon-white img{top:-40px !important;left:-960px !important}.lp_desktop #lpChat .lp_maximize-icon img{top:0 !important;left:-960px !important;position:absolute !important}.lp_desktop #lpChat .lp_close,.lp_desktop #lpChat .lp_minimize,.lp_desktop #lpChat .lp_maximize,.lp_desktop #lpChat .lp_popout,.lp_desktop #lpChat .lp_actions_button,.lp_desktop #lpChat .lp_slider{width:22px;height:22px}.lp_tablet #lpChat .lp_close-icon,.lp_mobile #lpChat .lp_close-icon{position:relative !important;display:inline-block;vertical-align:middle;overflow:hidden !important;width:24px !important;height:24px !important}.lp_tablet #lpChat .lp_close-icon.lp_icon-white img,.lp_mobile #lpChat .lp_close-icon.lp_icon-white img{top:-40px !important;left:-480px !important}.lp_tablet #lpChat .lp_close-icon img,.lp_mobile #lpChat .lp_close-icon img{top:0 !important;left:-480px !important;position:absolute !important}.lp_tablet #lpChat .lp_minimize-icon,.lp_mobile #lpChat .lp_minimize-icon{position:relative !important;display:inline-block;vertical-align:middle;overflow:hidden !important;width:24px !important;height:24px !important}.lp_tablet #lpChat .lp_minimize-icon.lp_icon-white img,.lp_mobile #lpChat .lp_minimize-icon.lp_icon-white img{top:-40px !important;left:-600px !important}.lp_tablet #lpChat .lp_minimize-icon img,.lp_mobile #lpChat .lp_minimize-icon img{top:0 !important;left:-600px !important;position:absolute !important}.lp_tablet #lpChat .lp_maximize-icon,.lp_mobile #lpChat .lp_maximize-icon{position:relative !important;display:inline-block;vertical-align:middle;overflow:hidden !important;width:24px !important;height:24px !important}.lp_tablet #lpChat .lp_maximize-icon.lp_icon-white img,.lp_mobile #lpChat .lp_maximize-icon.lp_icon-white img{top:-40px !important;left:-960px !important}.lp_tablet #lpChat .lp_maximize-icon img,.lp_mobile #lpChat .lp_maximize-icon img{top:0 !important;left:-960px !important;position:absolute !important}.lp_tablet #lpChat .lp_close,.lp_tablet #lpChat .lp_minimize,.lp_tablet #lpChat .lp_maximize,.lp_tablet #lpChat .lp_popout,.lp_tablet #lpChat .lp_actions_button,.lp_tablet #lpChat .lp_slider,.lp_mobile #lpChat .lp_close,.lp_mobile #lpChat .lp_minimize,.lp_mobile #lpChat .lp_maximize,.lp_mobile #lpChat .lp_popout,.lp_mobile #lpChat .lp_actions_button,.lp_mobile #lpChat .lp_slider{width:24px;height:24px}#lpChat button:focus,#lpChat input:focus,#lpChat textarea:focus,#lpChat select:focus,#lpChat a:focus{outline:#6A9FB1 solid 2px}.lp_mobile #lpChat,.lp_tablet #lpChat,.lp_desktop #lpChat{font-family:\"Arial\"}.lp_mobile #lpChat>.lp_buffer-strip,.lp_tablet #lpChat>.lp_buffer-strip,.lp_desktop #lpChat>.lp_buffer-strip{display:none}.lp_mobile #lpChat .lp_centerd_img,.lp_tablet #lpChat .lp_centerd_img,.lp_desktop #lpChat .lp_centerd_img{position:absolute;margin:auto;top:0;left:0;right:0;bottom:0}.lp_mobile #lpChat table.lp_centralizer,.lp_tablet #lpChat table.lp_centralizer,.lp_desktop #lpChat table.lp_centralizer{height:100%;width:100%}.lp_mobile #lpChat table.lp_centralizer td,.lp_tablet #lpChat table.lp_centralizer td,.lp_desktop #lpChat table.lp_centralizer td{text-align:center;vertical-align:middle}.lp_mobile #lpChat .lp_rotator-container,.lp_tablet #lpChat .lp_rotator-container,.lp_desktop #lpChat .lp_rotator-container{position:relative;display:inline-block;width:100px;height:100px}.lp_mobile #lpChat .lp_rotator-container .lp_rotator-container-bg,.lp_tablet #lpChat .lp_rotator-container .lp_rotator-container-bg,.lp_desktop #lpChat .lp_rotator-container .lp_rotator-container-bg{position:absolute;top:0;right:0;bottom:0;left:0;background-color:transparent;opacity:0.92;border-radius:10px}.lp_mobile #lpChat .lp_rotator-container .lp_rotator,.lp_tablet #lpChat .lp_rotator-container .lp_rotator,.lp_desktop #lpChat .lp_rotator-container .lp_rotator{padding-top:12px;text-align:center;position:absolute;top:0;right:0;bottom:0;left:0}.lp_mobile #lpChat>.lp_minimized .lp_header,.lp_tablet #lpChat>.lp_minimized .lp_header,.lp_desktop #lpChat>.lp_minimized .lp_header,.lp_mobile #lpChat>.lp_maximized .lp_header,.lp_tablet #lpChat>.lp_maximized .lp_header,.lp_desktop #lpChat>.lp_maximized .lp_header{border-color:#d6d6d6;border-width:1px;border-style:solid;font-size:1.1em;z-index:2;width:100%;position:absolute}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper{width:100%;height:100%}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title{direction:ltr}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title>*,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title>*,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title>*,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title>*,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title>*,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title>*{vertical-align:middle}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text{overflow:hidden;text-overflow:ellipsis;display:inline-block;margin-left:8px;max-width:150px;white-space:nowrap}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title .lp_chatting-with-icon.lpHide ~ .lp_top-text,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title .lp_chatting-with-icon.lpHide ~ .lp_top-text,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_title .lp_chatting-with-icon.lpHide ~ .lp_top-text,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_chatting-with-icon.lpHide ~ .lp_top-text,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_chatting-with-icon.lpHide ~ .lp_top-text,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_chatting-with-icon.lpHide ~ .lp_top-text{margin-left:0}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_slider.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_slider.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_slider.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_slider.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_slider.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_slider.lp_hidden{display:none !important}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close.lp_hidden,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize.lp_hidden,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize.lp_hidden,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout.lp_hidden,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh.lp_hidden,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon.lp_hidden,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon.lp_hidden,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh.lp_hidden,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon.lp_hidden,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon.lp_hidden,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon.lp_hidden{display:none}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close:disabled,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close:disabled,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close:disabled,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize:disabled,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize:disabled,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize:disabled,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize:disabled,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize:disabled,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize:disabled,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout:disabled,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout:disabled,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout:disabled,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh:disabled,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh:disabled,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh:disabled,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close:disabled,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close:disabled,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close:disabled,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize:disabled,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize:disabled,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize:disabled,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize:disabled,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize:disabled,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize:disabled,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout:disabled,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout:disabled,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout:disabled,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh:disabled,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh:disabled,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh:disabled,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled{cursor:default}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close:disabled img,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close:disabled img,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_close:disabled img,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize:disabled img,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize:disabled img,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_minimize:disabled img,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize:disabled img,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize:disabled img,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_maximize:disabled img,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout:disabled img,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout:disabled img,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_popout:disabled img,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh:disabled img,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh:disabled img,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_refresh:disabled img,.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled img,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled img,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled img,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close:disabled img,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close:disabled img,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_close:disabled img,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize:disabled img,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize:disabled img,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_minimize:disabled img,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize:disabled img,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize:disabled img,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_maximize:disabled img,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout:disabled img,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout:disabled img,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_popout:disabled img,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh:disabled img,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh:disabled img,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_refresh:disabled img,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled img,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled img,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_chatting-with-icon:disabled img{opacity:0.5}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper button,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper button,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper button,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper button,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper button,.lp_desktop #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper button{padding:0;background:none;border:none;position:absolute;cursor:pointer}.lp_mobile #lpChat>.lp_minimized .lp_header.lp_slider,.lp_tablet #lpChat>.lp_minimized .lp_header.lp_slider,.lp_desktop #lpChat>.lp_minimized .lp_header.lp_slider,.lp_mobile #lpChat>.lp_maximized .lp_header.lp_slider,.lp_tablet #lpChat>.lp_maximized .lp_header.lp_slider,.lp_desktop #lpChat>.lp_maximized .lp_header.lp_slider{position:absolute;width:22px;height:22px;top:5px;left:5px}.lp_mobile #lpChat>.lp_minimized>.lp_main,.lp_tablet #lpChat>.lp_minimized>.lp_main,.lp_desktop #lpChat>.lp_minimized>.lp_main,.lp_mobile #lpChat>.lp_maximized>.lp_main,.lp_tablet #lpChat>.lp_maximized>.lp_main,.lp_desktop #lpChat>.lp_maximized>.lp_main{padding:0;z-index:1;height:100%;width:100%;position:absolute;right:0;bottom:0}.lp_mobile #lpChat>.lp_minimized>.lp_main .lp_wait,.lp_tablet #lpChat>.lp_minimized>.lp_main .lp_wait,.lp_desktop #lpChat>.lp_minimized>.lp_main .lp_wait,.lp_mobile #lpChat>.lp_maximized>.lp_main .lp_wait,.lp_tablet #lpChat>.lp_maximized>.lp_main .lp_wait,.lp_desktop #lpChat>.lp_maximized>.lp_main .lp_wait{position:absolute;top:0;bottom:0;left:0;right:0}.lp_mobile #lpChat>.lp_minimized>.lp_main .lp_wait table,.lp_tablet #lpChat>.lp_minimized>.lp_main .lp_wait table,.lp_desktop #lpChat>.lp_minimized>.lp_main .lp_wait table,.lp_mobile #lpChat>.lp_maximized>.lp_main .lp_wait table,.lp_tablet #lpChat>.lp_maximized>.lp_main .lp_wait table,.lp_desktop #lpChat>.lp_maximized>.lp_main .lp_wait table{height:100%;width:100%}.lp_mobile #lpChat>.lp_minimized>.lp_main .lp_wait table td,.lp_tablet #lpChat>.lp_minimized>.lp_main .lp_wait table td,.lp_desktop #lpChat>.lp_minimized>.lp_main .lp_wait table td,.lp_mobile #lpChat>.lp_maximized>.lp_main .lp_wait table td,.lp_tablet #lpChat>.lp_maximized>.lp_main .lp_wait table td,.lp_desktop #lpChat>.lp_maximized>.lp_main .lp_wait table td{text-align:center;vertical-align:middle}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_message,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_message,.lp_desktop #lpChat>.lp_minimized>.lp_main>.lp_message,.lp_mobile #lpChat>.lp_maximized>.lp_main>.lp_message,.lp_tablet #lpChat>.lp_maximized>.lp_main>.lp_message,.lp_desktop #lpChat>.lp_maximized>.lp_main>.lp_message{text-align:center;width:100%;height:100%}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_message img[src=\"\"],.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_message img[src=\"\"],.lp_desktop #lpChat>.lp_minimized>.lp_main>.lp_message img[src=\"\"],.lp_mobile #lpChat>.lp_maximized>.lp_main>.lp_message img[src=\"\"],.lp_tablet #lpChat>.lp_maximized>.lp_main>.lp_message img[src=\"\"],.lp_desktop #lpChat>.lp_maximized>.lp_main>.lp_message img[src=\"\"]{display:none}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_message .lp_text,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_message .lp_text,.lp_desktop #lpChat>.lp_minimized>.lp_main>.lp_message .lp_text,.lp_mobile #lpChat>.lp_maximized>.lp_main>.lp_message .lp_text,.lp_tablet #lpChat>.lp_maximized>.lp_main>.lp_message .lp_text,.lp_desktop #lpChat>.lp_maximized>.lp_main>.lp_message .lp_text{padding:10px 4px 0 4px;text-align:center}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_message .lp_text:empty,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_message .lp_text:empty,.lp_desktop #lpChat>.lp_minimized>.lp_main>.lp_message .lp_text:empty,.lp_mobile #lpChat>.lp_maximized>.lp_main>.lp_message .lp_text:empty,.lp_tablet #lpChat>.lp_maximized>.lp_main>.lp_message .lp_text:empty,.lp_desktop #lpChat>.lp_maximized>.lp_main>.lp_message .lp_text:empty{display:none}.lp_mobile #lpChat>.lp_minimized>.lp_footer,.lp_tablet #lpChat>.lp_minimized>.lp_footer,.lp_desktop #lpChat>.lp_minimized>.lp_footer,.lp_mobile #lpChat>.lp_maximized>.lp_footer,.lp_tablet #lpChat>.lp_maximized>.lp_footer,.lp_desktop #lpChat>.lp_maximized>.lp_footer{position:absolute;left:0;right:0;bottom:0;height:28px;z-index:1;color:#6d6e70;background-color:white;border-top:1px solid #d6d6d6}.lp_mobile #lpChat>.lp_minimized>.lp_footer .lp_footer_image,.lp_tablet #lpChat>.lp_minimized>.lp_footer .lp_footer_image,.lp_desktop #lpChat>.lp_minimized>.lp_footer .lp_footer_image,.lp_mobile #lpChat>.lp_maximized>.lp_footer .lp_footer_image,.lp_tablet #lpChat>.lp_maximized>.lp_footer .lp_footer_image,.lp_desktop #lpChat>.lp_maximized>.lp_footer .lp_footer_image{display:inline-block;float:left;height:100%;padding:3.5px 0px}.lp_mobile #lpChat>.lp_minimized>.lp_footer .lp_footer_links,.lp_tablet #lpChat>.lp_minimized>.lp_footer .lp_footer_links,.lp_desktop #lpChat>.lp_minimized>.lp_footer .lp_footer_links,.lp_mobile #lpChat>.lp_maximized>.lp_footer .lp_footer_links,.lp_tablet #lpChat>.lp_maximized>.lp_footer .lp_footer_links,.lp_desktop #lpChat>.lp_maximized>.lp_footer .lp_footer_links{display:inline-block;float:right;padding-right:5px}.lp_mobile #lpChat>.lp_minimized>.lp_footer .lp_footer_link,.lp_tablet #lpChat>.lp_minimized>.lp_footer .lp_footer_link,.lp_desktop #lpChat>.lp_minimized>.lp_footer .lp_footer_link,.lp_mobile #lpChat>.lp_maximized>.lp_footer .lp_footer_link,.lp_tablet #lpChat>.lp_maximized>.lp_footer .lp_footer_link,.lp_desktop #lpChat>.lp_maximized>.lp_footer .lp_footer_link{font-size:0.8em;line-height:27px;text-decoration:underline}.lp_mobile #lpChat>.lp_maximized,.lp_tablet #lpChat>.lp_maximized,.lp_desktop #lpChat>.lp_maximized{border:1px solid #d6d6d6;border-radius:5px 5px 0 0;box-shadow:0px 0px 16px 3px rgba(0,0,0,0.2);color:#000000}.lp_mobile #lpChat>.lp_maximized>.lp_header,.lp_tablet #lpChat>.lp_maximized>.lp_header,.lp_desktop #lpChat>.lp_maximized>.lp_header{cursor:move}.lp_mobile #lpChat>.lp_maximized>.lp_main,.lp_tablet #lpChat>.lp_maximized>.lp_main,.lp_desktop #lpChat>.lp_maximized>.lp_main{background-color:#ffffff}.lp_mobile #lpChat>.lp_maximized.lp_external-window,.lp_tablet #lpChat>.lp_maximized.lp_external-window,.lp_desktop #lpChat>.lp_maximized.lp_external-window{border-radius:0;position:fixed;left:0;right:0;bottom:0;top:0;width:100%;height:100%;overflow:hidden}.lp_mobile #lpChat>.lp_maximized.lp_external-window>.lp_header,.lp_tablet #lpChat>.lp_maximized.lp_external-window>.lp_header,.lp_desktop #lpChat>.lp_maximized.lp_external-window>.lp_header{cursor:default}.lp_mobile #lpChat>.lp_maximized.lp_external-window>.lp_header .lp_header-content-wrapper .lp_minimize,.lp_tablet #lpChat>.lp_maximized.lp_external-window>.lp_header .lp_header-content-wrapper .lp_minimize,.lp_desktop #lpChat>.lp_maximized.lp_external-window>.lp_header .lp_header-content-wrapper .lp_minimize{display:none}.lp_mobile #lpChat>.lp_maximized>.lp_header,.lp_tablet #lpChat>.lp_maximized>.lp_header,.lp_desktop #lpChat>.lp_maximized>.lp_header{border-radius:5px 5px 0 0;background-color:#f0f0f0}.lp_mobile #lpChat>.lp_minimized,.lp_tablet #lpChat>.lp_minimized,.lp_desktop #lpChat>.lp_minimized{border-radius:5px 5px 0 0}.lp_mobile #lpChat>.lp_minimized .lp_header,.lp_tablet #lpChat>.lp_minimized .lp_header,.lp_desktop #lpChat>.lp_minimized .lp_header{border-radius:5px 5px 0 0;background-color:#f0f0f0;box-shadow:0px 0px 16px 3px rgba(0,0,0,0.2);height:100%}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_title,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_title,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_title{color:#000000;width:100%;padding:10px 0 0 9px;text-align:left}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper{border-radius:inherit}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper>div,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper>div,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper>div{border-radius:inherit}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper{text-align:center;display:table;border-collapse:collapse}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper>*,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper>*,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper>*,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper>*{vertical-align:middle;display:table-cell}.lp_mobile #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_header-buttons-container,.lp_tablet #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_header-buttons-container,.lp_mobile #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_header-buttons-container,.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_header-buttons-container{display:table}.lp_mobile #lpChat>.lp_minimized.lp_webview-window>.lp_header .lp_header-content-wrapper .lp_minimize,.lp_tablet #lpChat>.lp_minimized.lp_webview-window>.lp_header .lp_header-content-wrapper .lp_minimize,.lp_mobile #lpChat>.lp_maximized.lp_webview-window>.lp_header .lp_header-content-wrapper .lp_minimize,.lp_tablet #lpChat>.lp_maximized.lp_webview-window>.lp_header .lp_header-content-wrapper .lp_minimize{display:block}.lp_mobile #lpChat>.lp_buffer-strip,.lp_tablet #lpChat>.lp_buffer-strip{position:fixed;opacity:0.95;bottom:0;left:0;right:0}.lp_mobile #lpChat>.lp_buffer-strip .lp_buffer-strip-container,.lp_tablet #lpChat>.lp_buffer-strip .lp_buffer-strip-container{width:100%;height:100%}.lp_mobile #lpChat>.lp_maximized,.lp_tablet #lpChat>.lp_maximized{z-index:99999999;opacity:0.95;position:fixed;top:0;right:0;bottom:0;left:0;border-radius:0}.lp_mobile #lpChat>.lp_maximized>.lp_header,.lp_tablet #lpChat>.lp_maximized>.lp_header{direction:ltr;height:8%;min-height:40px}.lp_mobile #lpChat>.lp_maximized>.lp_header .lp_title,.lp_tablet #lpChat>.lp_maximized>.lp_header .lp_title{width:100%;text-align:center}.lp_mobile #lpChat>.lp_maximized>.lp_header .lp_title .lp_top-text,.lp_tablet #lpChat>.lp_maximized>.lp_header .lp_title .lp_top-text{text-align:center}.lp_mobile #lpChat>.lp_maximized>.lp_header button,.lp_tablet #lpChat>.lp_maximized>.lp_header button{top:0;right:0;height:100%;width:40px;text-align:center;position:absolute}.lp_mobile #lpChat>.lp_maximized>.lp_header button.lp_popout,.lp_tablet #lpChat>.lp_maximized>.lp_header button.lp_popout{display:none}.lp_mobile #lpChat>.lp_maximized>.lp_header button.lp_close,.lp_tablet #lpChat>.lp_maximized>.lp_header button.lp_close{right:0}.lp_mobile #lpChat>.lp_maximized>.lp_header button.lp_minimize,.lp_tablet #lpChat>.lp_maximized>.lp_header button.lp_minimize{right:auto;left:0}.lp_mobile #lpChat>.lp_maximized>.lp_main,.lp_tablet #lpChat>.lp_maximized>.lp_main{height:92%;max-height:calc(100% - 40px)}.lp_mobile #lpChat>.lp_minimized,.lp_tablet #lpChat>.lp_minimized{position:fixed;z-index:99999999;top:28%;right:0;min-width:40px;height:43%;border-radius:5px 0 0 5px}.lp_mobile #lpChat>.lp_minimized.lp_top-left,.lp_tablet #lpChat>.lp_minimized.lp_top-left{top:5%;right:auto;left:0;-ms-transform:rotate(180deg);transform:rotate(180deg)}.lp_mobile #lpChat>.lp_minimized.lp_top-left .lp_notification_number,.lp_tablet #lpChat>.lp_minimized.lp_top-left .lp_notification_number{-ms-transform:rotate(180deg);transform:rotate(180deg)}.lp_mobile #lpChat>.lp_minimized.lp_top-right,.lp_tablet #lpChat>.lp_minimized.lp_top-right{top:5%}.lp_mobile #lpChat>.lp_minimized.lp_bottom-right,.lp_tablet #lpChat>.lp_minimized.lp_bottom-right{top:52%}.lp_mobile #lpChat>.lp_minimized.lp_bottom-left,.lp_tablet #lpChat>.lp_minimized.lp_bottom-left{top:52%;right:auto;left:0;-ms-transform:rotate(180deg);transform:rotate(180deg)}.lp_mobile #lpChat>.lp_minimized.lp_bottom-left .lp_notification_number,.lp_tablet #lpChat>.lp_minimized.lp_bottom-left .lp_notification_number{-ms-transform:rotate(180deg);transform:rotate(180deg)}.lp_mobile #lpChat>.lp_minimized.lp_middle-left,.lp_tablet #lpChat>.lp_minimized.lp_middle-left{top:30%;right:auto;left:0;-ms-transform:rotate(180deg);transform:rotate(180deg)}.lp_mobile #lpChat>.lp_minimized.lp_middle-left .lp_notification_number,.lp_tablet #lpChat>.lp_minimized.lp_middle-left .lp_notification_number{-ms-transform:rotate(180deg);transform:rotate(180deg)}.lp_mobile #lpChat>.lp_minimized>.lp_main,.lp_tablet #lpChat>.lp_minimized>.lp_main{height:100%}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_header,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_header{direction:ltr;border-radius:5px 0 0 5px}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_header button,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_header button{width:100%;text-align:center}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_header button.lp_close,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_header button.lp_close{padding-top:8px}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_header button.lp_maximize,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_header button.lp_maximize{margin:31px 0 0 3px;padding:4px 0 10px 0;width:84%;-ms-transform:rotate(270deg);transform:rotate(270deg);outline:none}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_header .lp_title,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_header .lp_title{padding:0;position:absolute;top:63%;left:-30px;width:100px;white-space:nowrap;-ms-transform:rotate(270deg);transform:rotate(270deg)}.lp_mobile #lpChat>.lp_minimized>.lp_main>.lp_header .lp_title .lp_top-text,.lp_tablet #lpChat>.lp_minimized>.lp_main>.lp_header .lp_title .lp_top-text{max-width:94px}.lp_desktop #lpChat{font-size:13px}.lp_desktop #lpChat>*{width:280px;z-index:99999999;position:fixed;right:20px;bottom:0}.lp_desktop #lpChat>* .lp_header{height:36px;padding:0px 5px}.lp_desktop #lpChat>* .lp_header button{z-index:99999999;top:6px}.lp_desktop #lpChat>.lp_maximized{height:400px}.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_title{float:left;padding-top:9px;padding-left:3px}.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_header-content-wrapper .lp_header-buttons-container{float:right;direction:ltr !important;font-size:0}.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_header-content-wrapper button{position:relative}.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_header-content-wrapper button.lp_close,.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_header-content-wrapper button.lp_minimize{display:inline-block}.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_header-content-wrapper .lp_slider{position:absolute;left:5px;top:5px;width:22px;height:22px}.lp_desktop #lpChat>.lp_maximized>.lp_header .lp_header-content-wrapper .lp_slider_gap{margin-left:20px}.lp_desktop #lpChat>.lp_maximized>.lp_main{height:auto;top:36px}.lp_desktop #lpChat>.lp_maximized.lp_external-window{border-radius:0;position:absolute;left:0;right:0;bottom:0;top:0;width:100%;height:100%;margin:0 auto;max-width:600px}.lp_desktop #lpChat>.lp_maximized.lp_external-window>.lp_header .lp_close,.lp_desktop #lpChat>.lp_maximized.lp_external-window>.lp_header .lp_minimize{display:none}.lp_desktop #lpChat>.lp_maximized.lp_external-window.lp_no-top>.lp_header{display:none}.lp_desktop #lpChat>.lp_maximized.lp_external-window.lp_no-top>.lp_main{top:0}.lp_desktop #lpChat>.lp_minimized{height:36px}.lp_desktop #lpChat>.lp_minimized .lp_header .lp_title{float:left;padding-top:9px;padding-left:7px;width:auto}.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper .lp_header-buttons-container{float:right;direction:ltr !important;font-size:0}.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper button{position:relative}.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper button.lp_close,.lp_desktop #lpChat>.lp_minimized .lp_header .lp_header-content-wrapper button.lp_maximize{display:inline-block}.lp_desktop #lpChat>.lp_minimized>.lp_main{width:100%;height:100%}.lp_desktop #lpChat .lp_maximized .lp_notification_number.wsdkNotification{text-align:center;display:table;border-collapse:collapse;width:100%;height:100%;cursor:default;float:left;overflow:visible;border-radius:50%;background-color:#ed1c24;width:20px;height:20px;font-size:0.7em;z-index:1000;margin:7px 8px;margin-left:15px;text-indent:-1px}.lp_desktop #lpChat .lp_maximized .lp_notification_number.wsdkNotification>*{vertical-align:middle;display:table-cell}.lp_desktop #lpChat .lp_maximized .lp_notification_number.wsdkNotification .lp_notification_text{text-align:center;color:white;border-radius:inherit}.lp_mobile #lpChat{font-size:14px}.lp_mobile #lpChat .lp_maximized .lp_header .lp_slider{left:40px}.lp_mobile #lpChat .lp_maximized .lp_notification_number.wsdkNotification{text-align:center;display:table;border-collapse:collapse;width:100%;height:100%;cursor:default;float:left;overflow:visible;border-radius:50%;background-color:#ed1c24;width:20px;height:20px;font-size:0.7em;margin:7px 8px;z-index:1000;text-indent:-1px;position:absolute;left:60px;top:8px}.lp_mobile #lpChat .lp_maximized .lp_notification_number.wsdkNotification>*{vertical-align:middle;display:table-cell}.lp_mobile #lpChat .lp_maximized .lp_notification_number.wsdkNotification .lp_notification_text{top:4px;position:absolute;width:20px;height:20px;text-align:center;color:white;border-radius:inherit}.lp_tablet #lpChat{font-size:18px}.lp_tablet #lpChat>.lp_minimized{top:38%;height:24%}.lp_tablet #lpChat>.lp_minimized.lp_bottom-right,.lp_tablet #lpChat>.lp_minimized.lp_bottom-left{top:auto;bottom:5%}.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_title .lp_top-text{max-width:250px}.lp_tablet #lpChat>.lp_maximized .lp_header .lp_header-content-wrapper .lp_slider{left:40px}.lp_tablet #lpChat>.lp_maximized.lp_webview-window>.lp_header .lp_header-content-wrapper .lp_minimize{display:block}.lp_tablet #lpChat .lp_maximized .lp_notification_number.wsdkNotification{text-align:center;display:table;border-collapse:collapse;width:100%;height:100%;cursor:default;float:left;overflow:visible;border-radius:50%;background-color:#ed1c24;width:25px;height:25px;font-size:0.6em;margin:7px 8px;z-index:1000;text-indent:-1px;position:absolute;left:60px;top:21px}.lp_tablet #lpChat .lp_maximized .lp_notification_number.wsdkNotification>*{vertical-align:middle;display:table-cell}.lp_tablet #lpChat .lp_maximized .lp_notification_number.wsdkNotification .lp_notification_text{position:absolute;width:25px;height:25px;top:5px;text-align:center;color:white;border-radius:inherit}.lp_mobile.lp_landscape #lpChat>.lp_minimized{top:16%;height:67%}.lp_mobile.lp_landscape #lpChat>.lp_minimized .lp_main .lp_header .lp_title{top:53%}.lp_mobile.lp_landscape #lpChat>.lp_minimized .lp_main .lp_header .lp_title .lp_top-text{max-width:63px}.lp_tablet.lp_landscape #lpChat>.lp_minimized{top:34%;height:32%}.lp_tablet.lp_landscape #lpChat>.lp_minimized .lp_main .lp_header .lp_title{top:53%}.lp_tablet.lp_landscape #lpChat>.lp_minimized .lp_main .lp_header .lp_title .lp_top-text{max-width:63px}.lp_tablet.lp_landscape #lpChat>.lp_minimized.lp_top-right,.lp_tablet.lp_landscape #lpChat>.lp_minimized.lp_top-left{top:5%}.lp_tablet.lp_landscape #lpChat>.lp_minimized.lp_bottom-right,.lp_tablet.lp_landscape #lpChat>.lp_minimized.lp_bottom-left{top:auto;bottom:5%}',{id:Qa.STYLE_TAG_ID})}function fa(a){var b=document.createElement(\"iframe\");a.appendChild(b);return b.contentWindow.document}function ga(){clearTimeout(La)}function ha(a){var b=Qa.WRAPPER_DIV_CSS_CLASS_PREFIX;if(a.landscape){Sa.removeClass(ua,b+Qa.PORTRAIT_CSS_CLASS);Sa.addClass(ua,b+Qa.LANDSCAPE_CSS_CLASS)}else{Sa.removeClass(ua,b+Qa.LANDSCAPE_CSS_CLASS);Sa.addClass(ua,b+Qa.PORTRAIT_CSS_CLASS)}}function ia(){Sa.addClass(xa,Qa.EXTERNAL_CSS_CLASS)}function ja(){Xa.NativeSDK&&Sa.addClass(xa,Qa.WEBVIEW_CSS_CLASS)}function ka(a){document.documentElement.setAttribute(\"lang\",a)}function la(a){var b=a.getStyle(\"top\",\"border-radius\");if(b){wa.style.borderRadius=b;xa.style.borderRadius=b}}var ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa=\"WrapperWindow\",Pa=lpTag.unifiedWindow,Qa={STYLE_TAG_ID:\"lpChatStyle\",WRAPPER_DIV_ID:\"lpChat\",WRAPPER_DIV_CSS_CLASS_PREFIX:\"lp_\",MOBILE_CSS_CLASS:\"mobile\",TABLET_CSS_CLASS:\"tablet\",DESKTOP_CSS_CLASS:\"desktop\",ANDROID_CSS_CLASS:\"android\",IOS_CSS_CLASS:\"ios\",IOS6_CSS_CLASS:\"ios6\",IOS8_OR_ABOVE_CSS_CLASS:\"ios8_or_above\",MAC_OSX_CSS_CLASS:\"mac_osx\",NATIVE_CSS_CLASS:\"native_android\",EXTERNAL_CSS_CLASS:\"lp_external-window\",WEBVIEW_CSS_CLASS:\"lp_webview-window\",PORTRAIT_CSS_CLASS:\"portrait\",LANDSCAPE_CSS_CLASS:\"landscape\",MINIMIZED_VIEW_IFRAME_RENDERING:!1,MAXIMIZED_VIEW_IFRAME_RENDERING:!1,WAIT_INDICATION_DELAY:250},Ra=Pa.language,Sa=lpTag.taglets.lpUtil,Ta=Pa.log,Ua={CONNECTION_UNAVAILABLE:{title:Ra.getString(\"couldNotConnect\"),imgUrl:\"connect-error-dark.png\",text:Ra.getString(\"connectionUnavailable\"),error:!0},RIP:{title:Ra.getString(\"error\"),imgUrl:\"connect-error-dark.png\",text:Ra.getString(\"chatEndedOnExternalWindow\"),error:!0},EXTERNAL_OPEN:{title:Ra.getString(\"error\"),imgUrl:\"connect-error-dark.png\",text:Ra.getString(\"externalWindowOpen\"),error:!0},UNSUPPORTED:{title:Ra.getString(\"error\"),imgUrl:\"connect-error-dark.png\",text:Ra.getString(\"unsupportedBrowserMode\"),error:!0},IN_SESSION:{title:Ra.getString(\"error\"),imgUrl:\"connect-error-dark.png\",text:Ra.getString(\"cannotResumeChat\"),error:!0},CROSS_DOMAIN_ERROR:{title:Ra.getString(\"error\"),imgUrl:\"connect-error-dark.png\",text:Ra.getString(\"crossDomainError\"),error:!0},AUTH_ERROR:{title:Ra.getString(\"error\"),imgUrl:\"thank-you-dark.png\",text:Ra.getString(\"chatAuthError\"),error:!0},SESSION_EXPIRED:{title:Ra.getString(\"sessionExpired\"),imgUrl:\"embedded-error.png\",text:Ra.getString(\"sessionError\"),error:!0},WAIT:{title:Ra.getString(\"loading\"),imgUrl:\"loader_on_warmGray5_75.gif\",imgAltText:Ra.getString(\"loading\")}},Va=!1,Wa=!1;sa=Sa.objectKeys(Ua);var Xa={isMaximized:!0};T(a,b,c,d,e);return{render:r,show:p,hide:q,message:l,removeMessage:N,unbindDomEvents:L,setTitle:m,setTemporaryTitle:n,removeTemporaryTitle:o,Messages:sa,getMinimizedElement:t,getBufferStripElement:u,getMaximizedElement:v,getMainWindowElement:s,getChatWrapperElement:w,getSliderButton:x,getWidgetNotificationContainer:y,getWidgetNotificationText:z,getTitleDiv:A,getChattingWIthIcon:B,dispose:G,showClose:C,showMinimized:D,getIconRepository:O,adjustConfigStyle:E,adjustWindowHeight:F}};window.lpTag=window.lpTag||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.defaultDictionary={error:\"Error\",couldNotConnect:\"Oops - unable to connect.\",tryAgain:\"Try again\",loadingOnMinimize:\"Loading\",loading:\"Loading\",unableToConnect:\"Unable to connect\",reconnect:\"Trying to reconnect\",chatEndedOnExternalWindow:\"Close window in order to start new chat\",externalWindowOpen:\"You have an ongoing chat. Return to that window to continue the chat.\",unsupportedBrowserMode:\"Your browser may be in incognito mode, or it may be blocking third party cookies. Please open a regular browser session to chat, or check your browser privacy settings\",cannotResumeChat:\"Resume chat from the tab where the interaction began\",crossDomainError:\"Cannot resume conversation, please return to previous page to continue.\",chatAuthError:\"You are no longer authenticated. Log in again to view the conversation.\",connectionUnavailable:\"Connection unavailable\",sessionExpired:\"Session expired\",sessionError:\"Your session has expired. Please close this window and start a new conversation in order to resume.\",tooltip_Close:\"Close\",tooltip_Minimize:\"Minimize\",tooltip_open_widgets:\"Open widgets\",tooltip_close_widgets:\"Close widgets\",tooltip_refresh_slider:\"Refresh\"};window.lpTag=window.lpTag||{};lpTag.taglets=lpTag.taglets||{};lpTag.unifiedWindow=lpTag.unifiedWindow||{};lpTag.unifiedWindow.apps=lpTag.unifiedWindow.apps||{UNIFIED_WINDOW:\"lpUnifiedWindow\"};lpTag.taglets.lpUnifiedWindow=lpTag.taglets.lpUnifiedWindow||function(){function a(a){var e;_a.setLogLevel(\"DEBUG\");a&&a.constructor===Array?d(a):eb=a||eb;Ka=new lpTag.unifiedWindow.AppConfigurationManager({lpTag:lpTag,utils:lpTag.taglets.lpUtil});X(eb);eb.caoOriginationUrl||(eb.caoOriginationUrl=window.location.href);eb.caoTitle||(eb.caoTitle=document.title);_a.init({debug:eb.debug||\"1\"===eb.lpDebug});_a.info(\"init\",Ya);Ha=window.lpTag.taglets.lpSecureStorage;Na=new $a.DeviceDetector;ka(eb,cb);Ma=new $a.BrowserStateManager(Na);Ga=new lpTag.unifiedWindow.Events({eventBufferLimit:0,cloneEventData:!1});_a.info(\"init: initial configuration: \"+JSON.stringify(eb),Ya);p();ma();e=c(eb);e?la(e,!0):b()}function b(){var a;if(eb.crossDomainEnabled){_a.info(\"Configuring secure storage using _chosenStorageHandler\",Ya);a=f}else{o();_a.info(\"Configuring secure storage using _initByStorage\",Ya);a=m}eb.urlBasedSession=!0;var b={debug:eb.debug};b[lb]={site:eb.accountId,providerId:eb.providerId,env:eb.env,asyncStorageMaxRetry:15,app:lb,url:eb.secureStorageLocation,chosenStorageHandler:a};Ha.configure(b)}function c(a){var b;a.invalidAuthConnector?b=La.Messages.SESSION_EXPIRED:a.JsLoadingFailure?b=La.Messages.CONNECTION_UNAVAILABLE:\"#RIP\"===window.location.hash&&(b=La.Messages.RIP);return b}function d(a){try{ab.convertConfig(a,eb)}catch(a){_a.error(\"Failed to parse taglet configuration\",Ya)}eb.displayShortlyMessage=e()}function e(){var a=eb.textCustomization&&eb.textCustomization[0]&&eb.textCustomization[0].displayShortlyMessage;return!0===a||\"true\"===a}function f(a){var b=lpTag.taglets.lpSecureStorage.errorTypes||{};a&&a.error===b.CROSS_DOMAIN?la(La.Messages.CROSS_DOMAIN_ERROR,!0):q(a,m.bind(this,a))}function g(a){_a.info(\"started flow: \"+JSON.stringify(a),Ya);a.redirect||void 0!==eb.embeddedSupported?h(a):eb.startedEngConf=a}function h(a){_a.info(\"clicked: \"+JSON.stringify(a),Ya);var b=JSON.parse(JSON.stringify(a));eb.caoOriginationUrl=window.location.href;eb.caoTitle=document.title;_();aa();ba();ca();da();ea();fa();ga();ha();ia();ja(b.lpVars);b.lpVars=void 0;if(qb){i();j(I(b))}else if(Ma.isConnected()){Ta&&Ta.methods&&Ta.methods.isDisposed()&&Ea();if(b.mtc&&u(b)){Y(b.referenceId);s(b);Ga.trigger({appName:Ya,eventName:\"smsClientLaunch\",global:!0})}else if(v(b)){t(b);Ga.trigger({appName:Ya,eventName:\"externalWindowOpened\",global:!0})}else{if(eb.browserModeUnSupported){la(La.Messages.UNSUPPORTED,!0);return}p();j(I(b))}}else la(La.Messages.CONNECTION_UNAVAILABLE)}function i(){$a.Application&&Ta&&Ta.methods&&!Ta.methods.isDisposed()&&Ga.trigger({appName:Ya,eventName:\"maximize\"})}function j(a,b){if(eb.crossDomainEnabled){b&&p();q(null,function(){Ja.getState(a,a)})}else{o();Ja.getState(a,a)}}function k(){_a.info(\"inspect\",Ya);return{conf:eb}}function l(a,b){j(b,!1)}function m(a){if(!vb){vb=!0;\"object\"!=typeof a?eb.secureStorageType=a:a&&a.error&&(eb.browserModeUnSupported=!0);Ia=a;eb.popoutSupported=!1;eb.secureStorageType&&eb.secureStorageType!==Ha.storageTypes.SESSIONSTORAGE&&eb.secureStorageType!==Ha.storageTypes.STATICSESSIONSTORAGE&&!Na.isMobile()&&(eb.urlBasedSession=!1);eb.embeddedSupported=!!eb.secureStorageType;C()}}function n(){return Ia}function o(){Oa||(Oa=new $a.SessionCookieManager({getSelectedStorage:n,secureStorageLocation:eb.secureStorageLocation,accountId:eb.accountId,sessionId:eb.sessionId,external:eb.external,events:Ga,sessionTimeout:F(eb),echoedSessionTimeout:eb.sessionTimeout}));eb.sessionId=Oa.getSessionId();if(!eb.poppedOut&&!eb.external){eb.consumerId=lpTag.cookieMethods.readCookie(\"CAOCID\");if(!eb.consumerId){eb.consumerId=ab.getUID();var a=lpTag.domainUtil.getParentDomain(window.location.host);lpTag.cookieMethods.writeSessionCookie(\"CAOCID\",eb.consumerId,31557600,\"/\",a,!1,\"lax\")}}Ja||(Ja=new $a.StateAnalyzer({sessionId:eb.sessionId,accountId:eb.accountId,secureStorageLocation:eb.secureStorageLocation},Oa))}function p(){La||(La=new $a.WrapperWindow(eb,Na,Ma,Ba))}function q(a,b){Oa||(Oa=new $a.SessionManager({accountId:eb.accountId,sessionId:eb.sessionId,external:eb.external,events:Ga,secureStorageLocation:eb.secureStorageLocation,sessionTimeout:F(eb),echoedSessionTimeout:eb.sessionTimeout}));Oa.getSessionId(r.bind(this,a,b))}function r(a,b,c){eb.sessionId=c;Ja||(Ja=new $a.StateAnalyzer({sessionId:eb.sessionId,accountId:eb.accountId,secureStorageLocation:eb.secureStorageLocation,crossDomainEnabled:eb.crossDomainEnabled},Oa));ab.runCallback(b,null,a)}function s(a){_a.info(\"_openWindowForSMSClientLaunch\",Ya);var b=\"menubar=no, location=no, resizable=false, scrollbars=no, status=yes, width=280px, height=400px, modal=true\",c=\"\";if(a.abc&&a.abc.businessId&&Na.isIOS113OrAbove())c=\"https://bcrw.apple.com/urn:biz:\"+a.abc.businessId;else{var d={launchProperties:G(a.mtc),mtcAPI:lpTag.taglets.caoServiceMap.getDomain(kb.MTC)};c=Ka.getSMSClientLaunchResourceURL(a,eb,d)}Na.isChromeIOS()?window.location.href=c:eb.openedExternal=window.open(c,a.target+\"POP\",b)}function t(a){_a.info(\"_openWindow\",Ya);var b=a.channel===ib.MTC?nb.MTC:nb.CHAT,c=\"menubar=no, location=no, resizable=false, scrollbars=no, status=yes, width=280px, height=\"+b+\"px, modal=true\",d=Ka.getExternalResourceURL(a,eb);lpTag.taglets.shiftDigitalAnalytics&&(d=lpTag.taglets.shiftDigitalAnalytics.getShiftDigitalUrl(d));a.redirect||y()&&w()?window.location.href=d:eb.openedExternal=window.open(d,a.target+\"POP\",c)}function u(a){return a.channel===ib.MTC&&(!a.departmentSelector||!a.departmentSelector.mtcEnabled||a.abc&&a.abc.businessId&&Na.isIOS113OrAbove())&&!a.mtc.tapToTextDisabled&&Na.canAttemptSMSClientLaunch()}function v(a){return!eb.embeddedSupported||a.isPopOut||w()||Ka.isRecaptchaEnabled()||x()}function w(){return!Na.isMobileOptimized()&&!Na.isDesktop()}function x(){return Na.isSafari()&&eb.secureStorageType==Ha.storageTypes.COOKIE}function y(){return eb.startedEngConf}function z(){return pb.caoEngagementConfig}function A(){return pb.caoTransferToken&&pb.caoReferenceId}function B(){return pb.lpaEngagementId}function C(){_a.info(\"_manage\",Ya);Ja.getState(H,H)}function D(a,b,c){if(E()){_a.info(\"_clickStateCallback: external / popped out window is open\",Ya);la(La.Messages.EXTERNAL_OPEN,!0)}else{eb.poppedOut&&(b=Ja.state.IN_SESSION);Va=b;switch(b){case Ja.state.INVALID:_a.info(\"_clickStateCallback: is INVALID state, nothing to do\",Ya);la(La.Messages.IN_SESSION);return;case Ja.state.IN_SESSION:return{uiState:a,requestedState:c};case Ja.state.NOT_STARTED:return c?{engConf:c}:void 0;case Ja.state.EXPIRED:Ca();return null}_a.error(\"_resolveProperStates: BUG - undefined state\",Ya)}}function E(){if(eb.openedExternal){if(!eb.openedExternal.closed)return!0;eb.openedExternal=void 0;delete eb.openedExternal}return!1}function F(a){var b,c=Na.getDeviceFamilyName().toLowerCase();b=a&&a.chatSessionTimeout&&a.chatSessionTimeout[c]?a.chatSessionTimeout[c]:Na.isMobile()?mb.MOBILE:Na.isTablet()?mb.TABLET:mb.DESKTOP;return b}function G(a){var b={};b.phoneNumber=\"+\"+a.phoneNumber;if(a.message&&\"\"!==a.message){var c=decodeURIComponent(a.message);Na.isIOS()?Na.isIOS8OrAbove()?b.message=\"&body=\"+c:b.message=\";body=\"+c:b.message=\"?body=\"+c}else b.message=\"\";return b}function H(a,b){_a.info(\"_startStateCallback\",Ya);var c=D(a,b);if(eb.external){c&&c.uiState&&c.uiState.chat&&c.uiState.chat.state===jb&&(c.uiState={engConf:c.uiState.engConf});R(c||eb)}else if(c)Ma.isConnected()?R(c):la(La.Messages.CONNECTION_UNAVAILABLE);else{y()&&h(eb.startedEngConf);if(z()){_a.info(\"_startStateCallback - direct link engagement detected\",Ya);try{h(JSON.parse(decodeURIComponent(pb.caoEngagementConfig)))}catch(a){_a.error(\"_startStateCallback - error handling direct link engagement: \"+a.message,Ya)}}A()&&h({isPopOut:!1,transferToken:pb.caoTransferToken,referenceId:pb.caoReferenceId,language:eb.language});if(B()){var d={id:pb.lpaEngagementId,onSuccess:function(a){h(a)},onFailure:function(){}};lpTag.sdk.exec(\"caoEngager.getEngagement\",d)}}}function I(a){return function(b,c){_a.info(\"_clickStateCallback\",Ya);var d=D(b,c,a);d&&R(d)}}function J(a){if(Ra&&Sa&&!0===gb&&fb&&!Ta){var b={window:Ra,merchant:Sa,unified:eb,uiState:a};_a.info(\"_loadingCompleted, config: \"+JSON.stringify(b),Ya);K(b);qb=!0}else _a.info(\"_loadingCompleted: still missing data/files\",Ya)}function K(a){if(eb.crossDomainEnabled)Oa.refresh(L.bind(this,a));else{Oa.refresh();L(a)}}function L(a){if(!rb){Ta=$a.Application(a,{appConfigurationManager:Ka,browserStateManager:Ma,sessionManager:Oa,deviceDetector:Na,wrapperWindow:La,events:Ga});rb=!0}a.uiState&&a.uiState.requestedState&&(ub?xa(a.uiState.requestedState):Xa=a.uiState.requestedState)}function M(a){_a.info(\"_createWindowConfigLoaded\",Ya);return function(b){_a.info(\"_windowConfigLoaded\",Ya);if(b&&!b.error){Ra=b;J(a)}else{la(La.Messages.CONNECTION_UNAVAILABLE);_a.error(\"_windowConfigLoaded: Cannot load configuration\",Ya)}}}function N(a){_a.info(\"_createAppLoaded\",Ya);return function(b){_a.info(\"_appLoaded\",Ya);if(b){la(La.Messages.CONNECTION_UNAVAILABLE);Ca();_a.error(\"_appLoaded: Cannot load application\",Ya)}else{gb=!0;J(a)}}}function O(a){_a.info(\"_createMerchantConfigLoaded\",Ya);return function(b){_a.info(\"_merchantConfigLoaded\",Ya);if(b&&!b.error){Sa=b;J(a)}else{la(La.Messages.CONNECTION_UNAVAILABLE);_a.error(\"_merchantConfigLoaded: Cannot load merchant configuration\",Ya)}}}function P(a,b){var c=Number(b);delete a.right;if(3===c||4===c){a.top=\"0px\";delete a.bottom}switch(c){case 2:case 3:a.left=\"20px\";break;case 1:a.left=document.body.clientWidth/2-140+\"px\";break;case 0:case 4:a.right=\"20px\";break;default:a.right=\"20px\"}}\nfunction Q(a,b){switch(Number(b)){case 4:a.className=\"lp_top-left\";break;case 5:a.className=\"lp_top-right\";break;case 1:a.className=\"lp_bottom-right\";break;case 2:a.className=\"lp_bottom-left\";break;case 0:a.className=\"lp_middle-right\";break;case 3:a.className=\"lp_middle-left\";break;default:a.className=\"lp_middle-right\"}}function R(a){_a.info(\"_startApplication\",Ya);var b;if(a.uiState){b=a.uiState;if(b.chat){eb.referenceId=b.chat.referenceId;eb.departmentRef=b.chat.departmentRef}else{eb.referenceId=b.engConf.referenceId;eb.departmentRef=b.engConf.departmentRef}b.requestedState=a.requestedState}else{Y(a.engConf.referenceId);Z(a.engConf.departmentRef);$(a.engConf.transferToken);a.engConf.preChatLines&&(a.engConf.preChatLines=Fa(a.engConf.preChatLines));b=ab.cloneExtend(cb);b.engConf=a.engConf;a.engConf&&a.engConf.minimiseOnStart&&(b.window.maximized=!1);P(b.window.position,a.engConf.windowPosition);Q(b.window.minMobilePosition,a.engConf.minimizedMobileWindowPosition)}eb.referenceId&&(eb.referenceId=eb.referenceId.toLowerCase());eb.departmentRef&&(eb.departmentRef=eb.departmentRef.toLowerCase());if(qb)b.requestedState&&xa(b.requestedState);else{La.render(b&&b.window,function(){fb=!0;La.message(La.Messages.WAIT);b.engConf.channel!==ib.MTC||!Na.isDesktop()||eb.poppedOut||eb.external||La.adjustWindowHeight(nb.MTC+\"px\");J(b)},!0);var c={sessionId:eb.sessionId,accountId:eb.accountId,departmentRef:eb.departmentRef,referenceId:eb.referenceId,providerId:eb.providerId,secureStorageLocation:eb.secureStorageLocation,domain:eb.acCdnDomain};b.engConf&&void 0!==b.engConf.lewid&&(c.windowId=b.engConf.lewid);Pa=new $a.WindowConfigurationManager(c);Pa.getConf(M(b));Qa=new $a.MerchantConfigurationManager(c);Qa.getConf(O(b),eb.referenceId,eb.departmentRef);V(N(b),b)}}function S(a){var b={},c=a.channel===ib.MTC&&!tb||!sb,d=a.async?\"/api/ams/UMSClientAPI.min.js\":a.channel===ib.MTC?\"/api/mtc/lpsunco/lpMtc.js\":\"/api/chat/lpsunco/lpChatV3.js\",e=Na.getDeviceFamilyName().toLowerCase();$a.Application&&!c||(b=eb.loadObj||{framework:eb.codeRepository+\"/ui-framework.js\"+bb,api:\"https://\"+eb.leCdnDomain+d+bb,surveyLogic:\"https://\"+eb.leCdnDomain+\"/api/survey_logic/surveylogicinstance.min.js\"+bb,unified:{dependency:[\"framework\",\"api\",\"surveyLogic\"],url:eb.codeRepository+\"/\"+e+\"Embedded.js\"+bb}});if(eb.poppedOut||eb.external||v(a)){var f=lpTag.taglets.caoServiceMap.getDomain(kb.TAG);lpTag.ovr=lpTag.ovr||{domain:f};lpTag.debug=eb.debug?\"2\":\"1\"}a&&a.language&&\"en-us\"!==a.language.toLowerCase()&&(b.lang=eb.langRepository+\"/\"+a.language+\".js\"+bb);eb.supportBlockCCPattern&&(eb.poppedOut||eb.external||v(a))&&T(\"cleanCCPatterns\",function(){_a.error(\"Error: Failed to load cleanCCPatterns taglet\",Ya)});!v(a)&&Ka.isAuthenticatedEnabled(a)&&(b.xhr=eb.codeRepository+\"/xhr.js\"+bb);b.widgetSDK=\"https://lpcdn.lpsnmedia.net/unifiedwindow/widgetSDK.min.js\"+bb;return b}function T(a,b){if(\"string\"==typeof a){Wa=Wa||[];Wa.push({name:a,error:b})}}function U(a,b){_a.info(\"_loadFramework, loading: \"+JSON.stringify(a),Ya);if(ab.isEmpty(a)){_a.info(\"_loadFramework: Application exists, starting\",Ya);ab.runCallback(b)}else{_a.info(\"_loadFramework: Loading files\",Ya);lpTag.taglets.jsLoader.loadJS({loadObj:a,success:function(){_a.info(\"_loadFramework: Files loaded\",Ya);ab.runCallback(b)},error:function(a){_a.error(\"_loadFramework: Error Loading files \"+JSON.stringify(a),Ya);ab.runCallback(b,null,a||{})}})}}function V(a,b){_a.info(\"_loadFramework\",Ya);var c=S(b.engConf);b&&b.window&&!1===b.window.embedded&&\"function\"==typeof lpTag.loadTaglets&&lpTag.loadTaglets(Wa);U(c,a)}function W(){var a=pb.lpVersion;return a&&eb.debug?\"/\"+a:Za?\"/\"+Za:\"\"}function X(a){_a.info(\"_setSiteAndDebug: \"+JSON.stringify(a),Ya);a.accountId=\"\"+(a.accountId||lpTag.site);a.providerId=\"\"+(a.providerId||lpTag.providerId);a.env=a.env||lpTag.env;a.domain=lpTag.taglets.caoServiceMap.getDomain(kb.API);a.asyncMessagingDomain=lpTag.taglets.caoServiceMap.getDomain(kb.ASYNC_MESSAGING);a.idpDomain=lpTag.taglets.caoServiceMap.getDomain(kb.IDP);a.crossDomainEnabled=!!Ka.getFeatureById(\"Common.LiveEngage_2_CrossDomainStorage\");(a.debug||a.accountId&&0===a.accountId.indexOf(\"qa\")||a.domain&&0===a.domain.indexOf(\"hc1\"))&&(a.debug=!0)}function Y(a){_a.info(\"_setReferenceId: \"+a,Ya);eb.referenceId=a||eb.referenceId}function Z(a){_a.info(\"_setDepartmentRef: \"+a,Ya);eb.departmentRef=a?a||eb.departmentRef:null}function $(a){_a.info(\"_setTransferToken: \"+a,Ya);eb.transferToken=a||eb.transferToken}function _(){lpTag&&lpTag.taglets&&lpTag.taglets.pcg&&(eb.pcgTrackingId=lpTag.taglets.pcg.getTrackingId())}function aa(){lpTag&&lpTag.taglets&&lpTag.taglets.merkle&&(eb.merkleChatInfo=lpTag.taglets.merkle.getChatInfo())}function ba(){if(lpTag&&lpTag.taglets&&lpTag.taglets.tealium){eb.tealiumChatInfo=lpTag.taglets.tealium.getChatInfo();eb.tealiumEnvironment=lpTag.taglets.tealium.getEnvironment()}}function ca(){lpTag&&lpTag.taglets&&lpTag.taglets.visualIQ&&(eb.visualIQImageUrl=lpTag.taglets.visualIQ.getImageUrl())}function da(){lpTag&&lpTag.taglets&&lpTag.taglets.pixall&&(eb.pixallChatInfo=lpTag.taglets.pixall.getChatInfo())}function ea(){lpTag&&lpTag.taglets&&lpTag.taglets.zmot&&(eb.zmotEnvironment=lpTag.taglets.zmot.getEnvironment())}function fa(){if(lpTag&&lpTag.taglets&&lpTag.taglets.googleAnalytics){eb.gaAgentSent=lpTag.taglets.googleAnalytics.getAgentMessageIsSent();eb.gaConsumerSent=lpTag.taglets.googleAnalytics.getConsumerMessageIsSent();eb.gaAgentAccepted=lpTag.taglets.googleAnalytics.getHasAgentAccepted();eb.gaClientId=lpTag.taglets.googleAnalytics.getGoogleAnalyticsClientIdFromGATracker()}}function ga(){if(lpTag&&lpTag.taglets&&lpTag.taglets.cdk){var a=lpTag.taglets.cdk.getConfig();eb.cdkWebId=a.webId;eb.cdkPartnerAccountName=a.cdkPartnerAccountName}}function ha(){if(lpTag&&lpTag.taglets&&lpTag.taglets.shiftDigitalAnalytics){var a=lpTag.taglets.shiftDigitalAnalytics.getTagServerLocation();eb.tagServerLocation=a}}function ia(){if(lpTag&&lpTag.taglets&&lpTag.taglets.googleAdsConversion){var a=lpTag.taglets.googleAdsConversion.getGoogleAdsConversionAwId();eb.googleAwId=a}}function ja(a){eb.vars=JSON.parse(JSON.stringify(lpTag.vars&&lpTag.vars[0]||[]));if(a&&a.length>0)for(var b=0;b<a.length;b++){for(var c=!1,d=a[b].name.toLowerCase(),e=0;e<eb.vars.length;e++)if(eb.vars[e].name.toLowerCase()===d){c=!0;eb.vars[e].value=a[b].value;break}c||eb.vars.push(a[b])}}function ka(a,b){var c,d;_a.info(\"_initDefaultValues: \"+JSON.stringify({conf:a,data:b}),Ya);a.leCdnDomain=a.leCdnDomain||lpTag.taglets.caoServiceMap.getDomain(kb.LECDN);a.acCdnDomain=a.acCdnDomain||lpTag.taglets.caoServiceMap.getDomain(kb.ACCDN);c=\"https://\"+a.leCdnDomain+\"/\";d=\"le_unified_window\"+W();a.codeRepository=c+(a.codeRepository?a.codeRepository:d);a.imagesRepository=c+(a.imagesRepository?a.imagesRepository:d+\"/resources\");a.iconsRepository=c+(a.iconsRepository?a.iconsRepository:d+\"/resources/icons\")+\"/\"+Na.getDeviceFamilyName().toLowerCase();a.audioRepository=c+(a.audioRepository?a.audioRepository:d+\"/resources/audio\");a.langRepository=c+(a.langRepository?a.langRepository:d+\"/resources/i18n\");a.agentImageRepository=c+(a.agentImageRepository?a.agentImageRepository:d+\"/resources/agentImages\");a.secureStorageLocation=a.external?Ha.sessionStorageStaticDomain:a.secureStorageLocation||c+\"le_secure_storage/\";Na.isMobile()&&!Na.isTablet()&&(b.position={right:0});b.window.embedded=!a.external;if(!b.window.embedded){a.NativeSDK=\"1\"==pb.sdk;a.IOS=\"1\"==pb.ios}a.supportBlockCCPattern=a.supportBlockCCPattern||lpTag.taglets.cleanCCPatterns&&b.window.embedded}function la(a,b){Ua&&clearTimeout(Ua);La.render(null,function(){La.message(a)});b||eb.poppedOut||eb.external||(Ua=setTimeout(function(){La&&La.dispose()},hb))}function ma(){Ma.on(Ma.EVENT_NAME.FOCUS_CHANGE,pa);Ga.bind({appName:\"ChatStateManager\",eventName:\"ended\",func:Ca});Ga.bind({appName:\"MtcStateManager\",eventName:\"ended\",func:Ba});Ga.bind({appName:\"Application\",eventName:\"appEnded\",func:Ea});Ga.bind({appName:\"*\",eventName:\"doHaraKiri(Seppuku)\",func:Da});Ga.bind({appName:\"SessionManager\",eventName:\"sessionChanged\",func:ta});Ga.bind({appName:\"ChatAPIV3\",eventName:\"error\",func:oa});Ga.bind({appName:\"API\",eventName:\"error\",func:oa});Ga.bind({appName:\"API\",eventName:\"initialized\",func:ra});Ga.bind({appName:\"ChatStateManager\",eventName:\"startChatInfo\",func:na})}function na(a){if(a.chatTimeout){_a.info(\"_updateChatTimeout : updating configuration with echoed chatTimeout = \"+a.chatTimeout,Ya);eb.sessionTimeout=a.chatTimeout}}function oa(a){la(La.Messages[a&&a.errorType]||La.Messages.CONNECTION_UNAVAILABLE,a&&a.keepError)}function pa(a){a.focus&&Va===db&&qa()}function qa(){if(eb.crossDomainEnabled){Oa=Oa||new $a.SessionManager({accountId:eb.accountId,sessionId:eb.sessionId,external:eb.external,events:Ga,secureStorageLocation:eb.secureStorageLocation,sessionTimeout:F(eb),echoedSessionTimeout:eb.sessionTimeout});Oa.getSessionCookie(sa)}else{Oa=Oa||new $a.SessionCookieManager({getSelectedStorage:n,secureStorageLocation:eb.secureStorageLocation,accountId:eb.accountId,sessionTimeout:F(eb),echoedSessionTimeout:eb.sessionTimeout});var a=Oa.getSessionCookie();if(a&&a[0]&&\"null\"!==a[0]){Oa=null;o();Ja.getState(wa,wa)}}}function ra(){ub=!0;Xa&&xa(Xa)}function sa(a){if(a&&a.sid&&\"null\"!==a.sid){Oa=null;j(wa,!0)}}function ta(){_a.info(\"_analyzeStateOnSessionChanged\",Ya);Oa&&ua()}function ua(){if(eb.crossDomainEnabled)Oa.getSessionCookie(va);else{var a=Oa.getSessionCookie();if(a&&a[0]&&\"null\"!==a[0]){Ca(!0);o();Ja.getState(wa,wa)}else Ca()}}function va(a){if(a&&a.sid&&\"null\"!==a.sid){Ca(!0);p();j(wa)}else Ca()}function wa(a,b){Va=b;switch(b){case Ja.state.INVALID:_a.info(\"_clickStateCallback: is INVALID state, nothing to do\",Ya);la(La.Messages.IN_SESSION);break;case Ja.state.IN_SESSION:Aa(a.engConf);break;case Ja.state.NOT_STARTED:Ea()}}function xa(a){if(a.referenceId&&a.referenceId.toLowerCase()!==eb.referenceId){if(a.departmentRef&&a.departmentRef.toLowerCase()===eb.departmentRef)return;ya(a)}else a.departmentRef&&a.departmentRef.toLowerCase()!==eb.departmentRef&&ya(a)}function ya(a){Qa.getConf(za(a),a.referenceId,a.departmentRef)}function za(a){_a.info(\"_createMerchantConfigLoaded\",\"lpUnifiedWindow\");return function(b){_a.info(\"_merchantConfigLoaded\",\"lpUnifiedWindow\");if(b&&!b.error){var c={context:this,data:{ControllerName:lpTag.unifiedWindow.SwitchMerchantDialogViewController.ControllerName,dialogOpenedFrom:\"lpUnifiedWindow\",requestedConfig:a,switchToMerchantConf:b}};Ga.trigger({appName:\"lpUnifiedWindow\",eventName:lpTag.unifiedWindow.events.application.SWITCH_MERCHANT_PROMPT,data:c});Ga.trigger({appName:\"lpUnifiedWindow\",eventName:lpTag.unifiedWindow.events.viewController.DIALOG,data:c})}else _a.error(\"_merchantConfigLoaded: Cannot load merchant configuration\",\"lpUnifiedWindow\")}}function Aa(a){Ea();h(a)}function Ba(a){_a.info(\"_seppuku\",Ya);Ca();Ea(a)}function Ca(a){qb=!1;Ua&&clearTimeout(Ua);Va=db;if(Oa){Oa.dispose(a);Oa=null}Ra=null;if(Pa){Pa.clear();Pa=null}if(Qa){Qa.clear();Qa=null}eb.sessionId=null;delete eb.sessionId;Ja=null}function Da(){La&&La.dispose()}function Ea(a){gb=!1;fb=!1;if(Ta){Ta.methods.end(a);Ta=null;rb=!1}La=null;Ga.trigger({appName:Ya,eventName:\"windowClosed\",global:!0});a&&a.terminationType===ob.SWITCH_MERCHANT&&setTimeout(function(){lpTag.sdk.exec(\"caoEngager.startChat\",a.engConf)},3e3)}function Fa(a){var b=0,c={};a.forEach(function(a){c[\"msg\"+ ++b]=a});return c}var Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya=\"lpUnifiedWindow\",Za=\"\",$a=lpTag.unifiedWindow,_a=$a.log,ab=lpTag.taglets.lpUtil,bb=\"?version=\"+(Za||(new Date).getTime().toString()),cb={window:{maximized:!0,position:{right:\"20px\",bottom:0},minMobilePosition:{className:\"lp_middle-right\"},sound:!0,notificationCount:0,actionsVisible:!1,embedded:!0}},db=3,eb={},fb=!1,gb=!1,hb=5e3,ib={CHAT:\"chat\",MTC:\"mtc\"},jb=\"applicationEnded\",kb={ADMIN_AREA:\"adminArea\",ALL:\"ALL\",LECDN:\"contentCDN\",ACCDN:\"contentCDN\",ASYNC_MESSAGING:\"asyncMessaging\",IDP:\"idp\",API:\"chatAPI\",MTC:\"mtcAPI\",TAG:\"tagDomain\"},lb=$a.apps.UNIFIED_WINDOW,mb={DESKTOP:120,MOBILE:120,TABLET:120},nb={CHAT:400,MTC:500},ob={SWITCH_MERCHANT:18},pb=ab.getURLParams(window.location.search),qb=!1,rb=!1,sb=!1,tb=!1,ub=!1,vb=!1;return{v:Za,name:Ya,init:a,startFlow:g,clicked:h,inspect:k,getWindowState:l,sdkDef:[{methodName:\"endChat\",func:Ba}]}}();window.lpTag=window.lpTag||{};lpTag.domainUtil=lpTag.domainUtil||function(){function a(a){a=\"\"+a;var b,f,g=null,h={top:null,country:null};a=c(a);b=a.split(\".\");if(b.length<3)return a;for(var i=b.length-1,j=i;j>-1;j--){e(b[j],h,j);if(null!==h.country&&null!==h.top)break}if(null!==h.top||null!==h.country){g=h.top;(null===g||null!==h.country&&h.country<g&&g-1===h.country)&&(g=h.country);f=g>0?g-1:g;return d(b.slice(f))}return a}function b(a){var b=c(a);return new RegExp(/^[a-z]{1}[a-z+|\\d+|_+|\\-|.]+[a-z]{1}$/gi).test(b)}function c(a,b){var c=new RegExp(/((?:http|ftp|ws){1}s{0,1}?:\\/\\/){0,1}([^\\/\\?/:]+)(\\/?)/gi),d=c.exec(a),e=null;if(d&&d.length>=3&&\"\"!==d[2]){e=d[2].toLowerCase();b&&(e=d[1]+e)}return e}function d(a){return a.join(\".\")}function e(a,b,c){a=\"\"+a;null===b.top&&(f.topLevelDomain[a]||f.customTopLevelDomain[a])?b.top=c:null===b.country&&f.countryTopLevelDomain[a]&&(b.country=c)}var f={customTopLevelDomain:{aero:\"aero\",asia:\"asia\",bike:\"bike\",biz:\"biz\",camera:\"camera\",cat:\"cat\",clothing:\"clothing\",coop:\"coop\",equipment:\"equipment\",estate:\"estate\",eus:\"eus\",gallery:\"gallery\",graphics:\"graphics\",guru:\"guru\",info:\"info\",int:\"int\",holdings:\"holdings\",jobs:\"jobs\",lighting:\"lighting\",mobi:\"mobi\",museum:\"museum\",name:\"name\",photography:\"photography\",plumbing:\"plumbing\",post:\"post\",pro:\"pro\",singles:\"singles\",tel:\"tel\",travel:\"travel\",ventures:\"ventures\",xxx:\"xxx\"},topLevelDomain:{ac:\"ac\",co:\"co\",com:\"com\",edu:\"edu\",gov:\"gov\",mil:\"mil\",net:\"net\",org:\"org\"},countryTopLevelDomain:{ac:\"ac\",ad:\"ad\",ae:\"ae\",af:\"af\",ag:\"ag\",ai:\"ai\",al:\"al\",am:\"am\",an:\"an\",ao:\"ao\",aq:\"aq\",ar:\"ar\",as:\"as\",at:\"at\",au:\"au\",aw:\"aw\",ax:\"ax\",az:\"az\",ba:\"ba\",bb:\"bb\",bd:\"bd\",be:\"be\",bf:\"bf\",bg:\"bg\",bh:\"bh\",bi:\"bi\",bj:\"bj\",bm:\"bm\",bn:\"bn\",bo:\"bo\",bq:\"bq\",br:\"br\",bs:\"bs\",bt:\"bt\",bv:\"bv\",bw:\"bw\",by:\"by\",bz:\"bz\",bzh:\"bzh\",ca:\"ca\",cc:\"cc\",cd:\"cd\",cf:\"cf\",cg:\"cg\",ch:\"ch\",ci:\"ci\",ck:\"ck\",cl:\"cl\",cm:\"cm\",cn:\"cn\",co:\"co\",cr:\"cr\",cs:\"cs\",cu:\"cu\",cv:\"cv\",cw:\"cw\",cx:\"cx\",cy:\"cy\",cz:\"cz\",dd:\"dd\",de:\"de\",dj:\"dj\",dk:\"dk\",dm:\"dm\",do:\"do\",dz:\"dz\",ec:\"ec\",ee:\"ee\",eg:\"eg\",eh:\"eh\",er:\"er\",es:\"es\",et:\"et\",eu:\"eu\",fi:\"fi\",fj:\"fj\",fk:\"fk\",fm:\"fm\",fo:\"fo\",fr:\"fr\",ga:\"ga\",gb:\"gb\",gd:\"gd\",ge:\"ge\",gf:\"gf\",gg:\"gg\",gh:\"gh\",gi:\"gi\",gl:\"gl\",gm:\"gm\",gn:\"gn\",gp:\"gp\",gq:\"gq\",gr:\"gr\",gs:\"gs\",gt:\"gt\",gu:\"gu\",gw:\"gw\",gy:\"gy\",hk:\"hk\",hm:\"hm\",hn:\"hn\",hr:\"hr\",ht:\"ht\",hu:\"hu\",id:\"id\",ie:\"ie\",il:\"il\",im:\"im\",in:\"in\",io:\"io\",iq:\"iq\",ir:\"ir\",is:\"is\",it:\"it\",je:\"je\",jm:\"jm\",jo:\"jo\",jp:\"jp\",ke:\"ke\",kg:\"kg\",kh:\"kh\",ki:\"ki\",km:\"km\",kn:\"kn\",kp:\"kp\",kr:\"kr\",\"krd:\":\"krd\",kw:\"kw\",ky:\"ky\",kz:\"kz\",la:\"la\",lb:\"lb\",lc:\"lc\",li:\"li\",lk:\"lk\",lr:\"lr\",ls:\"ls\",lt:\"lt\",lu:\"lu\",lv:\"lv\",ly:\"ly\",ma:\"ma\",mc:\"mc\",md:\"md\",me:\"me\",mg:\"mg\",mh:\"mh\",mk:\"mk\",ml:\"ml\",mm:\"mm\",mn:\"mn\",mo:\"mo\",mp:\"mp\",mq:\"mq\",mr:\"mr\",ms:\"ms\",mt:\"mt\",mu:\"mu\",mv:\"mv\",mw:\"mw\",mx:\"mx\",my:\"my\",mz:\"mz\",na:\"na\",nc:\"nc\",ne:\"ne\",nf:\"nf\",ng:\"ng\",ni:\"ni\",nl:\"nl\",no:\"no\",np:\"np\",nr:\"nr\",nu:\"nu\",nz:\"nz\",om:\"om\",pa:\"pa\",pe:\"pe\",pf:\"pf\",pg:\"pg\",ph:\"ph\",pk:\"pk\",pl:\"pl\",pm:\"pm\",pn:\"pn\",pr:\"pr\",ps:\"ps\",pt:\"pt\",pw:\"pw\",py:\"py\",qa:\"qa\",re:\"re\",ro:\"ro\",rs:\"rs\",ru:\"ru\",rw:\"rw\",sa:\"sa\",sb:\"sb\",sc:\"sc\",sd:\"sd\",se:\"se\",sg:\"sg\",sh:\"sh\",si:\"si\",sj:\"sj\",sk:\"sk\",sl:\"sl\",sm:\"sm\",sn:\"sn\",so:\"so\",sr:\"sr\",ss:\"ss\",st:\"st\",su:\"su\",sv:\"sv\",sx:\"sx\",sy:\"sy\",sz:\"sz\",tc:\"tc\",td:\"td\",tf:\"tf\",tg:\"tg\",th:\"th\",tj:\"tj\",tk:\"tk\",tl:\"tl\",tm:\"tm\",tn:\"tn\",to:\"to\",tp:\"tp\",tr:\"tr\",tt:\"tt\",tv:\"tv\",tw:\"tw\",tz:\"tz\",ua:\"ua\",ug:\"ug\",uk:\"uk\",us:\"us\",uy:\"uy\",uz:\"uz\",va:\"va\",vc:\"vc\",ve:\"ve\",vg:\"vg\",vi:\"vi\",vn:\"vn\",vu:\"vu\",wf:\"wf\",ws:\"ws\",ye:\"ye\",yt:\"yt\",yu:\"yu\",za:\"za\",zm:\"zm\",zr:\"zr\"}};return{v:\"1.1\",name:\"domainUtil\",getParentDomain:a,getDomain:c,isValidDomain:b}}();","parameters":null},{"name":"cleanCCPatterns","code":"window.lpTag=window.lpTag||{};window.lpTag.taglets=window.lpTag.taglets||{};window.lpTag.taglets.cleanCCPatterns=window.lpTag.taglets.cleanCCPatterns||function(){function a(a){i(\"init configuration\",\"INFO\");q=!0;d(a)}function b(a){\"string\"==typeof a&&Array.isArray(p)&&p.forEach(function(b){try{a=c(a,b)}catch(a){i(\"clean: clean execution failed\",\"ERROR\")}});return a}function c(a,b){var c=a;if(\"string\"==typeof a){var d,e,f;b.pattern.lastIndex=0;d=c.match(b.pattern)||[];for(var g=0;g<d.length;g++){f=d[g]||\"\";e=f.match(b.replacePattern)||[];for(var h=0;h<e.length;h++)f=f.replace(e[h],\"*\");c=c.replace(d[g],f)}}return c}function d(a){var b=[],c={};try{k.convertConfig(a,c)}catch(a){i(\"_setConfigParameters: Failed to convert configuration\",\"ERROR\")}c=c.ccPatterns&&c.ccPatterns[0];if(c){q=\"false\"!==c.useDefault&&!1!==c.useDefault;b=Array.isArray(c.patternsArray)?c.patternsArray:b}q&&b.push(n);p=e(b)}function e(a){var b=[];Array.isArray(a)&&a.forEach(function(a){a=f(a);a&&b.push(a)});return b}function f(a){var b,c,d;if(a&&\"string\"==typeof a.pattern){b=a.pattern;c=a.replacePattern||a.pattern}else{b=a;c=o}b=g(b);c=g(c);h(c)||(c=b);h(b)&&(d={pattern:b,replacePattern:c});return d}function g(a){var b;if(h(a))b=a;else if(\"string\"==typeof a){a=decodeURIComponent(a);var c,d,e=a.lastIndexOf(\"/\"),f=a.indexOf(\"/\");if(0===f&&e>f){c=a.slice(f+1,e);d=a.slice(e+1);d=d.replace(m,\"\");if(l.test(d))try{b=new RegExp(c,d)}catch(b){i(\"_getRegexFromString: failed create regex: \"+a,\"ERROR\")}else i(\"_getRegexFromString: regex flags are invalid: \"+a,\"ERROR\")}else i(\"_getRegexFromString: regex pattern is not valid: \"+a,\"ERROR\")}return b}function h(a){return a&&a.constructor===RegExp}function i(a,b){lpTag.log&&lpTag.log(a,b,j)}var j=\"cleanCCPatterns\",k=lpTag.taglets.lpUtil,l=/^[gmi]{0,3}$/,m=/(.)(?=.*\\1)/g,n=/(?:4[0-9]{3}((([-\\s.]*[0-9]{4}){3})|(([-\\s.]*[0-9]{3}){3}))|5[1-5][0-9]{2}([-\\s.]*[0-9]{4}){3}|6(?:011|5[0-9]{2})([-\\s.]*[0-9]{4}){3}|3[47][0-9]{2}[-\\s.]*[0-9]{6}[-\\s.]*[0-9]{5}|3(?:0[0-5]|[68][0-9])[0-9][-\\s.]*[0-9]{6}[-\\s.]*[0-9]{4}|((?:2131|1800)[-\\s.]*[0-9]{6}[-\\s.]*[0-9]{5})|(35[0-9]{2}([-\\s.]*[0-9]{4}){3}))/g,o=/[0-9]/g,p=[],q=!0;return{version:\"1.5\",name:j,init:a,clean:b}}();","parameters":null},{"name":"lpTransporter","code":"window.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n/**\r\n * @fileOverview Contains utilities for the lpajax system - core and transports\r\n *\r\n * @author Efim Dimenstein\r\n * @version 0.1 - 2012-08-20\r\n */\r\n/**\r\n * Contains utilities for the lpajax system - core and transports\r\n *\r\n * @namespace - contains the transport logic\r\n */\r\nlpTag.taglets.lpajax_utils = {\r\n    /**\r\n     * The name of the object\r\n     * @type String\r\n     */\r\n    _name : 'lpajax_utils',\r\n    /**\r\n     * The version of the object\r\n     * @type String\r\n     */\r\n    _v : '0.1',\r\n    /**\r\n     * An `each` implementation, aka `forEach`<br>\r\n     * Handles objects with the built-in `forEach`, arrays, and raw objects<br>\r\n     * Delegates to **ECMAScript 5**'s native `forEach` if available\r\n     *\r\n     * @param {Object} obj list of elements\r\n     * @param {Object} iterator\r\n     * @param {Object} context\r\n     * @example\r\n     * lpTag.taglets.lpajax_utils.each([1, 2, 3], function(num){ alert(num); });\r\n     * result: alerts each number in turn...\r\n     * lpTag.taglets.lpajax_utils.each({one : 1, two : 2, three : 3}, function(num, key){ alert(num); });\r\n     * result: alerts each number in turn...\r\n     */\r\n    each : function(obj, iterator, context) {\r\n        if (obj == null) {return;}\r\n        var nativeForEach = Array.prototype.forEach;\r\n\r\n        if (nativeForEach && obj.forEach === nativeForEach) {\r\n            obj.forEach(iterator, context);\r\n        }\r\n        else if (obj.length === +obj.length) {\r\n            for (var i = 0, l = obj.length; i < l; i++) {\r\n                if (i in obj && iterator.call(context, obj[i], i, obj) === {}) {return;}\r\n            }\r\n        } else {\r\n            for (var key in obj) {\r\n                if (Object.prototype.hasOwnProperty.call(obj, key)) {\r\n                    if (iterator.call(context, obj[key], key, obj) === {}) {return;}\r\n                }\r\n            }\r\n        }\r\n    },\r\n    /**\r\n     * Copy all of the properties in the source objects over to the destination object, and return the destination object.<br>\r\n     * It's in-order, so the last source will override properties of the same name in previous arguments\r\n     *\r\n     * @param {Object} obj a request object (see lpAjax for detailed description)\r\n     * @example\r\n     * lpTag.taglets.lpajax_utils.extend(destination, *sources)\r\n     * lpTag.taglets.lpajax_utils.extend({name : 'moe'}, {age : 50});\r\n     * result: {name : 'moe', age : 50}\r\n     */\r\n    extend : function(obj) {\r\n        this.each(Array.prototype.slice.call(arguments, 1), function(source) {\r\n            for (var prop in source) {\r\n                obj[prop] = source[prop];\r\n            }\r\n        });\r\n        return obj;\r\n    },\r\n    /**\r\n     * Method to check if object is empty<br>\r\n     *\r\n     * @param {Object} o any object\r\n     * @returns true if object is empty and false otherwise\r\n     * @example\r\n     * lpTag.taglets.lpajax_utils.isEmptyObj({}) - return true\r\n     * lpTag.taglets.lpajax_utils.isEmptyObj({name : 'moe'}); - return false\r\n     */\r\n    isEmptyObj: function( o ) {\r\n        for (var n in o ) {\r\n            return false;\r\n        }\r\n        return true;\r\n    },\r\n\r\n    init : function(){\r\n\r\n    }\r\n};\r\n\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n/**\r\n * lpAjax namespace\r\n * @namespace - contains the lpAjax logic\r\n */\r\nlpTag.taglets.lpAjax = lpTag.taglets.lpAjax || (function (window) {\r\n    var version = \"1.1.3\",\r\n        name = \"lpAjax\",\r\n        containerName = \"lpTransporter\",\r\n        _transports = {},\r\n        isInit = false,\r\n        logTypes = { ERROR: \"ERROR\", DEBUG: \"DEBUG\", INFO: \"INFO\", METRICS:\"METRICS\"},\r\n        rndUID  = \"lpT\" + Math.floor(Math.random() * 100000) + \"_\" + Math.floor(Math.random() * 1000000);\r\n\r\n    function init() {\r\n        isInit = true;\r\n    }\r\n\r\n    function _log(msg, type) {\r\n        if (window.lpTag && lpTag.log) {\r\n            lpTag.log(msg, type, name);\r\n        }\r\n    }\r\n\r\n    function addTransport(name, transport) {\r\n        if(!_transports[name]) {\r\n            _transports[name] = transport;\r\n            _log(\"Added transport: \" + name, logTypes.DEBUG);\r\n        }else{\r\n            _log(\"Existing transport: \" + name + \" tried to register\", logTypes.DEBUG);\r\n        }\r\n    }\r\n\r\n    function issueCall(request) {\r\n        if (!isInit) { init(); }\r\n\r\n        var tname = 'unknown';\r\n\r\n        try {\r\n            var transport = _chooseTransport(request);\r\n            if(transport){\r\n                transport.issueCall(request);\r\n                return true;\r\n            }else{\r\n                _log(\"No Transport found to issueCall\", logTypes.ERROR);\r\n                runCallBack(logTypes.ERROR, request.error, { responseCode: 601, error: \"No Transport found to issueCall, request: \" + request.url, body: \"ERROR\" }, request.context);\r\n            }\r\n        }\r\n        catch (e) {\r\n            if (transport && transport.getName) {\r\n                tname = transport.getName();\r\n            }\r\n            _log(\"Transport - \" + tname + \" - unknown exception while issueCall\", logTypes.ERROR);\r\n            runCallBack(logTypes.ERROR, request.error, { responseCode: 600, error: \"Transport - \" + tname + \" - unknown exception while issueCall: \" + request.url + \" e=\" + e, body: \"ERROR\" }, request.context);\r\n        }\r\n    }\r\n\r\n    function configureTransports(confT) {\r\n        if (!isInit) { init(); }\r\n\r\n        for (var name in confT) {\r\n            var t = _transports[name];\r\n            if (t) {\r\n                t.configure(confT[name]);\r\n            }\r\n        }\r\n    }\r\n\r\n    function publishMetrics(rawDataObj){\r\n        if(rawDataObj && typeof rawDataObj === 'object') {\r\n            rawDataObj.appName = containerName;\r\n            rawDataObj.ts = new Date().getTime();\r\n            if(rawDataObj.tags && rawDataObj.tags.constructor === Array){\r\n                rawDataObj.tags.push({ pageId: rndUID });\r\n            }\r\n            _log(rawDataObj, logTypes.METRICS);\r\n        }\r\n    }\r\n\r\n    function _chooseTransport(reqObj) {\r\n        var foundT = false, index = -1;\r\n        var req;\r\n        for (var i=0; i<reqObj.transportOrder.length; i++) {\r\n            if(!foundT){\r\n                req = extend({} , reqObj);\r\n                var t = _transports[req.transportOrder[i]];\r\n                if (t && t.isValidRequest && t.isValidRequest(req)) {\r\n                    foundT = true;\r\n                    index = i;\r\n                }\r\n            }\r\n        }\r\n        if(foundT){\r\n            return _transports[req.transportOrder[index]];\r\n        }else{\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * An `each` implementation, aka `forEach`<br>\r\n     * Handles objects with the built-in `forEach`, arrays, and raw objects<br>\r\n     * Delegates to **ECMAScript 5**'s native `forEach` if available\r\n     * @param {Object} obj list of elements\r\n     * @param {Object} iterator\r\n     * @param {Object} context\r\n     * @example\r\n     * lpTag.taglets.lpajax_utils.each([1, 2, 3], function(num){ alert(num); });\r\n     * result: alerts each number in turn...\r\n     * lpTag.taglets.lpajax_utils.each({one : 1, two : 2, three : 3}, function(num, key){ alert(num); });\r\n     * result: alerts each number in turn...\r\n     */\r\n     function each(obj, iterator, context) {\r\n        if (obj == null) {return;}\r\n        var nativeForEach = Array.prototype.forEach;\r\n\r\n        if (nativeForEach && obj.forEach === nativeForEach) {\r\n            obj.forEach(iterator, context);\r\n        }\r\n        else if (obj.length === +obj.length) {\r\n            for (var i = 0, l = obj.length; i < l; i++) {\r\n                if (i in obj && iterator.call(context, obj[i], i, obj) === {}) {return;}\r\n            }\r\n        } else {\r\n            for (var key in obj) {\r\n                if (Object.prototype.hasOwnProperty.call(obj, key)) {\r\n                    if (iterator.call(context, obj[key], key, obj) === {}) {return;}\r\n                }\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * Copy all of the properties in the source objects over to the destination object, and return the destination object.<br>\r\n     * It's in-order, so the last source will override properties of the same name in previous arguments\r\n     *\r\n     * @param {Object} obj a request object (see lpAjax for detailed description)\r\n     * @example\r\n     * lpTag.taglets.lpajax_utils.extend(destination, *sources)\r\n     * lpTag.taglets.lpajax_utils.extend({name : 'moe'}, {age : 50});\r\n     * result: {name : 'moe', age : 50}\r\n     */\r\n     function extend(obj) {\r\n        each(Array.prototype.slice.call(arguments, 1),\r\n            function(source) {\r\n                for (var prop in source) {\r\n                    obj[prop] = source[prop];\r\n                }\r\n            }\r\n        );\r\n        return obj;\r\n    }\r\n\r\n    /**\r\n     * Runs the callback passed protected\r\n     * @param type - the function type for logging purposes\r\n     * @param callback - the function that needs to run\r\n     * @param data - the data passed on to that function\r\n     * @param context - the context if any ti run this in\r\n     */\r\n    function runCallBack(type, callback, data, context) {\r\n        if (typeof callback === 'function') {\r\n            try {\r\n                callback.call(context || null, data);\r\n                callback = null;\r\n            } catch (e) {\r\n                _log(\"runCallback: Exception in execution of callback, type :\" + type + \" e=[\" + e.message + \"]\", logTypes.ERROR);\r\n            }\r\n        } else {\r\n            _log(\"runCallBack: No callback, of type :\" + type, logTypes.INFO);\r\n        }\r\n    }\r\n\r\n\r\n    return {\r\n        getVersion: function () { return version; },\r\n        getName: function () { return name; },\r\n        init : init,\r\n        publishMetrics: publishMetrics,\r\n        issueCall : issueCall,\r\n        configureTransports : configureTransports,\r\n        addTransport : addTransport\r\n    };\r\n})(window);\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n/**\r\n * Generic layer for making JSONP requests\r\n * Accepts the following parameters on the requestObject:\r\n * url - request URL, should be the full URL as needed by the server\r\n * encoding - if encoding is needed (default is UTF 8)\r\n * success - method to get called back will always receive the data from the request\r\n * error - a method to call on error\r\n * callback - the parameter name expected in the URL by the replying service\r\n * callbackName -  the name of the function to CREATE. This is for REQUEST CACHING PURPOSES ONLY. IF YOU SUPPLY A REAL FUNCTION IT WILL BE OVERRIDDEN\r\n * retries - if there is no valid response, default is 2\r\n * timeout - default 10 seconds, can be set in seconds\r\n * context - the context we want the succes/error callbacks to run in, if not supplied will be null\r\n */\r\nlpTag.taglets.jsonp = lpTag.taglets.jsonp || (function (window) {//Pass in the window so it's a local variable in the scope\r\n\r\n    var defaults = { //Can be configured with configure public method\r\n            callback: 'cb', //default callback parameter on the URL\r\n            encoding: 'UTF-8',//default encoding for all our requests\r\n            timeout: 10000,//default timeout for unanswered requests\r\n            retries: 2,//default retry for unanswered requests\r\n            metricsCount: 100, //default dump interval of info to lpAjax about request timing\r\n            metricsTimeout : 60000 //Default time to send metrics even if count isn't reached\r\n        },\r\n        logTypes = { ERROR: \"ERROR\", DEBUG: \"DEBUG\", INFO: \"INFO\" },\r\n        initialised = true,\r\n        mURLlen = 2083,//The maximum URL length\r\n        cbPrefix = 'lpCb',//default prefix for all our callbacks\r\n        buffReq = {},//The request buffer for new requests\r\n        callCount = 0,//The total number of calls we've made\r\n        buffReqCount = 0,//The amount of requests in the buffer\r\n        pendReqCount = 0,//The pending requests already made\r\n        refusedCount = 0,//The number of requests refused due to none matching requirements\r\n        errCount = 0,//The error count\r\n        requestStats = [],//The statistical information we have per domain\r\n        errTOid,//The error checking timeout id\r\n        metricsTOId, // The metrics timeout id\r\n        cb = {},//The callback list we have\r\n        callbackSampleLength = _createCallbackName(true).length,\r\n        version = \"1.1.7\",\r\n        transportType = \"jsonp\";\r\n\r\n    /************************ PUBLIC METHODS ***************************/\r\n\r\n    function init() {\r\n        if(lpTag && lpTag.taglets && lpTag.taglets.lpAjax) {\r\n            try{\r\n                lpTag.taglets.lpAjax.addTransport(transportType, publicAPI);\r\n            }catch(exc){}\r\n        }\r\n        _setMetricsTimeout();\r\n    }\r\n\r\n    /**\r\n     * Sets the default configuration we want to use for requests,\r\n     * can be overridden on a request basis\r\n     * properties: callback, encoding, timeout , retries\r\n     * @param configurationObj\r\n     */\r\n    function configure(configurationObj) {\r\n        if (configurationObj) {\r\n            for (var key in configurationObj) {\r\n                if (defaults.hasOwnProperty(key) && configurationObj.hasOwnProperty(key)) {\r\n                    defaults[key] = configurationObj[key];\r\n                }\r\n            }\r\n        }\r\n        init();\r\n    }\r\n\r\n    /**\r\n     * Checks if this transport can handle the request\r\n     * @param reqObj\r\n     * @return {Boolean}\r\n     */\r\n    function isValidRequest(reqObj) {\r\n        var validRequest = false;\r\n        if (initialised && reqObj && reqObj.url) {\r\n            var callbackExists = false;\r\n            if(reqObj.callbackName && typeof reqObj.callbackName === 'string'){\r\n                if(cb[reqObj.callbackName] || window[reqObj.callbackName]){\r\n                    callbackExists = true;\r\n                    _log(\"Callback name already exists, cb=\" + reqObj.callbackName, logTypes.ERROR, \"isValidRequest\");\r\n                }\r\n            }\r\n            var totalLength;\r\n            try {\r\n                totalLength = _calculateRequestLength(reqObj);\r\n            } catch (e) {\r\n                _log(\"Could not evaluate the length  of the request, e=\" + e, logTypes.ERROR, \"isValidRequest\");\r\n                validRequest = false;\r\n            }\r\n            if (typeof(totalLength) !== 'undefined' && (totalLength < mURLlen && !callbackExists)) {\r\n                validRequest = true;\r\n            }\r\n            else {\r\n                _log(\"Request length too long or undefined, requestLength=\" + totalLength + \" ,maxLength=\" + mURLlen, logTypes.ERROR, \"isValidRequest\");\r\n            }\r\n        }\r\n        return validRequest;\r\n    }\r\n\r\n    /**\r\n     * Builds the call URL, Buffers the requests and runs requests\r\n     * @param reqObj\r\n     */\r\n    function issueCall(reqObj) {\r\n        var callUrl;\r\n        if (isValidRequest(reqObj)) {\r\n            reqObj = _setRequestDefaults(reqObj);\r\n            if(!reqObj.callbackName || typeof reqObj.callbackName !== 'string'){//Allow to send in a callbackName\r\n                reqObj.callbackName = cbPrefix + _createCallbackName();\r\n            }else{\r\n                reqObj.retries = 0;\r\n            }\r\n            callUrl = reqObj.url + (reqObj.url.indexOf('?') > -1 ? '&' : '?') + reqObj.callback + '=' + '' + reqObj.callbackName;\r\n            if(reqObj.data) {\r\n                callUrl += \"&\" + _convertDataToQueryParams(reqObj.data);\r\n            }\r\n            if(reqObj.query){\r\n                callUrl += \"&\" + _convertDataToQueryParams(reqObj.query);\r\n            }\r\n            reqObj.callUrl = callUrl;\r\n            if (_bufferRequest(reqObj)) {\r\n                _addToCallBackList(reqObj);\r\n                _sendRequests();\r\n            } else {//Log error for URL overflow\r\n                _log(\"URL request was too long and was not sent, url: \" + callUrl, logTypes.ERROR, \"issueCall\");\r\n            }\r\n        } else {\r\n            _log(\"URL request was too long or static callback name already exists, url: \" + callUrl, logTypes.ERROR, \"issueCall\");\r\n            _incrementRefusedCount();\r\n            if (reqObj && reqObj.error) {\r\n                _runCallBack(logTypes.ERROR, reqObj.error, _getErrorResponse(600, \"Transport - JSONP - unable to run request: \" + reqObj.url), reqObj.context);\r\n            }\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Gets the defaults for the transport\r\n     * @returns {{}}\r\n     */\r\n    function getDefaults(){\r\n        var tDefaults = {};\r\n        for (var defKey in defaults) {\r\n            if (defaults.hasOwnProperty(defKey)) {\r\n                tDefaults[defKey] = defaults[defKey];\r\n            }\r\n        }\r\n        return tDefaults;\r\n    }\r\n\r\n    /************************ PRIVATE METHODS ***************************/\r\n\r\n    /**\r\n     * Sets up the request with default values if they have not been passed in\r\n     * @param reqObj\r\n     */\r\n    function _setRequestDefaults(reqObj) {\r\n        if (typeof reqObj === 'string') {\r\n            var url = reqObj;\r\n            reqObj = { url: url };\r\n        }\r\n        if (!reqObj.url) {\r\n            return false;\r\n        } //nothing to send\r\n\r\n        reqObj.encoding = reqObj.encoding || defaults.encoding;\r\n        reqObj.callback = reqObj.callback || defaults.callback;\r\n        reqObj.retries = typeof reqObj.retries === 'number' ? reqObj.retries : defaults.retries;\r\n        reqObj.timeout = reqObj.timeout ? reqObj.timeout : defaults.timeout;\r\n\r\n        return reqObj;\r\n    }\r\n\r\n    /**\r\n     * Create a callback name that's random every time\r\n     */\r\n    function _createCallbackName(notRandom) {\r\n        var maxValue = 99999, separator = \"x\", cbName;\r\n        if (!notRandom) {\r\n            cbName = Math.round(Math.random() * maxValue) + separator + Math.round(Math.random() * maxValue);\r\n        } else {\r\n            cbName = maxValue + separator + maxValue;\r\n        }\r\n        return cbName;\r\n    }\r\n\r\n    /**\r\n     * Generic method to create error responses\r\n     * @param code\r\n     * @param errorMessage\r\n     * @returns {{statusCode: *, responseCode: *, error: *, body: string}}\r\n     */\r\n    function _getErrorResponse(code, errorMessage){\r\n        return { statusCode: code, responseCode: code, error: errorMessage , body: \"ERROR\" };\r\n    }\r\n\r\n    /**\r\n     * Create a script id tag for the DOM\r\n     */\r\n    function _createScriptId() {\r\n        return \"scr\" + Math.round(Math.random() * 999999999) + '_' + Math.round(Math.random() * 999999999);\r\n    }\r\n\r\n    /**\r\n     * Calculates the URL Length in JSONP.\r\n     * @param reqObj\r\n     * @returns {*}\r\n     * @private\r\n     */\r\n    function _calculateRequestLength(reqObj){\r\n        var callbackNameLength = callbackSampleLength;\r\n\r\n        if(reqObj.callbackName && typeof reqObj.callbackName === 'string'){\r\n            callbackNameLength = reqObj.callbackName.length;\r\n        }\r\n\r\n        return  (4 + (reqObj.callback || defaults.callback).length +\r\n                    reqObj.url.length +\r\n                    callbackNameLength +\r\n                    _convertDataToQueryParams(reqObj.data).length +\r\n                    _convertDataToQueryParams(reqObj.query).length);\r\n    }\r\n\r\n    /**\r\n     * Takes the data parameter and converts it to a query string\r\n     * @param data\r\n     * @return {String}\r\n     */\r\n    function _convertDataToQueryParams(data) {\r\n        var queryString = \"\";\r\n        if (typeof data === 'string') {\r\n            queryString += data;\r\n        } else {\r\n            var first = true;\r\n            for (var key in data) {\r\n                var value;\r\n                if (typeof data[key] == 'object') {\r\n                    value = _stringify(data[key]);\r\n                } else if (typeof data[key] !== 'function') {\r\n                    value = data[key];\r\n                }\r\n                if (typeof value !== \"undefined\") {\r\n                    if (!first) {\r\n                        queryString += \"&\";\r\n                    }\r\n                    queryString += encodeURIComponent(key) + \"=\" + encodeURIComponent(value);\r\n                    first = false;\r\n                }\r\n            }\r\n        }\r\n        return queryString;\r\n    }\r\n\r\n    /**\r\n     * This function was added because of incompatibility between the JSON.stringify and Prototype.js library\r\n     * When a costumer uses Prototype.js library, It overrides the Array.prototype.toJSON function the the native JSON\r\n     * uses. This causes arrays to be double quoted and Shark to fail on those SDEs.\r\n     * The function accepts a value and and uses the native JSON.stringify\r\n     * Can throw an exception (same as JSON.stringify).\r\n     */\r\n    function _stringify(value) {\r\n        var stringified;\r\n        if (typeof Array.prototype.toJSON === 'function') {\r\n            var toJSONPrototype = Array.prototype.toJSON;\r\n            delete Array.prototype.toJSON;\r\n            try {\r\n                stringified = JSON.stringify(value);\r\n            } catch (e) {\r\n                Array.prototype.toJSON = toJSONPrototype;\r\n                throw e;\r\n            }\r\n            Array.prototype.toJSON = toJSONPrototype;\r\n        } else {\r\n            stringified = JSON.stringify(value);\r\n        }\r\n        return stringified;\r\n    }\r\n\r\n    /**\r\n     * Buffers requests according to subDomain to insure we don't overflow the browser\r\n     * @param reqObj\r\n     */\r\n    function _bufferRequest(reqObj) {\r\n        var validRequest = false;\r\n        var domainRegEx = new RegExp(/(http{1}s{0,1}?:\\/\\/)([^\\/\\?]+)(\\/?)/ig);\r\n        var matches;\r\n        if (reqObj.callUrl.indexOf(\"http\") === 0) {\r\n            matches = domainRegEx.exec(reqObj.callUrl);\r\n        } else {\r\n            matches = domainRegEx.exec(window.location.href);\r\n        }\r\n        if (matches && matches.length >= 3 && matches[2] !== \"\") {\r\n            var domain = matches[2].toLowerCase(); // 0 - full match 1- HTTPS 2- domain\r\n            reqObj.domainMatch = domain;\r\n            buffReq[domain] = buffReq[domain] || [];\r\n            buffReq[domain].inFlight = buffReq[domain].inFlight || 0;\r\n            buffReq[domain].push(reqObj);\r\n            validRequest = true;\r\n            buffReqCount = buffReqCount + 1;\r\n            _log('buffered URL: ' + reqObj.callUrl, logTypes.DEBUG, 'lpTag.taglets.jsonp.bufferRequest');\r\n        } else {\r\n            _log('NO MATCH for URL: ' + reqObj.callUrl, logTypes.ERROR, 'lpTag.taglets.jsonp.bufferRequest');\r\n        }\r\n        return validRequest;\r\n    }\r\n\r\n    /**\r\n     * Checks the buffer and sends requests according to available net slots\r\n     */\r\n    function _sendRequests() {\r\n        var currentSubDomain;\r\n        for (var subDomain in buffReq) {\r\n            if (buffReq.hasOwnProperty(subDomain)) {\r\n                currentSubDomain = buffReq[subDomain];\r\n                var breakLoop = false;\r\n                while (!breakLoop && currentSubDomain.inFlight < 6 && currentSubDomain.length > 0) {\r\n                    var request = currentSubDomain.shift();\r\n                    if (request) {\r\n                        _log('Sent URL: ' + request.callUrl, logTypes.DEBUG, 'lpTag.taglets.jsonp.sendRequests');\r\n                        request.scriptId = _makeScriptCall(request.callUrl, request.encoding, request.callbackName);\r\n                        request.startTime =  new Date().getTime();\r\n                        _incrementCallCounts(subDomain, request.callbackName, request.timeout);\r\n                        buffReqCount = buffReqCount - 1;\r\n                    } else {\r\n                        breakLoop = true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        currentSubDomain = null;\r\n    }\r\n\r\n    /**\r\n     * Checks for timed out requests that are pending and functions which were kept to prevent errors on the page\r\n     */\r\n    function _checkForErrors() {\r\n        clearTimeout(errTOid);\r\n        errTOid = null;\r\n        var now = new Date();\r\n        for (var key in cb) {//Check for requests taking too long\r\n            if (cb.hasOwnProperty(key) && cb[key].launchTime) {\r\n                var timeElapsed = now - cb[key].launchTime;\r\n                if (cb[key].loadTime || timeElapsed > cb[key].timeout) {//Call error callBack\r\n                    window[key].apply(null, [\r\n                        _getErrorResponse(408, { message: \"Request timed out\", name: \"timeout\" }),\r\n                        true\r\n                    ]);//true here signals error will be called back\r\n                }\r\n            }\r\n        }\r\n\r\n        if (pendReqCount > 0) {\r\n            errTOid = setTimeout(_checkForErrors, 1000);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates the script tag for the request and returns the scriptId on the page\r\n     * @param URL\r\n     * @param encoding\r\n     */\r\n    function _makeScriptCall(URL, encoding, callbackName) {\r\n        var scriptId = _createScriptId();\r\n        var scriptCall = document.createElement(\"script\");\r\n        scriptCall.setAttribute(\"type\", \"text/javascript\");\r\n        scriptCall.setAttribute(\"charset\", encoding);\r\n        //These binds are to listen to script load time to lower error notification time for failed scripts\r\n        //Note this will only work for requests that end with .js\r\n        scriptCall.onload = function () {//Try for all browsers, should never have negative impact\r\n            if(cb[callbackName]){\r\n                cb[callbackName].loadTime = new Date();\r\n            }\r\n            this.onload = this.onerror = this.onreadystatechange = null;\r\n        };\r\n        if(!window.addEventListener){//Mainly for IE, since IE8- do not supply onerror handlers\r\n            scriptCall.onreadystatechange = function(){\r\n                if (this.readyState) {\r\n                    if(this.readyState === \"loaded\" || this.readyState === \"complete\"){\r\n                        if(cb[callbackName]){\r\n                            cb[callbackName].loadTime = new Date();\r\n                        }\r\n                        this.onload = this.onerror = this.onreadystatechange = null;\r\n                    }\r\n                }\r\n            };\r\n        }else{\r\n            //All other browsers support this normalized behavior\r\n            scriptCall.onerror = function(){\r\n                if(cb[callbackName]){\r\n                    cb[callbackName].loadTime = new Date();\r\n                }\r\n                this.onload = this.onerror = this.onreadystatechange = null;\r\n            };\r\n        }\r\n        scriptCall.setAttribute(\"src\", URL);\r\n        scriptCall.setAttribute(\"id\", scriptId);\r\n        document.getElementsByTagName(\"head\")[0].appendChild(scriptCall);\r\n        if (!errTOid) {\r\n            errTOid = setTimeout(_checkForErrors, 1000);\r\n        }\r\n        scriptCall = null;\r\n        return scriptId;\r\n    }\r\n\r\n    /**\r\n     * Increments the counters on the correct domain and general request counter\r\n     * @param domainMatch\r\n     * @param callbackName\r\n     * @param timeout\r\n     */\r\n    function _incrementCallCounts(domainMatch, callbackName, timeout) {\r\n        buffReq[domainMatch].inFlight = buffReq[domainMatch].inFlight + 1;\r\n        cb[callbackName] = { launchTime: new Date(), timeout: timeout };\r\n        pendReqCount = pendReqCount + 1;\r\n        callCount = callCount + 1;\r\n    }\r\n\r\n    /**\r\n     * Increments the counter of calls we can't make\r\n     */\r\n    function _incrementRefusedCount(){\r\n        refusedCount = refusedCount + 1;\r\n    }\r\n\r\n    /**\r\n     * Removes the script tag for the request\r\n     * @param scriptId\r\n     */\r\n    function _removeScript(scriptId) {\r\n        //Lesson learned from: http://neil.fraser.name/news/2009/07/27/\r\n        var scriptTag = document.getElementById(scriptId);\r\n        if (scriptTag) {\r\n            try {\r\n                scriptTag.parentNode.removeChild(scriptTag);\r\n                for (var key in scriptTag) {\r\n                    //No garbage collection for the tag, so we delete all it's properties\r\n                    if (scriptTag.hasOwnProperty(key)) {\r\n                        delete scriptTag[key];\r\n                    }\r\n                }\r\n            } catch (exc) {\r\n                _log(\"error when removing script\", logTypes.ERROR, \"removeScript\");\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Decrements the call counters in this layer\r\n     */\r\n    function _decrementRequestCount(domainMatch) {\r\n        buffReq[domainMatch].inFlight = buffReq[domainMatch].inFlight - 1;\r\n        pendReqCount = pendReqCount - 1;\r\n    }\r\n\r\n    /**\r\n     * Callback for all requests, runs cleanup and executes passed in methods\r\n     * @param data\r\n     * @param reqObj\r\n     * @param isError\r\n     * @private\r\n     */\r\n    function _defaultCallBack(data, reqObj, isError) {\r\n        _addToStats(reqObj.startTime, reqObj.url, isError);\r\n        _removeScript(reqObj.scriptId); //Clear the DOM of the script call\r\n        _decrementRequestCount(reqObj.domainMatch);\r\n        _removeFromCallbacksList(reqObj.callbackName, isError);\r\n        if (isError) {//Decides if there is an error here\r\n            if(reqObj.callbackName){\r\n                reqObj.callbackName = null;\r\n                delete reqObj.callbackName;\r\n            }\r\n            _errorCallback(data, reqObj);\r\n        } else {\r\n            _cleanupCallParameters(reqObj);\r\n            _runCallBack(\"callback\", reqObj.success, data, reqObj.context);\r\n            reqObj = null;\r\n            _sendRequests();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Publishes stats to lpAjax to decide if we want to report this\r\n     */\r\n    function _publishMetrics(){\r\n        var res;\r\n        if(lpTag.taglets.lpAjax &&\r\n            lpTag.taglets.lpAjax.publishMetrics &&\r\n            requestStats.length > 0){\r\n            res = {\r\n                tags: [ { transport: transportType } ],\r\n                metrics : requestStats\r\n            };\r\n            lpTag.taglets.lpAjax.publishMetrics(res);\r\n            requestStats.length = 0;\r\n        }\r\n        _setMetricsTimeout();\r\n    }\r\n\r\n    /**\r\n     * Clears any previous timeout to set this data and sets up\r\n     * the next time this should happen\r\n     */\r\n    function _setMetricsTimeout(){\r\n        if(metricsTOId) {\r\n            clearTimeout(metricsTOId);\r\n        }\r\n        metricsTOId = setTimeout(_publishMetrics, defaults.metricsTimeout);\r\n    }\r\n\r\n    /**\r\n     * Adding the time spent on the request\r\n     * @param startTime\r\n     */\r\n    function _addToStats(startTime, url, isError){\r\n        var requestDuration, now;\r\n        if(startTime) {\r\n            now = new Date().getTime();\r\n            requestDuration = (now - startTime);\r\n            requestStats.push({\r\n                rd: requestDuration,\r\n                ts: startTime,\r\n                url :url,\r\n                method: \"GET\",\r\n                statusCode: isError ? 400 : 200\r\n            });\r\n\r\n            if(requestStats.length >= defaults.metricsCount) {\r\n                _publishMetrics();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Error callback for all requests, runs cleanup and executes passed in methods\r\n     * @param reqObj\r\n     */\r\n    function _errorCallback(errorData, reqObj) {\r\n        errCount = errCount + 1;\r\n        if (reqObj.retries > 0) {//Set up another attempt at calling this URL\r\n            reqObj.retries = reqObj.retries - 1;\r\n            issueCall(reqObj);\r\n        } else {//Notify of failure\r\n            _cleanupCallParameters(reqObj);\r\n            _runCallBack(logTypes.ERROR, reqObj.error, errorData || _getErrorResponse(408, { id: 408, name: \"TIMEOUT\", message: \"Request has timed out on all retries\" }), reqObj.context);\r\n            reqObj = null;\r\n            _sendRequests();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Cleans up parameters from the request object\r\n     * @param reqObj\r\n     */\r\n    function _cleanupCallParameters(reqObj) {\r\n        var addedParams = [\"callUrl\", \"retries\", \"id\", \"requestTimeout\", \"type\", \"encoding\", \"launchTime\", \"callbackName\", \"domainMatch\", \"startTime\"];\r\n        for (var i = 0; i < addedParams.length; i++) {\r\n            if (reqObj.hasOwnProperty(addedParams[i])) {\r\n                reqObj[addedParams[i]] = null;\r\n                delete reqObj[addedParams[i]];\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Runs the callback passed protected\r\n     * @param type - the function type for logging purposes\r\n     * @param callback - the function that needs to run\r\n     * @param data - the data passed on to that function\r\n     * @param context - the context if any ti run this in\r\n     */\r\n    function _runCallBack(type, callback, data, context) {\r\n        if (typeof callback === 'function') {\r\n            try {\r\n                callback.call(context || null, data);\r\n                callback = null;\r\n            } catch (e) {\r\n                _log(\"Exception in execution of callback, type :\" + type + \" e=[\" + e.message + \"]\", logTypes.ERROR, \"runCallback\");\r\n            }\r\n        } else {\r\n            _log(\"No callback, of type :\" + type, logTypes.INFO, \"runCallback\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes callback from the list, in case of error we set the function with a new function to prevent errors on page\r\n     * @param callbackName - the callback to remove from the queue\r\n     * @param error - if this is because of an error (to set up a protection function on page)\r\n     */\r\n    function _removeFromCallbacksList(callbackName, error) {\r\n        cb[callbackName] = null;\r\n        delete cb[callbackName];\r\n        if (error === true) {\r\n            window[callbackName] = function () {//Function to clear itself - prevents errors being thrown on page\r\n                window[callbackName] = null;\r\n                try {\r\n                    delete window[callbackName];\r\n                } catch (err) {}\r\n            };\r\n        } else {\r\n            window[callbackName] = null;\r\n            try {\r\n                delete window[callbackName];\r\n            } catch (err) {\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates a closure scope to keep the object reference to the defaukt function\r\n     * @param reqObj\r\n     */\r\n    function _addToCallBackList(reqObj) {\r\n        if(cb[reqObj.callbackName]){\r\n            _incrementRefusedCount();\r\n            _errorCallback(_getErrorResponse(409, { message: \"This callbackName is already in a pending request and can't be serviced\", id: 409, name: \"CONFLICT\" }), reqObj);\r\n        }else{\r\n            window[reqObj.callbackName] = function (data, error) {\r\n                _defaultCallBack(data, reqObj, error);\r\n            };\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Passes a log to lpTag\r\n     * @param msg\r\n     * @param type\r\n     * @param callingObj\r\n     */\r\n    function _log(msg, type, callingObj) {\r\n        if (window.lpTag && lpTag.log) {\r\n            if(typeof msg === 'string' && callingObj){\r\n                msg = callingObj + ': ' + msg;\r\n            }\r\n            lpTag.log(msg, type, transportType);\r\n        }\r\n    }\r\n\r\n\r\n    var publicAPI =  {//These are the exposed public methods of this SINGLETON\r\n        init: init,\r\n        configure: configure,\r\n        issueCall: issueCall,\r\n        isValidRequest: isValidRequest,\r\n        getVersion: function () { return version; },\r\n        getName: function () { return transportType; },\r\n        getDefaults: getDefaults,\r\n        inspect: function () {\r\n            return {\r\n                name: transportType,\r\n                version: version,\r\n                callsMade: callCount,\r\n                errorsFound: errCount,\r\n                pending: pendReqCount,\r\n                buffered: buffReqCount,\r\n                refused: refusedCount ,\r\n                defaults: getDefaults()\r\n            };\r\n        }\r\n    };\r\n\r\n    /************************ Execution ***************************/\r\n    init();\r\n\r\n    return publicAPI;\r\n})(window);\r\n\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n\r\nlpTag.taglets.postmessage = lpTag.taglets.postmessage || (function (window) {\r\n\r\n    var version = \"1.1.8\",\r\n        transportType = \"postmessage\",\r\n        initialised = true,\r\n        iFramesObj = {},\r\n        callbacks = {},\r\n        pendingFrameReqQueue = {},\r\n        callCount = 0,\r\n        errorCount = 0,\r\n        pendingCount = 0,\r\n        iFrameList = {},\r\n        errorTimeOutId,\r\n        windowLoaded = false,\r\n        iFrameAttachPendingQueue = [],\r\n        logType = { DEBUG: \"DEBUG\", INFO: \"INFO\", ERROR:\"ERROR\"},\r\n        docSubDomain = _getSubDomain(document.location.href),\r\n        responseTypes  = { progress: \"progressLoad\", completed: \"completeLoad\", success: \"success\", error: \"errorLoad\", reloading: \"reloading\", stats: \"statData\" },\r\n        postMessageTimeout = { responseType: responseTypes.error, responseCode: 404, message: \"Request timed out on parent postMessage layer\", name: \"TIMEOUT\"},\r\n        iFrameLoaded = { responseType: responseTypes.success, responseCode: 200, message: \"iFrame has successfully loaded\", name: \"OK\"},\r\n        iFrameTeapot = { responseType: responseTypes.error, responseCode: 418, message: \"This iFrame is a teapot, not very useful for communication but lovely for earl grey\", name: \"TEAPOT\" },//See rfc http://www.ietf.org/rfc/rfc2324.txt\r\n        rDefaults = { timeout: 60000, metricsCount: 1000},\r\n        iFrameOnLoadTimeout = 10000,\r\n        validationState = {//Enumeration of the possible iFrame states\r\n            VALIDATED: \"valid\",\r\n            PENDING: \"pending\",\r\n            FAILED: \"failed\"\r\n        };\r\n\r\n    /*************************** AUTO EXECUTE **********************************/\r\n\r\n    _setParentLoadedState();\r\n\r\n    _bindEvent(window, \"message\", _handleMessage);\r\n\r\n    /************************** PUBLIC METHODS **********************************/\r\n\r\n    /**\r\n     * Initialising method\r\n     * Sets defaults on the parent trans port\r\n     * Allows passing an iFrame objects for later use with configuration as objects, format:\r\n     * frames: { url: IFRAME_LOCATION, defaults: DEFAULT_CONFIGURATION_FOR_XHR }\r\n     * @param configurationObj\r\n     */\r\n    function configure(configurationObj) {\r\n        var isHttps = (location.protocol.indexOf(\"https\") === 0);\r\n        if (configurationObj) {\r\n            if (configurationObj.frames) {\r\n                configurationObj.frames = configurationObj.frames.constructor === Array ? configurationObj.frames : [configurationObj.frames];\r\n                for (var i = 0; i < configurationObj.frames.length; i++) {\r\n                    _queueFrame(configurationObj.frames[i], isHttps);\r\n                }\r\n            }\r\n            if (configurationObj.defaults) {\r\n                for (var key in configurationObj.defaults) {\r\n                    if (rDefaults.hasOwnProperty(key) && configurationObj.defaults.hasOwnProperty(key)) {\r\n                        rDefaults[key] = configurationObj.defaults[key];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        initialised = true;\r\n    }\r\n\r\n    function init() {\r\n        if(lpTag && lpTag.taglets && lpTag.taglets.lpAjax) {\r\n            try{\r\n                lpTag.taglets.lpAjax.addTransport(transportType, publicAPI);\r\n            }catch(exc){}\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validates the request can be handled by this transport\r\n     * Checks that an iframe exists or one is pending validation\r\n     * for the sub-domain of the request\r\n     * @param msgObj\r\n     * @return {Boolean}\r\n     */\r\n    function isValidRequest(msgObj) {\r\n        var validRequest = false;\r\n        if (window.postMessage && window.JSON){//we need both to be able to run a request\r\n            if (msgObj && msgObj.success && ((msgObj.domain && msgObj.validation) || msgObj.url)) {\r\n                msgObj.domain = msgObj.domain || _getSubDomain(msgObj.url);\r\n                if (iFramesObj[msgObj.domain] || iFrameList[msgObj.domain]) {\r\n                    validRequest = true;\r\n                }\r\n            }\r\n        }\r\n        return validRequest;\r\n    }\r\n\r\n    /**\r\n     * Issues a call to the domain requested by passing the request to the child iFrame if a validated iFrame exists\r\n     * If an iFrame was configured but never used it triggers it's addition and queues the callback\r\n     * If an iFrame was started but is pending validation, it queues the request for when the frame is validated\r\n     * @param msgObj\r\n     * @return {Boolean}\r\n     */\r\n    function issueCall(msgObj) {\r\n        var messageSent = false;\r\n        if (initialised && isValidRequest(msgObj)) {\r\n            if (iFramesObj[msgObj.domain]) {\r\n                if (iFramesObj[msgObj.domain].validated === validationState.PENDING && !msgObj.validation) {\r\n                    messageSent = _queueForFrame(msgObj.domain, msgObj);\r\n                } else {\r\n                    messageSent = _sendRequest(msgObj);\r\n                    if (messageSent) {\r\n                        _incrementCallCounters(msgObj.domain);\r\n                    }else{//If message was not sent, we invoke immediate timeout\r\n                        callbacks[msgObj.callId].timeout = 0;\r\n                    }\r\n                }\r\n            } else {\r\n                _log(\"Adding iFrame to DOM - first request: \" + msgObj.domain,  logType.INFO , \"issueCall\");\r\n                messageSent = _queueForFrame(msgObj.domain, msgObj);//Queue the callback for this frame\r\n                _addFrame(iFrameList[msgObj.domain]);\r\n                delete iFrameList[msgObj.domain];//remove from our pending for use list\r\n            }\r\n        } else {\r\n            messageSent = _noFrameFound(msgObj.domain, msgObj.error, msgObj.context);\r\n        }\r\n        return messageSent;\r\n    }\r\n\r\n    /**\r\n     * Method for querying info about a specific iFrame state\r\n     * @param domain\r\n     * @return {*}\r\n     */\r\n    function getFrameData(domain) {\r\n        if(domain && iFramesObj[domain]) {\r\n            return {\r\n                url: iFramesObj[domain].url,\r\n                validated: iFramesObj[domain].validated,\r\n                requestCount: iFramesObj[domain].requestCount,\r\n                defaults: _cloneSimpleObj(iFramesObj[domain].defaults),\r\n                started: iFramesObj[domain].validated === validationState.VALIDATED\r\n            };\r\n        }else{\r\n            return {};\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets a list of active iFrames and their state (uses getFrameData)\r\n     * @return {Object}\r\n     */\r\n    function getAllFramesData() {\r\n        var framesResult = {};\r\n        for (var key in iFramesObj) {\r\n            if (iFramesObj.hasOwnProperty(key)) {\r\n                framesResult[key] = getFrameData(key);\r\n            }\r\n        }\r\n        return framesResult;\r\n    }\r\n\r\n    /************************** PRIVATE METHODS **********************************/\r\n\r\n    /**\r\n     * Binding function for DOM elements\r\n     * @param elem - the element we're binding to\r\n     * @param eventName - the event we're listening on\r\n     * @param callback - our callback for when it happens\r\n     */\r\n    function _bindEvent(elem, eventName, callback) {\r\n        if (elem.addEventListener) {\r\n            elem.addEventListener(eventName, callback, false);\r\n        } else {\r\n            elem.attachEvent(\"on\" + eventName, callback);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates a new error response object\r\n     * @param callId\r\n     * @param responseObj\r\n     * @return {Object}\r\n     */\r\n    function _getErrorResponse(callId, responseObj){\r\n        return { callId: callId, responseType: responseObj.responseType, responseCode: responseObj.responseCode, error: { message: responseObj.message, id: responseObj.responseCode, name: responseObj.name}};\r\n    }\r\n\r\n    /**\r\n     * Unbinds a DOM event\r\n     * @param elem\r\n     * @param eventName\r\n     * @param callback\r\n     */\r\n    function _unbindEvent(elem, eventName, callback) {\r\n        if (elem.removeEventListener) {\r\n            elem.removeEventListener(eventName, callback, false);\r\n        } else if(elem.detachEvent){\r\n            elem.detachEvent(\"on\" + eventName, callback);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the current state so we can understand what to in case of\r\n     * someone trying to add the frame to the body before it's interactive\r\n     */\r\n    function _setParentLoadedState(){\r\n        if(document.body){\r\n            windowLoaded = true;\r\n            _attachPendingIFrames();\r\n        }else{\r\n            setTimeout(_setParentLoadedState, 5);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Runs the pending iFrame attachments to the body of not yet loaded iFrames\r\n     */\r\n    function _attachPendingIFrames(){\r\n        while(iFrameAttachPendingQueue.length > 0){\r\n            try{\r\n                (iFrameAttachPendingQueue.shift()).call(null);\r\n            }catch (exc){\r\n                _log(\"Unable to execute queued callbacks for window interactive state: \" + exc, logType.ERROR, \"_attachPendingIFrames\" );\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates a Unique identifier with a prefix\r\n     * @return {String}\r\n     */\r\n    function _createUId(preFix) {\r\n        return preFix + \"_\" + Math.floor(Math.random() * 100000) + \"_\" + Math.floor(Math.random() * 100000);\r\n    }\r\n\r\n    /**\r\n     * Function to extract the sub domain from any URL\r\n     * @param url\r\n     * @return {String}\r\n     */\r\n    function _getSubDomain(url) {\r\n        var domainRegEx = new RegExp(/(http{1}s{0,1}?:\\/\\/)([^\\/\\?]+)(\\/?)/ig);\r\n        var matches, domain = null;\r\n        if (url.indexOf(\"http\") === 0) {\r\n            matches = domainRegEx.exec(url);\r\n        } else {//This is a partial url so we assume it's relative, this is mainly nice for tests\r\n            return location.protocol + \"//\" + location.host;\r\n        }\r\n        if (matches && matches.length >= 3 && matches[2] !== \"\") {\r\n            domain = matches[1].toLowerCase() + matches[2].toLowerCase(); // 0 - full match 1- HTTPS 2- domain\r\n        }\r\n        return domain;\r\n    }\r\n\r\n    /**\r\n     * Adds an iFrame to our list of potential iFrames\r\n     * Also checks for defaults definition of requests for that iFrame\r\n     * If none existent sets the defaults defined for the transport\r\n     * @param frameObject\r\n     * @param parentIsHttps\r\n     * @return {Boolean}\r\n     */\r\n    function _queueFrame(frameObject, parentIsHttps) {\r\n        var added = false, domain, isHttps;\r\n        if (!frameObject || !frameObject.url || typeof frameObject.url !== 'string') {\r\n            _log(\"iFrame configuration empty or missing url parameter\", logType.ERROR, \"_queueFrame\");\r\n            return added;\r\n        }\r\n        domain = _getSubDomain(frameObject.url);\r\n        isHttps = (frameObject.url.toLowerCase().indexOf(\"https\") === 0);\r\n        if (!iFramesObj[domain] && !iFrameList[domain]) {\r\n            if(!parentIsHttps || (isHttps === parentIsHttps)){//This is to protect from adding http iframes to pages that are https, something the browser itself will block\r\n                iFrameList[domain] = frameObject;\r\n                added = true;\r\n            }\r\n        }\r\n        return added;\r\n    }\r\n\r\n    /**\r\n     * Adds the frame to the DOM and queues a listener\r\n     * To know if it has loaded\r\n     * @param iFrameConfiguration\r\n     *   src - the URL for the iframe\r\n     *   defaults  - the default configuration for this iFrame\r\n     *   success/callback - the validation callback supplied from externally\r\n     *   context - the execution context for the external callback\r\n     *   delayLoad - if the frame should be loaded with timeout (for refresh scenarios where other scripts need to run before)\r\n     *   error - callback in case the iFrame dies\r\n     * @return {*}\r\n     */\r\n    function _addFrame(iFrameConfiguration) {\r\n        //url, defaults, callback ||  success, context, delayLoad, error\r\n        var domain = _getSubDomain(iFrameConfiguration.url);\r\n        if (iFramesObj[domain]) {\r\n            return _frameExists(domain, iFrameConfiguration.callback || iFrameConfiguration.success, iFrameConfiguration.context);\r\n        }\r\n        var id = _createUId(\"fr\");\r\n\r\n        iFramesObj[domain] = {\r\n            elem: _createiFrame(id),//The iFrame element on the page\r\n            url: iFrameConfiguration.url,//The iFrame src URL\r\n            validated: validationState.PENDING,//The validation state\r\n            defaults: iFrameConfiguration.defaults || {},//Defaults for this iFrame\r\n            delayLoad: isNaN(iFrameConfiguration.delayLoad) ? 0:  iFrameConfiguration.delayLoad,//Delayload configuration for adding to DOM, default is end of queue\r\n            requestCount: 0,//The number of requests issued to this iFrame\r\n            success: iFrameConfiguration.callback || iFrameConfiguration.success,//The callback when the frame has loaded\r\n            error: iFrameConfiguration.error,//An error callback when the frame is dead\r\n            maxReloadRetries: iFrameConfiguration.maxReloadRetries || 3,//The number of tries to revive this iFrame\r\n            reloadInterval: iFrameConfiguration.reloadInterval * 1000 || 30000//The timeout between reload intervals\r\n        };\r\n\r\n        setTimeout(function () {//Always timed out for best compatablity\r\n            _addFrameToBodyAndBind(iFrameConfiguration.url , domain);\r\n        }, iFramesObj[domain].delayLoad);\r\n        _log(\"iFrame Queued to load \" +  domain , logType.INFO, \"_addFrame\");\r\n        return validationState.PENDING;\r\n    }\r\n\r\n    function _returnFrameToList(iFrameConfiguration) {\r\n        var domain = _getSubDomain(iFrameConfiguration.url);\r\n        iFrameList[domain] = {\r\n            url: iFrameConfiguration.url,//The iFrame src URL\r\n            defaults: iFrameConfiguration.defaults || {},//Defaults for this iFrame\r\n            delayLoad: iFrameConfiguration.delayLoad,//Delayload configuration for adding to DOM, default is end of queue\r\n            success: iFrameConfiguration.success,//The callback when the frame has loaded\r\n            error: iFrameConfiguration.error,//An error callback when the frame is dead\r\n            maxReloadRetries: iFrameConfiguration.maxReloadRetries,//The number of tries to revive this iFrame\r\n            reloadInterval: iFrameConfiguration.reloadInterval / 1000//The timeout between reload intervals\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Adds the iframe to the DOM, sets the URL and starts the validation process\r\n     * @param src - the iframe URL\r\n     * @param domain - the domain of this URL\r\n     */\r\n    function _addFrameToBodyAndBind(src, domain) {\r\n        if(windowLoaded){\r\n            _attachFrame(src, domain);\r\n        }else{\r\n            iFrameAttachPendingQueue.push(function(){\r\n                _attachFrame(src, domain);\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attaches the iFrame to the body and binds to it's onload event\r\n     * @param src\r\n     * @param domain\r\n     */\r\n    function _attachFrame(src, domain){\r\n        iFramesObj[domain].loadCallback = iFramesObj[domain].loadCallback || _createLoadCallback(domain);\r\n        _setIFrameLocation(iFramesObj[domain].elem, src);\r\n        _bindEvent(iFramesObj[domain].elem, \"load\", iFramesObj[domain].loadCallback );//This listens to the onload event of the iFrame\r\n        iFramesObj[domain].iFrameOnloadTimeout = setTimeout(iFramesObj[domain].loadCallback, iFrameOnLoadTimeout);//This sets a timeout in case we did not get the event\r\n        iFramesObj[domain].attachTime =  new Date().getTime();\r\n        document.body.appendChild(iFramesObj[domain].elem);\r\n    }\r\n\r\n    /**\r\n     * Creates the callback for validation of the added iFrame\r\n     * @param domain - the iFrame domain\r\n     */\r\n    function _createLoadCallback( domain){\r\n        return function (eventData) {\r\n            if(iFramesObj[domain].iFrameOnloadTimeout){\r\n                clearTimeout(iFramesObj[domain].iFrameOnloadTimeout);\r\n                delete iFramesObj[domain].iFrameOnloadTimeout;\r\n            }\r\n            iFramesObj[domain].loadTime = new Date().getTime() - iFramesObj[domain].attachTime;\r\n            _validateFrame(domain, eventData);\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Increments our counters of requests made\r\n     */\r\n    function _incrementCallCounters(domain) {\r\n        callCount = callCount + 1;\r\n        pendingCount = pendingCount + 1;\r\n        iFramesObj[domain].requestCount = iFramesObj[domain].requestCount + 1;\r\n    }\r\n\r\n    /**\r\n     * Queues requests for existing iFrames that have not loaded yet\r\n     * @param domain\r\n     * @param msgObj\r\n     * @return {Boolean}\r\n     */\r\n    function _queueForFrame(domain, msgObj) {\r\n        pendingFrameReqQueue[domain] = pendingFrameReqQueue[domain] || [];\r\n        pendingFrameReqQueue[domain].push(msgObj);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Default response when an iFrame is being added\r\n     * and one allready exists for that subdomain\r\n     * @param domain - the domain of the iframe\r\n     * @param success - the callback passed in externally\r\n     * @param context - the context to run the callback in\r\n     * @return {*} - returns a string validated state\r\n     */\r\n    function _frameExists(domain, success, context) {\r\n        var res = getFrameData(domain);\r\n        _runCallBack(success, context, res);\r\n        return iFramesObj[domain].validated;\r\n    }\r\n\r\n    /**\r\n     * Creates an iFrame in memory and sets the default attributes except the actual URL\r\n     * Does not attach to DOM at this point\r\n     * @param id - a passed in ID for easy lookup later\r\n     * @return {Element} - the detached iFrame element\r\n     */\r\n    function _createiFrame(id) {\r\n        var frame = document.createElement(\"IFRAME\");\r\n        frame.setAttribute(\"id\", id);\r\n        frame.setAttribute(\"name\", id);\r\n        frame.setAttribute(\"tabindex\", \"-1\");//To prevent it getting focus when tabbing through the page\r\n        frame.setAttribute(\"aria-hidden\", \"true\");//To prevent it being picked up by screen-readers\r\n        frame.setAttribute(\"title\", \"\");//Adding an empty title at AT&Ts insistence\r\n        frame.setAttribute(\"role\", \"presentation\");//Adding a presentation role http://yahoodevelopers.tumblr.com/post/59489724815/easy-fixes-to-common-accessibility-problems\r\n        frame.style.width = \"0px\";\r\n        frame.style.height = \"0px\";\r\n        frame.style.position = \"absolute\";\r\n        frame.style.top = \"-1000px\";\r\n        frame.style.left = \"-1000px\";\r\n\r\n        return frame;\r\n    }\r\n\r\n    /**\r\n     * Queues a callback for when we get responses from the iFrame\r\n     * @param callId - the UID we sent to the iFrame\r\n     * @param success - the success method passed in\r\n     * @param error - the error method passed in\r\n     * @param progress - the progress method passed in\r\n     * @param context - the execution context for the callbacks\r\n     * @param timeout - the timeout for this request\r\n     * @return {Boolean} - a boolean indicating we queued the request\r\n     */\r\n    function _queueCallback(callId, success, error, progress, context, timeout) {\r\n        var msgQueued = false;\r\n        if (callId && success && typeof success === 'function') {\r\n            callbacks[callId] = { success: success, error: error, progress: progress, ctx: context, launchTime: new Date(), timeout: !isNaN(timeout) ? (timeout + 1000) : rDefaults.timeout };\r\n            msgQueued = true;\r\n        }\r\n        return msgQueued;\r\n    }\r\n\r\n    /**\r\n     * Removes a request from our callback queue\r\n     * @param callId - the identifier of this request\r\n     * @return {Boolean} - if the request was found and de-queued\r\n     */\r\n    function _deQueueCallback(callId) {\r\n        if (callbacks[callId]) {\r\n            callbacks[callId] = null;\r\n            delete callbacks[callId];\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Validation method for an iFrame queued when the iframe fires the load event\r\n     * When this event is triggered it queues the validation request from the internal iFrame\r\n     * with a slight delay, this seems the only way to make it work 100% of the time\r\n     * @param domain - the domain of the iFrame\r\n     * @return {Boolean}\r\n     */\r\n    function _validateFrame(domain, eventData) {\r\n        _log(\"onLoad validation called \" +  domain , logType.INFO, \"_validateFrame\");\r\n        var callback = function (data) {\r\n            _validateFrameCallback(data, domain);\r\n        };\r\n        if(eventData && eventData.error){//This is if a timeout called this method, in that case there is no need to try and talk to the frame - we know it failed\r\n            _validateFrameCallback(eventData, domain);\r\n        }else{\r\n            setTimeout(function () {\r\n                issueCall({ domain: domain,\r\n                        success: callback,\r\n                        error: callback,\r\n                        validation: true,\r\n                        timeout: 100,\r\n                        retries: -1,\r\n                        defaults: iFramesObj[domain].defaults\r\n                    }); }, 10);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Callback function to validate a frame has loaded\r\n     * It can also run a success/error function to notify the frame load outcome\r\n     * This also triggers errors or issues any pending calls in the order\r\n     * @param data\r\n     * @param domain\r\n     * @return {*}\r\n     */\r\n    function _validateFrameCallback(data, domain) {\r\n        var frameLoaded;\r\n        var frame = iFramesObj[domain];//Reference for callbacks after cleanup\r\n        _log(\"running validation of domain \" +  domain , logType.INFO, \"_validateFrameCallback\");\r\n        if (frame) {\r\n            iFramesObj[domain].validated = data && data.error ? validationState.FAILED : validationState.VALIDATED;\r\n            frameLoaded = (iFramesObj[domain].validated === validationState.VALIDATED);\r\n            if(frameLoaded){\r\n                _runFrameValidated(domain, data);\r\n            }else if(iFramesObj[domain].reloadObj && iFramesObj[domain].reloadObj.retriesLeft > 0){\r\n                _runReloadAttempt(domain);\r\n            }else{\r\n                _runFrameFailedToLoad(domain);\r\n            }\r\n        }\r\n        frame = null;\r\n        return frameLoaded;\r\n    }\r\n\r\n    /**\r\n     * Executes when a frame has been loaded successfully and can now be used for communication\r\n     * @param domain\r\n     */\r\n    function _runFrameValidated(domain, data){\r\n        var res;\r\n        _log(\"FrameLoaded \" +  domain , logType.INFO, \"_runFrameValidated\");\r\n        res = _cloneSimpleObj(iFrameLoaded);\r\n        for(var key in data){\r\n            if(data.hasOwnProperty(key)) {\r\n                res[key] = data[key];\r\n            }\r\n        }\r\n        _runCallBack(iFramesObj[domain].success, iFramesObj[domain].context, res);\r\n        _cleanUpReloadObject(domain);\r\n        _runQueuedRequests(domain, true);\r\n    }\r\n\r\n    /**\r\n     * Runs when a frame has failed to load and we need to clean it up along\r\n     * with any pending requests\r\n     * @param domain\r\n     */\r\n    function _runFrameFailedToLoad(domain){\r\n        _log(\"iFrame is a teapot \" +  domain , logType.ERROR, \"_runFrameFailedToLoad\");\r\n        if(iFramesObj[domain].error){//Work with local pointer\r\n            var errResponse = _getErrorResponse(0, iFrameTeapot);\r\n            errResponse.domain = domain;\r\n            _runCallBack(iFramesObj[domain].error, iFramesObj[domain].context, errResponse );\r\n        }\r\n        _cleanupIFrame(domain);\r\n        _runQueuedRequests(domain, false);\r\n    }\r\n\r\n    /**\r\n     * Executed in case we have a reload state for this iFrame\r\n     * @param domain\r\n     */\r\n    function _runReloadAttempt(domain){\r\n        _log(\"Retry loading domain: \" +  domain , \"info\", \"_runReloadAttempt\");\r\n        _runQueuedRequests(domain, false);\r\n        _handleReload(domain);\r\n    }\r\n\r\n    /**\r\n     * Runs any queued callbacks before the iFrame loaded\r\n     * In the order they were queued\r\n     * @param domain\r\n     * @param frameLoaded\r\n     */\r\n    function _runQueuedRequests(domain,frameLoaded){\r\n        _log(\"Running buffer queue : \" + domain + \" loaded: \" + frameLoaded , logType.INFO , \"_runQueuedRequests\");\r\n        if (pendingFrameReqQueue[domain] && pendingFrameReqQueue[domain].length > 0) {\r\n            do {\r\n                var pending = pendingFrameReqQueue[domain].shift();\r\n                if (frameLoaded) {\r\n                    issueCall(pending);\r\n                } else {\r\n                    _runCallBack(pending.error, pending.context, { responseCode: 600, error: \"Transport - postmessage - unable to run request: \" + domain, body: \"ERROR\" });\r\n                }\r\n            } while (pendingFrameReqQueue[domain].length > 0);\r\n            pendingFrameReqQueue[domain] = null;\r\n            delete pendingFrameReqQueue[domain];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Cleans up the iFrame for a specific domain\r\n     * @param domain\r\n     */\r\n    function _cleanupIFrame(domain){\r\n        _log(\"Cleaning up failed iFrame: \" + domain,  logType.INFO , \"_cleanupIFrame\");\r\n        if(iFramesObj[domain]){\r\n            _unbindEvent(iFramesObj[domain].elem, \"load\",iFramesObj[domain].loadCallback);\r\n            iFramesObj[domain].elem.parentNode.removeChild(iFramesObj[domain].elem);\r\n            var result = _cloneSimpleObj(iFrameTeapot);\r\n            result.domain = domain;\r\n            result.url = iFramesObj[domain].url;\r\n            _runCallBack(iFramesObj[domain].error, iFramesObj[domain].context, result);\r\n            _returnFrameToList(iFramesObj[domain]); //Allow reloading of the same iFrame on next request\r\n            iFramesObj[domain] = null;//Removes the iFrame from the domain map, before callback in case it re-registers a frame\r\n            delete iFramesObj[domain];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Default callback if no iframe was found that can handle the request\r\n     * @param domain\r\n     * @param callback\r\n     * @param context\r\n     * @return {Boolean}\r\n     */\r\n    function _noFrameFound(domain, callback, context) {\r\n        _log(\"Frame not found for domain: \" + domain,  logType.ERROR , \"_noFrameFound\");\r\n        _runCallBack(callback, { responseCode: 600, error: \"Transport - postmessage - unable to run request: \" + domain, body: \"ERROR\" }, context);\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Sends the actual request to the child frame\r\n     * while setting up callbacks\r\n     * @param msgObj\r\n     * @return {Boolean}\r\n     */\r\n    function _sendRequest(msgObj) {\r\n        var msgToSend, msgSent = false;\r\n        msgObj = _setUpMessageObj(msgObj);\r\n        msgToSend = _cloneSimpleObj(msgObj);\r\n        try {\r\n            msgToSend = _stringify(msgToSend);\r\n        } catch (err) {\r\n            _log(\"Error trying to _stringify message\", logType.ERROR, \"sendMessageToFrame\");\r\n            return false;\r\n        }\r\n        _log(\"sending msg to domain \" +  msgObj.domain, logType.DEBUG, \"sendMessageToFrame\");\r\n        var parentTimeout;\r\n        if (!isNaN(msgObj.timeout) && !isNaN(msgObj.retries)) {\r\n            parentTimeout = (msgObj.timeout * (msgObj.retries + 1)) + 2000;\r\n        }\r\n        _queueCallback(msgObj.callId, msgObj.success, msgObj.error, msgObj.progress, msgObj.context, parentTimeout );\r\n        try {\r\n            msgSent = _postTheMessage(msgObj.domain, msgToSend);\r\n            errorTimeOutId = setTimeout(_checkForErrors, 1000);\r\n        }\r\n        catch (err) {\r\n            _log(\"Error trying to send message: \" + err, logType.ERROR, \"sendMessageToFrame\");\r\n            msgSent = false;\r\n        }\r\n        return msgSent;\r\n    }\r\n\r\n    /**\r\n     * This function was added because of incompatibility between the JSON._stringify and Prototype.js library\r\n     * When a costumer uses Prototype.js library, It overrides the Array.prototype.toJSON function the the native JSON\r\n     * uses. This causes arrays to be double quoted and Shark to fail on those SDEs.\r\n     * The function accepts a value and and uses the native JSON._stringify\r\n     * Can throw an exception (same as JSON._stringify).\r\n     */\r\n    function _stringify(value) {\r\n        var stringified;\r\n        if (typeof Array.prototype.toJSON === 'function') {\r\n            var toJSONPrototype = Array.prototype.toJSON;\r\n            delete Array.prototype.toJSON;\r\n            try {\r\n                stringified = JSON.stringify(value);\r\n            } catch (e) {\r\n                Array.prototype.toJSON = toJSONPrototype;\r\n                throw e;\r\n            }\r\n            Array.prototype.toJSON = toJSONPrototype;\r\n        } else {\r\n            stringified = JSON.stringify(value);\r\n        }\r\n        return stringified;\r\n    }\r\n\r\n    /**\r\n     * Sets up the call to have a callId we use to identify the returning message\r\n     * Sets up the callback domain\r\n     * Sets up triggering of progress events if a progress callback was supplied\r\n     * @param msgObj\r\n     * @return {*}\r\n     */\r\n    function _setUpMessageObj(msgObj) {\r\n        var frameConfig = iFramesObj[msgObj.domain] && iFramesObj[msgObj.domain].defaults;\r\n        msgObj.callId = _createUId(\"call\");\r\n        msgObj.returnDomain = docSubDomain;\r\n        if(typeof msgObj.timeout === 'undefined'){\r\n            msgObj.timeout = (frameConfig && frameConfig.timeout) || rDefaults.timeout;\r\n        }\r\n        if(typeof msgObj.retries === 'undefined'){\r\n            msgObj.retries = (frameConfig && typeof frameConfig.retries !== 'undefined') ? frameConfig.retries : rDefaults.retries;\r\n        }\r\n        if (msgObj.progress) {\r\n            msgObj.fireProgress = true;\r\n        }\r\n        msgObj.headers = msgObj.headers || {};\r\n        msgObj.headers[\"LP-URL\"] = window.location.href;\r\n        return msgObj;\r\n    }\r\n\r\n    /**\r\n     * Posts the message to the sub-domain iFrame\r\n     * Increments the counters so we know how many requests were\r\n     * sent to this iFrame\r\n     * @param domain\r\n     * @param msgToSend\r\n     * @return {Boolean}\r\n     */\r\n    function _postTheMessage(domain, msgToSend) {\r\n        var messageSent = false;\r\n        try {\r\n            iFramesObj[domain].elem.contentWindow.postMessage(msgToSend, domain);\r\n            messageSent = true;\r\n        } catch (err) {\r\n            _log(\"Error trying to send message: \" + err, logType.ERROR, \"_postTheMessage\");\r\n        }\r\n        return messageSent;\r\n    }\r\n\r\n    /**\r\n     * Checks for timeout errors on messages we never got replies on\r\n     * @return {Boolean}\r\n     */\r\n    function _checkForErrors() {\r\n        if (errorTimeOutId) {\r\n            clearTimeout(errorTimeOutId);\r\n        }\r\n        errorTimeOutId = null;\r\n        var now = new Date();\r\n        var pendReqCount = 0;\r\n        var timedOutCallbacks = [];\r\n        for (var key in callbacks) {//Check for requests taking too long\r\n            if (callbacks.hasOwnProperty(key) && callbacks[key].launchTime) {\r\n                var timeElapsed = now - callbacks[key].launchTime;\r\n                if (timeElapsed > callbacks[key].timeout) {//Queue error callback\r\n                    timedOutCallbacks.push(key);\r\n                } else {\r\n                    pendReqCount = pendReqCount + 1;\r\n                }\r\n            }\r\n        }\r\n        if(timedOutCallbacks.length){\r\n            _log(\"Checking errors found \" + timedOutCallbacks.length + \" timeout callbacks to call\",  logType.DEBUG , \"_checkForErrors\");\r\n            for (var i = 0; i < timedOutCallbacks.length; i++) {//Execute the callbacks\r\n                _executeMessageCallback(_getErrorResponse(timedOutCallbacks[i], postMessageTimeout));\r\n            }\r\n        }\r\n        if (pendReqCount > 0) {\r\n            errorTimeOutId = setTimeout(_checkForErrors, 1000);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Flat clone method, only clones data ignoring functions\r\n     * @param obj\r\n     * @return {Object}\r\n     */\r\n    function _cloneSimpleObj(obj) {\r\n        var resObj = obj;\r\n\r\n        try{\r\n            resObj = JSON.parse(_stringify(obj));\r\n        }catch(exc){}\r\n\r\n        return resObj;\r\n    }\r\n\r\n    /**\r\n     * Retrieves and triggers the correct callback for\r\n     * the response we got from the iFrame\r\n     * @param data\r\n     * @param origin\r\n     * @return {Boolean}\r\n     */\r\n    function _executeMessageCallback(data, origin) {\r\n        var cbInfo = callbacks[data.callId],\r\n            callBack,\r\n            responseType = data.responseType,\r\n            clearData = false;\r\n\r\n        if ((data.callId && callbacks[data.callId]) ||\r\n            data.responseType === responseTypes.reloading ||\r\n            data.responseType === responseTypes.stats) {\r\n            try {\r\n                switch (responseType) {\r\n                    case responseTypes.completed:\r\n                        callBack = cbInfo.success;\r\n                        clearData = true;\r\n                        break;\r\n                    case responseTypes.error:\r\n                        callBack = cbInfo.error;\r\n                        clearData = true;\r\n                        errorCount = errorCount + 1;\r\n                        break;\r\n                    case responseTypes.progress:\r\n                        callBack = cbInfo.progress;\r\n                        break;\r\n                    case responseTypes.reloading:\r\n                        data = origin;\r\n                        callBack = _handleReload;\r\n                        break;\r\n                    case responseTypes.stats:\r\n                        callBack = _publishMetrics;\r\n                        data = data.rawData;\r\n                        break;\r\n                    default:\r\n                        break;\r\n                }\r\n                if (clearData) {\r\n                    _deQueueCallback(data.callId);\r\n                    _cleanRequest(data);\r\n                    pendingCount = pendingCount >= 0 ? 0 : pendingCount - 1;\r\n                }\r\n\r\n                if (callBack && typeof callBack === 'function') {\r\n                    _runCallBack(callBack, (cbInfo && cbInfo.ctx) || null, data);\r\n                }\r\n                callBack = null;\r\n                cbInfo = null;\r\n            } catch (err) {\r\n                _log(\"Error in executing callback: \" + err, logType.ERROR, \"_executeMessageCallback\");\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Handles a case where we identify too\r\n     * many errors from an iframe and need to pause new\r\n     * requests to it\r\n     */\r\n    function _handleReload(origin){\r\n        _log(\"Got reload request from \" + origin, logType.INFO , \"_handleReload\");\r\n        iFramesObj[origin].validated = validationState.PENDING;\r\n        if(!iFramesObj[origin].reloadObj){\r\n            _log(\"Creating reloadObj\" + origin,  logType.DEBUG , \"_handleReload\");\r\n            iFramesObj[origin].reloadObj = _createReloadObject(origin);\r\n        }\r\n        _reloadIFrame(origin);\r\n    }\r\n\r\n    /**\r\n     * Sets the iFrame to reload indicating time and counting down the retries\r\n     * @param domain\r\n     */\r\n    function _reloadIFrame(domain){\r\n        _log(\"Reload try for domain \"  + domain + \" ,retries left \"  + iFramesObj[domain].reloadObj.retriesLeft,  logType.INFO , \"_reloadIFrame\");\r\n        iFramesObj[domain].reloadObj.retriesLeft = iFramesObj[domain].reloadObj.retriesLeft - 1;\r\n        if(iFramesObj[domain].reloadObj.setLocationTimeout){\r\n            clearTimeout(iFramesObj[domain].reloadObj.setLocationTimeout);\r\n        }\r\n        if(iFramesObj[domain].reloadObj.retry){\r\n            iFramesObj[domain].reloadObj.setLocationTimeout =  setTimeout(_createIFrameLocationFunction(domain), iFramesObj[domain].reloadInterval);\r\n        }else{\r\n            iFramesObj[domain].reloadObj.retry = true;\r\n            _createIFrameLocationFunction(domain)();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates a function that sets the iFrames src and times a timeout for the reload\r\n     * @param domain\r\n     * @return {Function}\r\n     */\r\n    function _createIFrameLocationFunction(domain){\r\n        return function(){\r\n            iFramesObj[domain].iFrameOnloadTimeout = setTimeout(function(){\r\n                _validateFrame(domain, { error: { code: 404, message: \"Frame did not trigger load\" }});\r\n            }, iFrameOnLoadTimeout);\r\n            _setIFrameLocation(iFramesObj[domain].elem,iFramesObj[domain].url);\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Sets the iFrame location using a cache bust mechanism,\r\n     * making sure the iFrame is actually loaded and not from cache\r\n     * @param element\r\n     * @param src\r\n     */\r\n    function _setIFrameLocation(element, src){\r\n        src += (src.indexOf(\"?\") > 0 ? \"&bust=\" : \"?bust=\");\r\n        src += new Date().getTime();\r\n        src += \"&loc=\" + encodeURIComponent(location.protocol + \"//\" + location.host);\r\n        _log(\"Setting iFrame to URL: \" + src, logType.INFO, \"_setIFrameLocation\");\r\n        element.setAttribute(\"src\", src);\r\n    }\r\n\r\n    /**\r\n     * Creates the retry object for the retry session\r\n     * @param domain\r\n     * @return {Object}\r\n     */\r\n    function _createReloadObject(domain){\r\n        _log(\"Creating reload object \" + domain,  logType.INFO , \"_createReloadObject\");\r\n        var retryCount = iFramesObj[domain].maxReloadRetries;\r\n        return {\r\n            retriesLeft : retryCount\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Cleans up the transient reload object\r\n     * @param domain\r\n     */\r\n    function _cleanUpReloadObject(domain){\r\n        _log(\"Cleaning up reload object for this instance\" + domain,  logType.INFO , \"_cleanUpReloadObject\");\r\n        if(iFramesObj[domain].reloadObj){\r\n            if(iFramesObj[domain].reloadObj.setLocationTimeout){\r\n                clearTimeout(iFramesObj[domain].reloadObj.setLocationTimeout);\r\n            }\r\n            iFramesObj[domain].reloadObj = null;\r\n            delete iFramesObj[domain].reloadObj;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Deletes any properties we set on the original request\r\n     * Cleanup\r\n     * @param reqObj\r\n     */\r\n    function _cleanRequest(reqObj) {\r\n        var properties = [\"callId\", \"responseType\"];\r\n        for (var i = 0; i < properties.length; i++) {\r\n            reqObj[properties[i]] = null;\r\n            delete reqObj[properties[i]];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Protected method for executing callbacks\r\n     * @param func\r\n     * @param context\r\n     * @param data\r\n     */\r\n    function _runCallBack(func, context, data) {\r\n        if (func && typeof func === 'function') {\r\n            try {\r\n                func.call(context || null, data);\r\n            } catch (err) {\r\n                _log(\"Error in executing callback: \" + err, logType.ERROR, \"runCallback\");\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles messages from the iFrames\r\n     * @param messageEvent\r\n     */\r\n    function _handleMessage(messageEvent) {\r\n        var result, origin;\r\n        try {\r\n            origin = messageEvent.origin;\r\n            if(!iFramesObj[origin]){//This frame isn't ours! we don't want to know what it's doing!\r\n                return;\r\n            }\r\n            result = _parseJSONString(messageEvent.data);\r\n            result.body = _parseJSONString(result.body);//Workaround for APIs that don't return JSON properly but return strings....\r\n        } catch (exc) {\r\n            result = null;\r\n            _log(\"Error in handling message from frame:\"  + exc + \" origin: \" + origin, logType.ERROR, \"_handleMessage\");\r\n        }\r\n\r\n        if (result && typeof result === 'object') {\r\n            _executeMessageCallback(result, origin);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks if it actually got a string and tries to parse it\r\n     * @param str\r\n     * @returns {*}\r\n     */\r\n    function _parseJSONString(str){\r\n        var res = str;\r\n        if(typeof  str === 'string') {\r\n            try {\r\n                res = JSON.parse(str);\r\n            }catch (exc){\r\n                _log(\"Error in parsing string: \" + str ,logType.DEBUG, \"_parseJSONString\");\r\n            }\r\n        }\r\n        \r\n        return res;\r\n    }\r\n\r\n    /**\r\n     * Method for logging\r\n     * @param msg\r\n     * @param type\r\n     * @param callingMethod\r\n     */\r\n    function _log(msg, type, callingMethod) {\r\n        if (window.lpTag && lpTag.log) {\r\n            if(typeof msg === 'string' && callingMethod){\r\n                msg = callingMethod + ': ' + msg;\r\n            }\r\n            lpTag.log(msg, type, transportType);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Publishes stats to lpAjax to decide if we want to report this\r\n     * @param domain\r\n     * @param data\r\n     */\r\n    function _publishMetrics(data){\r\n        if(lpTag.taglets.lpAjax && lpTag.taglets.lpAjax.publishMetrics){\r\n            if(data.tags && data.tags.constructor === Array){\r\n                data.tags.push({ transport: transportType });\r\n            }\r\n            lpTag.taglets.lpAjax.publishMetrics(data);\r\n        }\r\n    }\r\n\r\n    //Exposed API\r\n    var publicAPI = {\r\n        v: version,\r\n        name: transportType,\r\n        init: init,\r\n        issueCall: issueCall,\r\n        isValidRequest: isValidRequest,\r\n        getVersion: function () { return version; },\r\n        getName: function () { return transportType; },\r\n        configure: configure,\r\n        getFrameData: getFrameData,\r\n        inspect: function () {\r\n            return {\r\n                name: transportType,\r\n                version: version,\r\n                callsMade: callCount,\r\n                errorsFound: errorCount,\r\n                pending: pendingCount,\r\n                defaults: rDefaults,\r\n                iFrameList: _cloneSimpleObj(iFrameList),\r\n                activeFrames: getAllFramesData()\r\n            };\r\n        }\r\n    };\r\n\r\n    /******************* Initialise public API ********************/\r\n\r\n    init();\r\n\r\n    return publicAPI;\r\n})(window);\r\n\r\n/**\r\n * User: michaeld\r\n * This taglet wraps lpajax taglet with the relevant transports (jsonp + postmessage).\r\n * We do this because lpTag can only call one init function, and this taglet will call init on all other taglets.\r\n */\r\nwindow.lpTag = lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n\r\nlpTag.taglets.lpTransporter = lpTag.taglets.lpTransporter || (function () {\r\n\r\n    var _name = \"lpTransporter\";\r\n    var _v = \"1.1.0\";\r\n\r\n    var _conf = {\r\n        taglets: ['lpAjax' ,'lpajax_utils', 'jsonp', 'postmessage']\r\n    };\r\n\r\n    function _log(msg, lvl) {\r\n        if (window.lpTag && lpTag.log) {\r\n            lpTag.log(msg, lvl, _name);\r\n        }\r\n    }\r\n\r\n    function init(cfg) {\r\n\r\n        for (var i = 0; i < _conf.taglets.length; i++) {\r\n            var tgl = lpTag.taglets[_conf.taglets[i]];\r\n            try {\r\n                tgl.init();\r\n                _log('Called init on taglet: ' + _conf.taglets[i], 'DEBUG');\r\n            }\r\n            catch (e) {\r\n                _log('Error init taglet:' + _conf.taglets[i] + '  e=' + e, 'ERROR');\r\n            }\r\n        }\r\n\r\n        for (var j = 0; i < _conf.taglets.length; j++) {\r\n            var tglt = lpTag.taglets[_conf.taglets[j]];\r\n            try {\r\n                if ((typeof (tglt.start) === 'function')) {\r\n                    tglt.start();\r\n                }\r\n                _log('Called start on taglet: ' + _conf.taglets[j], 'DEBUG');\r\n            }\r\n            catch (e) {\r\n                _log('Error start taglet: ' + _conf.taglets[j] + 'e= ' + e, 'ERROR');\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        v: _v,\r\n        name: _name,\r\n        init: init\r\n    };\r\n\r\n})();","parameters":null},{"name":"jsLoader","code":"/**\r\n * This function is for loading JS files with dependencies between them and acting after they have loaded\r\n * This function expects a configuration object to be passed in.\r\n *\r\n * Configuration explanation:\r\n * loadObj: is the configuration of whats to be loaded, can get two type of properties:\r\n * 1 - String - a url of a Javascript file that needs downloading\r\n * 2 - Object - defines a dependency and a url\r\n * url - string url of Javascript file to be downloaded\r\n * dependency - a string or a collection of strings naming the keys of the Scripts that need to be loaded before this script can downloaded\r\n * success: the callback for successful completion of all Javascript downloads\r\n * error:  the callback if one or more files fail, note some browsers like IE8 will never let us know that something failed\r\n * context: execution context for the callbacks\r\n *\r\n * Configuration sample:\r\n * configObj = {\r\n * loadObj: {//This is the main object here you can set a key with a value of a script to load\r\n * jq: \"http://code.jquery.com/jquery-1.10.2.min.js\",\r\n * us: \"http://underscorejs.org/underscore-min.js\",\r\n * bb: { dependency: \"us\", url: \"http://backbonejs.org/backbone-min.js\" },//If you want dependecies you need to define it as an object\r\n * mr: { dependency: [\"bb\" , \"jq\"] , url: \"http://marionettejs.com/downloads/backbone.marionette.min.js\" }//the url is the script and the dependency can be an array of keys that need to complete before\r\n * _: { url: \"http://underscorejs.org/underscore.js\", success: function(data){  }, error: function(data){ } }//the url is the script and the success and error methods are callbacks for loading that file\r\n * },\r\n * success: function (data) {},\r\n * error: function (errData) {},\r\n * context: window\r\n * };\r\n */\r\n\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n\r\nlpTag.taglets.jsLoader = lpTag.taglets.jsLoader || (function (window) {\r\n\r\n    /*********************** SETUP ***********************/\r\n    var name = \"jsLoader\",\r\n        version = \"1.0.1\",\r\n        downloadCount = 0,\r\n        errorCount = 0,\r\n        loadRequestCount = 0,\r\n        SCRIPT_STATE = {\r\n            LOADING: \"LOADING\",\r\n            SUCCESS: \"SUCCESS\",\r\n            ERROR: \"ERROR\"\r\n        };\r\n\r\n    /*********************** PUBLIC VARS ***********************/\r\n\r\n    var scripts = {};\r\n\r\n    /*********************** PUBLIC METHODS ***********************/\r\n\r\n    /**\r\n     * Validates a request by checking all dependencies are listed in the queue\r\n     * All request have a URL string (we do not validate the actual URL)\r\n     * @param loadObj\r\n     * @return {Object}\r\n     */\r\n    function validRequest(loadObj) {\r\n        var missingKeys = [], invalidUrls = [], firstUrl = false;\r\n        for (var key in loadObj) {\r\n            if (typeof loadObj[key] === 'string' || loadObj[key].url) {\r\n                if (loadObj[key].dependency) {\r\n                    var missingObj = _checkDependencyChain(loadObj, loadObj[key].dependency);\r\n                    if (missingObj.length > 0) {\r\n                        missingKeys = missingKeys.concat(missingObj);\r\n                    }\r\n                } else if (typeof loadObj[key] === 'string' || typeof loadObj[key].url === 'string') {\r\n                    firstUrl = true;\r\n                } else {\r\n                    invalidUrls.push(loadObj[key]);\r\n                }\r\n\r\n            } else if (typeof loadObj[key] !== 'string') {\r\n                invalidUrls.push(key);\r\n            }\r\n        }\r\n        return {\r\n            missingKeys: missingKeys,\r\n            invalidUrls: invalidUrls,\r\n            requestValid: (missingKeys.length === 0 && invalidUrls.length === 0 && firstUrl)\r\n        };\r\n    }\r\n\r\n    function init() {\r\n        lpTag.log(\"JSLoader was initialised\", 'DEBUG', name);\r\n    }\r\n\r\n    /**\r\n     * Main function to start the download\r\n     * Is scoped so can be called multiple times\r\n     * @param loadConfig\r\n     */\r\n    function loadWithDependencies(loadConfig) {\r\n        loadRequestCount = loadRequestCount + 1;\r\n        var url = \"\";\r\n        //loadObj, success, error {\r\n        if (loadConfig && loadConfig.loadObj) {\r\n            var requestValidation = validRequest(loadConfig.loadObj);\r\n            if (requestValidation.requestValid) {\r\n                loadConfig.startTime = new Date();\r\n                for (var key in loadConfig.loadObj) {\r\n                    if (loadConfig.loadObj[key] !== true && !loadConfig.loadObj[key].dependency) {\r\n                        url = loadConfig.loadObj[key].url || loadConfig.loadObj[key];\r\n                        _loadScript(url, loadConfig.context, _scriptLoaded(key, loadConfig));\r\n                    }\r\n                }\r\n            } else {\r\n                _runCallback(loadConfig.error, loadConfig.context || null, requestValidation);\r\n            }\r\n        }\r\n    }\r\n\r\n    /*********************** PRIVATE METHODS ***********************/\r\n\r\n    /*********************** PUBLIC METHODS ***********************/\r\n\r\n    /**\r\n     * Returns information about this library\r\n     * @return {Object}\r\n     */\r\n    function inspect() {\r\n        return {\r\n            version: version,\r\n            name: name,\r\n            errors: errorCount,\r\n            downloads: downloadCount,\r\n            configsCount: loadRequestCount\r\n        };\r\n    }\r\n\r\n    /*********************** PRIVATE METHODS ***********************/\r\n\r\n    /**\r\n     * Validates the dependency chain\r\n     * Making sure that every dependency is listed in the configuration\r\n     * @param loadObj\r\n     * @param dependencyArray\r\n     * @return {Array}\r\n     */\r\n    function _checkDependencyChain(loadObj, dependencyArray) {\r\n        var missingKeys = [];\r\n\r\n        dependencyArray = dependencyArray.constructor === Array ? dependencyArray : [dependencyArray];\r\n        for (var i = 0; i < dependencyArray.length; i++) {\r\n            if (!loadObj[dependencyArray[i]]) {\r\n                missingKeys.push(dependencyArray[i]);\r\n            }\r\n        }\r\n        return missingKeys;\r\n    }\r\n\r\n    /**\r\n     * Marks a file loaded as erroneously\r\n     * This will happen only in browsers that support onerror for script loading\r\n     * @param key\r\n     * @param url\r\n     * @param loadConfig\r\n     * @return {Boolean}\r\n     */\r\n    function _markError(key, url, loadConfig) {\r\n        errorCount = errorCount + 1;\r\n        loadConfig.loadError = loadConfig.loadError || [];\r\n        loadConfig.loadError.push({ key: key, url: url });\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Marks a file as loaded\r\n     * @param key\r\n     * @param loadConfig\r\n     * @param error\r\n     */\r\n    function _markLoaded(key, loadConfig, error) {\r\n        downloadCount = downloadCount + 1;\r\n        if (typeof loadConfig.loadObj[key] === \"object\") {\r\n            var loadItem = loadConfig.loadObj[key];\r\n            _runCallback(error && loadItem.error ? loadItem.error : loadItem.success,\r\n                loadItem.context || null,\r\n                error ? { error: true, data: loadItem} : { data: loadItem });\r\n        }\r\n        loadConfig.loadObj[key] = true;\r\n    }\r\n\r\n    /**\r\n     * Checks if all files have been loaded\r\n     * @param loadConfig\r\n     * @return {Boolean}\r\n     */\r\n    function _loadCompleted(loadConfig) {\r\n        var loadCompleted = true;\r\n        for (var scr in loadConfig.loadObj) {\r\n            if (loadConfig.loadObj.hasOwnProperty(scr) &&\r\n                loadConfig.loadObj[scr] !== true) {\r\n                loadCompleted = false;\r\n                break;\r\n            }\r\n\r\n        }\r\n        return loadCompleted;\r\n    }\r\n\r\n    /**\r\n     * Function that executes every time a single script loads\r\n     * @param key\r\n     * @param loadConfig\r\n     * @return {Function}\r\n     */\r\n    function _scriptLoaded(key, loadConfig) {\r\n        return function (url, error) {\r\n            _markLoaded(key, loadConfig, error);\r\n            if (error) {\r\n                _markError(key, url, loadConfig);\r\n            }\r\n            _checkDependency(key, loadConfig);\r\n            if (_loadCompleted(loadConfig)) {\r\n                _allConfigScriptsLoaded(loadConfig, !!loadConfig.loadError);\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Runs when all scripts have completed/failed load\r\n     * @param loadConfig\r\n     * @param error\r\n     * @private\r\n     */\r\n    function _allConfigScriptsLoaded(loadConfig, error) {\r\n        loadConfig.endTime = new Date();\r\n        setTimeout(function () {\r\n            _runCallback(error ? loadConfig.error : loadConfig.success, loadConfig.context, error ? loadConfig.loadError : loadConfig);\r\n            loadConfig = null;\r\n        }, 10);\r\n    }\r\n\r\n    /**\r\n     * Checks for dependency resolution which allows new files to start downloading\r\n     * @param loaded\r\n     * @param loadConfig\r\n     */\r\n    function _checkDependency(loaded, loadConfig) {\r\n        var unloadedDependencies;\r\n        for (var key in loadConfig.loadObj) {\r\n            if (typeof loadConfig.loadObj[key] === 'object') {\r\n                loadConfig.loadObj[key].dependency = loadConfig.loadObj[key].dependency && loadConfig.loadObj[key].dependency.constructor === Array ? loadConfig.loadObj[key].dependency : [loadConfig.loadObj[key].dependency];\r\n                unloadedDependencies = [];\r\n                for (var i = 0; i < loadConfig.loadObj[key].dependency.length; i++) {\r\n                    if (loadConfig.loadObj[key].dependency[i] !== loaded) {\r\n                        unloadedDependencies.push(loadConfig.loadObj[key].dependency[i]);\r\n                    }\r\n                }\r\n                if (unloadedDependencies.length !== loadConfig.loadObj[key].dependency.length) {\r\n                    loadConfig.loadObj[key].dependency = unloadedDependencies;\r\n                    if (unloadedDependencies.length === 0) {\r\n                        _loadScript(loadConfig.loadObj[key].url, loadConfig.loadObj[key].context, _scriptLoaded(key, loadConfig));\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load the script in the page\r\n     * @param url\r\n     * @param context\r\n     * @param callback\r\n     */\r\n\r\n    function _loadScript(url, context, callback) {\r\n        if (!scripts[url]) {\r\n            scripts[url] = _createScriptObj(SCRIPT_STATE.LOADING);\r\n            _addToCallbackQueue(callback, scripts[url].callbackQueue);\r\n            _appendScript(url, {\r\n                success: function(){\r\n                    scripts[url].state = SCRIPT_STATE.SUCCESS;\r\n                    _onScriptLoad.call(this, url, context, scripts[url].callbackQueue);\r\n                },\r\n                error:function(){\r\n                    scripts[url].state = SCRIPT_STATE.ERROR;\r\n                    _onScriptError.call(this, url, context, scripts[url].callbackQueue);\r\n                }\r\n            });\r\n        }\r\n        else if (scripts[url].state === SCRIPT_STATE.LOADING) {\r\n            _addToCallbackQueue(callback, scripts[url].callbackQueue);\r\n        } else if (scripts[url].state === SCRIPT_STATE.SUCCESS) { // script was already loaded - run the callback\r\n            _runCallback(callback, context, [url]);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns a script object\r\n     * @param state\r\n     * @param callbackQueue\r\n     * @return {Object}\r\n     */\r\n\r\n    function _createScriptObj(state, callbackQueue){\r\n        return {\r\n            state: state,\r\n            callbackQueue: callbackQueue || []\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Appends the script tag to the page and runs handlers on success/error\r\n     * @param url\r\n     * @param handlers\r\n     */\r\n\r\n    function _appendScript(url, handlers) {\r\n        var scriptCall = document.createElement(\"script\");\r\n        scriptCall.setAttribute(\"type\", \"text/javascript\");\r\n        scriptCall.setAttribute(\"charset\", \"UTF-8\");\r\n        scriptCall.onreadystatechange = scriptCall.onload = handlers.success;\r\n        scriptCall.onerror = handlers.error;\r\n        scriptCall.setAttribute(\"src\", url);\r\n        (document.head || document.getElementsByTagName(\"head\")[0]).appendChild(scriptCall);\r\n    }\r\n\r\n    /**\r\n     * When script loading has ended successfully\r\n     * @param url\r\n     * @param context\r\n     * @param callbackQueue\r\n     */\r\n\r\n    function _onScriptLoad(url, context, callbackQueue) {\r\n        var loaded = false;\r\n\r\n        if (this.readyState) {\r\n            if (!window.opera && (this.readyState === \"loaded\" || this.readyState === \"complete\")) { //Opera doesn't report on readystate reliably\r\n                loaded = true;\r\n            }\r\n        } else {\r\n            loaded = true;\r\n        }\r\n        if (loaded) {\r\n            _runCallbackQueue(url, context, callbackQueue, false);\r\n            this.onerror = this.onload = this.onreadystatechange = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * When script loading has ended unsuccessfully\r\n     * @param url\r\n     * @param context\r\n     * @param callbackQueue\r\n     */\r\n\r\n    function _onScriptError(url, context, callbackQueue){\r\n        _runCallbackQueue(url, context, callbackQueue, true);\r\n        this.onerror = this.onload = this.onreadystatechange = null;\r\n    }\r\n\r\n    /**\r\n     * Adds the callback to a queue. Its callbacks will run after the script has been loaded\r\n     * @param callbackQueue\r\n     * @param callback\r\n     */\r\n\r\n    function _addToCallbackQueue(callback, callbackQueue){\r\n        if (callbackQueue && callbackQueue.indexOf(callback) === -1) {\r\n            callbackQueue.push(callback);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * After a script has been loaded, run its callbacks\r\n     * @param url\r\n     * @param context\r\n     * @param callbackQueue\r\n     * @param hadError\r\n     */\r\n\r\n    function _runCallbackQueue(url, context, callbackQueue, hadError){\r\n        var cb;\r\n        while (callbackQueue.length){\r\n            cb = callbackQueue.pop();\r\n           _runCallback(cb, context, url, hadError);\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Runs callback function\r\n     * @param callback\r\n     * @param context\r\n     */\r\n    function _runCallback(callback, context) {\r\n        context = context || window;\r\n        if (typeof callback === \"function\") {\r\n            var args = Array.prototype.slice.call(arguments, 2);\r\n            try {\r\n                return callback.apply(context, args);\r\n            } catch (exc) {\r\n                lpTag.log(\"Failed to execute callback exc= \" + exc.message, 'ERROR', name);\r\n            }\r\n        }\r\n    }\r\n\r\n    /*********************** RETURN AREA ***********************/\r\n\r\n    return {\r\n        v: version,\r\n        init: init,\r\n        loadJS: loadWithDependencies,\r\n        validateLoadObj: validRequest,\r\n        inspect: inspect\r\n    };\r\n\r\n})(window);\r\n","parameters":null},{"name":"lpSecureStorage","code":"window.lpTag = window.lpTag || {};\nwindow.lpTag.taglets = window.lpTag.taglets || {};\n/**\n * This taglet brings an iFrame to the page and then sets information inside.\n * It uses indexedDB, local storage, secure cookie or session storage (depends on browser limitations)\n * It limits the retrieval of data to the domain from which the data was set (and any other locations passed in on the set action)\n * and all liveperson domains. All keys are made up of key + siteId to ensure uniqueness per site\n * This only works in IE8 and up in Standards mode\n * @type {*}\n */\nlpTag.taglets.lpSecureStorage = lpTag.taglets.lpSecureStorage || (function lpSecureStorage(window) {\n    var name = \"lpSecureStorage\",\n        version = \"2.0.1\",\n        sessionStorageStaticDomain = \"STATICSESSIONSTORAGE\",\n        windowLoaded = false,\n        windowLoadPendingRequests = [],\n        loadPendingFrames = [],\n        frames = {},\n        pendingFrameRequests = {},\n        pendingRequests = {},\n        domainErrors = {},\n        validResponseDomains = {},\n        requestQueue = {},\n        idCounter = 0,\n        debugMode = false,\n        frameMaxLoadTime = 7000,\n        requestMaxResponseTime = 5000,\n        errorCheckTimeout = 1000,\n        faultToleranceLevel = 10,\n        logLevel = { ERROR: \"ERROR\", DEBUG: \"DEBUG\", INFO: \"INFO\" },\n        requestTypes = {SET: \"set\", GET: \"get\", MULTIGET: \"multiget\", REMOVE: \"remove\", TOUCH: \"touch\", SELECT_STORAGE: \"selectStorage\"},\n        storageTypes = {\n            LOCALSTORAGE: \"localStorage\",\n            SESSIONSTORAGE: \"sessionStorage\",\n            INDEXEDDB: \"indexedDB\",\n            COOKIE: \"secureSessionCookie\",\n            STATICSESSIONSTORAGE: sessionStorageStaticDomain\n        },\n        errorTypes = {\n            STORAGE: \"storage_error\"\n        },\n        chosenStorages = {},\n        chosenStorageHandlers = {},\n        CHOSEN_STORAGE_KEY = \"SecureStorageClient/storageType\",\n        CROSS_DOMAIN_FEATURE = \"Common.LiveEngage_2_CrossDomainStorage\",\n        DEFAULT_APP_NAME = \"default\",\n        COBROWSE_APP_NAME = \"cobrowse\",\n        errorTimeoutId,\n        sessionStorageMethodsObj,\n        requestInProgress = {\n            set: function (state, domain) {\n                if (domain) {\n                    this[domain] = state;\n                }\n            },\n            get: function (domain) {\n                if (domain) {\n                    return this[domain];\n                }\n            }\n        };\n    /**\n     * Binds to the window message or hash change event\n     * depending on the protocol\n     */\n    bindEvent(window, \"message\", _handleMessageFromFrame);\n\n    _determineLoadState();\n\n    function init() {\n    }\n\n    /**\n     * Public get storage type method for a specified frame url\n     * The entire chosenStorage object is returned when no url supplied\n     * @param url - frame url to get storage of\n     */\n    function getStorageType(url) {\n        url = _getDomain(url);\n        if (url && chosenStorages[url]) {\n            return chosenStorages[url];\n        }\n\n        return chosenStorages;\n    }\n\n    /**\n     * Public get value method\n     * Clears any value passed in on the request to prevent errors\n     * @param request\n     * @returns\n     *  - single value if 'key' param passed on request or if 'keys' param consists only one key\n     *  - object with the following structure when 'keys' param used:\n     *  {\n     *      key1: value1\n     *      key2: value2\n     *      ...\n     *  }\n     */\n    function getValue(request) {\n        _cleanValue(request);\n        request.type = requestTypes.GET;\n        _handleRequest(request);\n    }\n\n    function getValues(request) {\n        _cleanValue(request);\n        request.type = requestTypes.MULTIGET;\n        _handleRequest(request);\n    }\n\n    /**\n     * Public set value method\n     * @param request\n     */\n    function setValue(request) {\n        if (request && (request.expires === -1 || request.ttl === -1)) { // TODO: remove the expires param from the API after coBrowse is updated\n            removeValue(request);\n        } else {\n            request.type = requestTypes.SET;\n            _handleRequest(request);\n        }\n    }\n\n    /**\n     * Public touch value method\n     * @param request\n     */\n    function touchValue(request) {\n        _cleanValue(request);\n        request.type = requestTypes.TOUCH;\n        _handleRequest(request);\n    }\n\n     /**\n     * Public remove value method\n     * @param request\n     */\n    function removeValue(request) { // TODO: remove the expires param from the API after coBrowse is updated\n        if (request) {\n            request.ttl = -1;\n            request.expires = -1;\n        }\n        request.type = requestTypes.REMOVE;\n        _handleRequest(request);\n    }\n\n    /**\n     * Public configure gets an object with :\n     * url - the secure storager url\n     * site - the siteid it needs\n     * debug - a flag if debug should be enabled\n     * initialStorageType - the type of the setorage to be initialized (if supplied)\n     * force - force the selected storage\n     * asyncStorageMaxRetry - number of retries to choose async storage type\n     * @param configuration\n     */\n    function configure(configuration) {\n        var domain,\n            onFrameLoadedRequest;\n\n        if (configuration && configuration.debug === true) {\n            debugMode = true;\n        }\n\n        for (var key in configuration) {\n            if (typeof configuration[key] === 'object' && configuration.hasOwnProperty(key) && configuration[key].site) {\n                //noinspection JSUnresolvedVariable\n                if (!configuration[key].app) {\n                    configuration[key].app = DEFAULT_APP_NAME;\n                }\n                if (configuration[key].url && configuration[key].url.indexOf(\"http\") === 0) {\n                    _debug(\"Configuring url \" + configuration[key].url);\n                    domain = _getDomain(configuration[key].url);\n                    if (frames[domain]) {\n                        if (chosenStorages[domain] && chosenStorages[domain][configuration[key].app]) {\n                            // run callback here\n                            _runCallback(configuration[key].chosenStorageHandler, chosenStorages[domain][configuration[key].app]);\n                        } else {\n                            _updateStorageHandlers(domain, configuration[key].app, configuration[key].chosenStorageHandler);\n                            _selectStorageType(configuration[key], domain);\n                        }\n                    } else {\n                        _updateStorageHandlers(domain, configuration[key].app, configuration[key].chosenStorageHandler);\n                        onFrameLoadedRequest = _getSelectStorageTypeRequest(configuration[key], domain);\n                        _attachFrame(configuration[key], onFrameLoadedRequest, domain);\n                    }\n                } else if (configuration[key].url === sessionStorageStaticDomain) {\n                    _configureSessionStorage(configuration[key]);\n                }\n            }\n        }\n    }\n\n    function _getSelectStorageTypeRequest(configuration, domain) {\n        return {\n            type: requestTypes.SELECT_STORAGE,\n            app: configuration.app,\n            domain: domain,\n            site: configuration.site,\n            initialStorageType: configuration.initialStorageType,\n            force: configuration.force\n        };\n    }\n\n    function _selectStorageType(configuration, domain) {\n        _handleRequest(_getSelectStorageTypeRequest(configuration, domain));\n    }\n\n    function _cleanValue(request) {\n        if (request && request.value) {\n            request.value = null;\n            delete request.value;\n        }\n        return request;\n    }\n\n    /**\n     * Makes a single request\n     * @param request\n     * @private\n     */\n    function _handleRequest(request) {\n        var domain = _getDomain(request.domain); // Get the domain, since this is localStorage different urls don't matter\n\n        if (!request.app) {\n            request.app = DEFAULT_APP_NAME;\n        }\n        if (_isConfigureRequired(request, domain)) {\n            if (request.alreadyConfigured && request.error) {\n                _runCallback(request.error, 'Could not configure storage', request.keys || request.key);\n            } else {\n                configure(_getDefaultConfiguration(request));\n            }\n        } else {\n            if (_isStorageSelectionInProgress(request, domain)) {\n                request.alreadyConfigured = true;\n            }\n            _makeRequest(request, domain);\n        }\n    }\n\n    function _isStorageSelectionInProgress(request, domain) {\n        var pendingSelectRequests = pendingFrameRequests[domain] && pendingFrameRequests[domain].filter(function(request) {\n            return request.type === requestTypes.SELECT_STORAGE;\n        }),\n        selectRequestSent = _isSelectRequestSent(request, domain),\n        storageSelectionInProgress = request.type === requestTypes.SELECT_STORAGE || selectRequestSent ||\n            pendingSelectRequests && pendingSelectRequests.length > 0;\n        return storageSelectionInProgress;\n    }\n\n    /**\n     * For any request other than internal SELECT_STORAGE requests 'configure' needs to run before\n     * @param request\n     * @param domain\n     * @returns {boolean}\n     * @private\n     */\n    function _isConfigureRequired(request, domain) {\n        var storageSelectionInProgress = _isStorageSelectionInProgress(request, domain),\n            storageSelectionFinished = !!(chosenStorages[domain] && chosenStorages[domain][request.app]);\n\n        return !storageSelectionInProgress && !storageSelectionFinished;\n    }\n\n    function _isSelectRequestSent(request, domain) {\n        if (pendingRequests) {\n            for (var id in pendingRequests) {\n                if (pendingRequests.hasOwnProperty(id) &&\n                    pendingRequests[id].type === requestTypes.SELECT_STORAGE &&\n                    pendingRequests[id].domain === domain &&\n                    (pendingRequests[id].app === request.app)) {\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n\n    /**\n     * Builds default configuration object for 'configure' call\n     * @param request\n     * @returns {{}}\n     * @private\n     */\n    function _getDefaultConfiguration(request) {\n        var conf = {};\n\n        conf[request.app] = {\n            site: request.site,\n            app: request.app,\n            url: request.domain,\n            initialStorageType: request.initialStorageType,\n            chosenStorageHandler: _handleRequest.bind(this, request)\n        };\n\n        return conf;\n    }\n\n    function _makeRequest(request, domain) {\n        var forceSession = request.domain === sessionStorageStaticDomain;\n\n        if (forceSession) {\n            _makeSessionStorageRequest(request);\n        } else {\n            if (!requestInProgress.get(domain)) {\n                makeIFrameStorageRequest(request, domain);\n            } else {\n                _addRequestToDomainQueue(request, domain);\n            }\n        }\n    }\n\n    /**\n     * Creates the session storage constant object if the underlying libraries exist\n     * Returns it's state if session storage works\n     * @returns {*}\n     * @private\n     */\n    function _isStorageEnabled() {\n        if (lpTag.storageMethods && !sessionStorageMethodsObj) {\n            sessionStorageMethodsObj = lpTag.storageMethods;\n        }\n        if (sessionStorageMethodsObj) {\n            return sessionStorageMethodsObj.isSessionStorageEnabled();\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * Makes a session storage request locally\n     * @param request\n     * @private\n     */\n    function _makeSessionStorageRequest(request) {\n        var key,\n            result;\n\n        if (_isStorageEnabled()) {\n            switch (request.type) {\n                case requestTypes.GET:\n                case requestTypes.MULTIGET:\n                    result = _multiGetSessionData(request);\n                    _runCallback(request.success, result, request.keys || request.key);\n                    break;\n                case requestTypes.SET:\n                    key = '' + request.site + request.key;\n                    _setSessionData(key, request);\n                    _runCallback(request.success, request.value, request.key);\n                    break;\n                case requestTypes.TOUCH:\n                    // no need to re-set the data here, it's without timestamps\n                    // only check if the data exists, run error callback otherwise\n                    result = _getSessionData('' + request.site + request.key, request);\n                    _runCallback(result ? request.success : request.error, result ? result : {\"error\": \"No data to touch\"}, request.key);\n                    break;\n                case requestTypes.REMOVE:\n                    key = '' + request.site + request.key;\n                    result = {\"error\": \"Object not found.\"};\n                    if (_removeSessionData(key, request)) {\n                        result = void 0;\n                    }\n                    _runCallback(result && result.error && request.error ? request.error : request.success, result && result.error || result, request.key);\n                    break;\n            }\n        } else {\n            _runCallback(request.error || request.success, {error: \"SessionStorage is not active\", code: 500}, request.key);\n        }\n    }\n\n    /**\n     * Extracts the value as it appears in the session storage\n     * @param key\n     * @returns {*}\n     * @private\n     */\n    function _getRawSessionData(key) {\n        var result = sessionStorageMethodsObj.getSessionData(key);\n        try {\n            result = (result === \"\") ? \"\" : JSON.parse(result);\n        } catch (exc) {\n        }\n        return (result !== '' ? result : null);\n    }\n\n    /**\n     * Extracts the data as it appears in the SecureStorage convention\n     * @param key\n     * @param request\n     * @returns {*}\n     * @private\n     */\n    function _getSessionData(key, request) {\n        var result = _getRawSessionData(key);\n        if (request.appName && result !== null && typeof result === 'object') {\n            result = result[request.appName];\n        }\n        return (result !== '' ? result : null);\n    }\n\n    /**\n     * Extracts multiple keys data when request.keys are provided or one\n     * data entry when request.key provided\n     * @param request\n     * @returns {*}\n     * @private\n     */\n    function _multiGetSessionData(request) {\n        var returnObject = false,\n            hasData = false,\n            keys,\n            result = {},\n            data;\n\n        if (request.keys && Array.isArray(request.keys)) {\n            returnObject = true;\n            keys = request.keys;\n        } else {\n            keys = [request.key];\n        }\n\n        keys.forEach(function (key) {\n            data = _getSessionData('' + request.site + key, request);\n            if (data) {\n                result[key] = data;\n                hasData = true;\n            }\n        });\n\n        if (hasData) {\n            result = returnObject ? result : result[keys[0]];\n        } else {\n            result = null;\n        }\n\n        return result;\n    }\n\n    /**\n     * Sets a value in the Secure Storage convention\n     * @param key\n     * @param request\n     * @returns {*}\n     * @private\n     */\n    function _setSessionData(key, request) {\n        var data = _getRawSessionData(key);\n        if (data === null) {\n            data = {};\n        }\n        if (typeof data === 'object') {\n            data[request.appName] = request.value;\n            return sessionStorageMethodsObj.setSessionData(key, _stringify(data));\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * Removes data from the session storage\n     * @param key\n     * @param request\n     * @returns {*}\n     * @private\n     */\n    function _removeSessionData(key, request) {\n        var foundKeyAndAppName = false,\n            keyHasOtherProps = false,\n            data = _getRawSessionData(key);\n\n        if (data !== null && typeof data === 'object' && data.hasOwnProperty(request.appName)) {\n            data[request.appName] = null;\n            delete data[request.appName];\n            for (var dataKey in data) {\n                if (data.hasOwnProperty(dataKey)) {\n                    keyHasOtherProps = true;\n                    break;\n                }\n            }\n            foundKeyAndAppName = true;\n        }\n        if (foundKeyAndAppName && keyHasOtherProps) {//We're updating the data structure\n            return sessionStorageMethodsObj.setSessionData(key, _stringify(data));\n        } else if (foundKeyAndAppName) {//We found data and it's the last bit\n            return sessionStorageMethodsObj.removeSessionData(key);\n        } else {//Nothing to do, no data found\n            return false;\n        }\n    }\n\n    /**\n     * Creates a postmessage cross iFrame request\n     * @param request\n     * @param domain\n     */\n    function makeIFrameStorageRequest(request, domain) {\n        //noinspection JSUnresolvedVariable\n        var chosenStorage;\n        if (request &&\n            ((request.success || request.error) && (request.key || request.keys) && request.appName || request.type === requestTypes.SELECT_STORAGE) &&\n            request.domain &&\n            request.site) {\n            if (!windowLoaded) {\n                windowLoadPendingRequests.push(function () {\n                    _handleRequest(request);\n                });\n            } else {\n                if (frames[domain]) {\n                    //We have valid storage to service requests or no storage was yet chosen and this request will configure it\n                    chosenStorage = request.app && chosenStorages[domain] && chosenStorages[domain][request.app];\n                    if (chosenStorage && request.type === requestTypes.SELECT_STORAGE) {\n                        _runChosenStorageHandlers(request.domain, request.app, chosenStorage);\n                        _runNextRequestFromQueue(request.domain);\n                    } else if (!chosenStorage || (chosenStorage && !chosenStorage.error)) {\n                        _addToPendingQueue(request);\n                        _sendPostMessageQuery(request);\n                        _debug(\"Made request for key: \" + request.key + \" appName: \" + request.appName);\n                    } else {\n                        _runCallback(request.error || request.success, null, request.key);\n                        _debug(\"No Storage Selected, Blocked request for key: \" + request.key + \" appName: \" + request.appName);\n                    }\n                } else {\n                    //noinspection JSUnresolvedVariable\n                    _attachFrame(request, request);\n                }\n            }\n        }\n    }\n\n    /**\n     * Writes a request to a specific domain queue to be called\n     * These requests have not begun\n     * @param request\n     * @param domain\n     * @private\n     */\n    function _addRequestToDomainQueue(request, domain) {\n        requestQueue[domain] = typeof requestQueue[domain] === 'undefined' ? [] : requestQueue[domain];\n        requestQueue[domain].push(request);\n    }\n\n    /**\n     * Checks our pending request queue for requests\n     * that have not returned within a reasonable time frame\n     * @private\n     */\n    function _checkForErrors() {\n        var now = new Date().getTime(),\n            activeRequests = false,\n            diff;\n\n        if (errorTimeoutId) {\n            clearTimeout(errorTimeoutId);\n            errorTimeoutId = null;\n        }\n\n        for (var id in pendingRequests) {\n            if (pendingRequests.hasOwnProperty(id)) {\n                diff = 0;\n                diff = now - pendingRequests[id].startTime;\n                if (diff >= requestMaxResponseTime) {\n                    _error(\"iFrame not responding in time to requests, domain: \" + pendingRequests[id].domain);\n                    _dispatchResult(id, pendingRequests[id].key, null, true);\n                } else {\n                    activeRequests = true;\n                }\n            }\n        }\n        _setErrorTimeout(activeRequests);\n    }\n\n    /**\n     * Sets the next time we check for errors\n     * @param enable\n     * @private\n     */\n    function _setErrorTimeout(enable) {\n        if (enable && !errorTimeoutId) {\n            errorTimeoutId = setTimeout(_checkForErrors, errorCheckTimeout);\n        }\n    }\n\n    /**\n     *\n     * @param domain\n     * @param error\n     * @private\n     */\n    function _manageErrorState(domain, error) {\n        if (error) {\n            if (typeof domainErrors[domain] === 'undefined') {\n                domainErrors[domain] = 1;\n            } else {\n                domainErrors[domain] = domainErrors[domain] + 1;\n            }\n        } else {\n            domainErrors[domain] = 0;\n        }\n\n        _debug(\"Domain \" + domain + \" error count: \" + domainErrors[domain], \"_manageErrorState\");\n        if (domainErrors[domain] > faultToleranceLevel) {\n            _frameLoadError(requestQueue[domain], domain, \"iFrame not responding in time to requests\");\n        }\n    }\n\n    /**\n     * Removes the iFrame from the DOM\n     * and cleans up the internal object\n     * @param domain\n     */\n    function _removeIFrame(domain) {\n        if (frames[domain] && frames[domain].parentNode) {\n            frames[domain].parentNode.removeChild(frames[domain]);\n            frames[domain] = null;\n            delete frames[domain];\n            domainErrors[domain] = 0;\n            _error(\"Removed iFrame for domain\", \"_removeIFrame\");\n        }\n    }\n\n\n    /**\n     * Sets the window load status to be ASAP after page has begun to download\n     * when the body opens\n     */\n    function _determineLoadState() {\n        if (!document.body) {\n            setTimeout(_determineLoadState, 0);\n        } else {\n            _loaded();\n        }\n    }\n\n    /**\n     * Listens for incoming messages fro the IFrame\n     * @param msg\n     */\n    function _handleMessageFromFrame(msg) {\n        if (msg && msg.data && validResponseDomains[msg.origin]) {\n            _runListeners(msg.data, msg.origin);\n        }\n    }\n\n    /**\n     * Deletes requests after they've been completed\n     * @param id\n     */\n    function _deletePendingRequest(id) {\n        pendingRequests[id] = null;\n        delete  pendingRequests[id];\n    }\n\n    /**\n     * Runs all listeners to this request\n     * @param data\n     * @param origin\n     */\n    function _runListeners(data, origin) {\n        var id,\n            key,\n            responseData,\n            res = _parseResponse(data),\n            domain;\n\n        if (res) {\n            id = res.id;\n            key = res.key || res.keys;\n            responseData = typeof res.value !== 'undefined' ? res.value : res.error;\n\n            if (CHOSEN_STORAGE_KEY === key) {\n                _handleStorageSelection(res, origin);\n                domain = _getDomain(origin);\n                _dispatchResult(id, key, responseData, !!res.error, domain);\n            } else {\n                _dispatchResult(id, key, responseData, !!res.error);\n                _debug(\"Got result for key: \" + key + \" appName: \" + res.appName);\n            }\n        }\n    }\n\n    /**\n     * Handles setting selected storage and notifying any listeners\n     * @param res\n     * @param origin\n     * @private\n     */\n    function _handleStorageSelection(res, origin) {\n        // In case the message key represents a storage type selection message\n        // Save it in chosenStorages for that origin for later use\n        // TODO: remove this after coBrowse move to our CDN\n        var coBrowseApp,\n            requestIndex;\n\n        if (!res.app) { // that means it's coBrowse with old CDN\n            if (pendingRequests) {\n                for (var id in pendingRequests) {\n                    if (pendingRequests.hasOwnProperty(id) && _isSelectStorageRequestToOldCDN(origin, pendingRequests[id])) {\n                        coBrowseApp = pendingRequests[id].app;\n                        requestIndex = id;\n                        break;\n                    }\n                }\n                if (requestIndex) {\n                    _deletePendingRequest(requestIndex);\n                }\n            }\n            if (pendingFrameRequests && !requestIndex) {\n                for (var domain in pendingFrameRequests) {\n                    if (pendingFrameRequests.hasOwnProperty(domain) && domain === origin && Array.isArray(pendingFrameRequests[domain])) {\n                        /* jshint -W083 */\n                        pendingFrameRequests[domain].every(function (request, index) {\n                            if (_isSelectStorageRequestToOldCDN(origin, request)) {\n                                coBrowseApp = request.app;\n                                requestIndex = index;\n                                return false;\n                            }\n                            return true;\n                        });\n                        /* jshint +W083 */\n                    }\n                    if (typeof requestIndex !== \"undefined\") {\n                        pendingFrameRequests[domain].splice(requestIndex, 1);\n                        break;\n                    }\n                }\n            }\n            res.app = coBrowseApp || DEFAULT_APP_NAME;\n        }\n        // end of TODO\n        chosenStorages[origin] = chosenStorages[origin] || {};\n        chosenStorages[origin][res.app] = res.value;\n        _debug(\"Got storage type: \" + res.value + \" for origin: \" + origin + \" appName: \" + res.appName);\n        _runChosenStorageHandlers(origin, res.app, res.value);\n    }\n\n    function _isSelectStorageRequestToOldCDN(origin, request) {\n        if (request.type === requestTypes.SELECT_STORAGE &&\n            request.domain === origin &&\n            // while old CDN is used, cobrowse can be configured with app = \"cobrowse\" or without an app\n            (request.app === DEFAULT_APP_NAME || request.app === COBROWSE_APP_NAME)) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * Invokes supplied handlers for chosenStorage if any\n     * @param origin\n     * @param app\n     * @param value\n     * @private\n     */\n    function _runChosenStorageHandlers(origin, app, value) {\n        if (chosenStorageHandlers[origin] && chosenStorageHandlers[origin][app] && chosenStorageHandlers[origin][app].length > 0) {\n            chosenStorageHandlers[origin][app].forEach(function (handler) {\n                _runCallback(handler, value);\n            });\n            chosenStorageHandlers[origin][app] = [];\n        }\n    }\n\n    /**\n     * Function for running callbacks and cleaning the queue\n     * @param id\n     * @param key\n     * @param data\n     * @param error\n     * @param _domain\n     * @private\n     */\n    function _dispatchResult(id, key, data, error, _domain) {\n        var listener = _getListener(id),\n            domain = _domain || listener && _getDomain(listener.domain);\n\n        if (listener) {\n            _runResponses(listener, data, key, error);\n        }\n        if (id) {\n            _deletePendingRequest(id);\n        }\n        requestInProgress.set(false, domain);\n        _manageErrorState(domain, error);\n        _runNextRequestFromQueue(domain);\n    }\n\n    function _runNextRequestFromQueue(domain) {\n        if (requestQueue[domain] && requestQueue[domain].length > 0) {\n            _handleRequest(requestQueue[domain].shift());\n        }\n    }\n\n    /**\n     * Returns a list of listeners for this data\n     * @param id - the id of the specific request made\n     * @return {Array} - returns an array of callbacks to trigger\n     */\n    function _getListener(id) {\n        if (id && pendingRequests[id]) {\n            return pendingRequests[id];\n        }\n    }\n\n    /**\n     * Runs all the requests pending for that key\n     */\n    function _runResponses(listener, responseData, key, error) {\n        if (error) {\n            _runCallback(listener.error || listener.success, responseData, key);\n        } else {\n            _runCallback(listener.success, responseData, key);\n        }\n    }\n\n    /**\n     * Parses the response that we got for the event\n     * @param res\n     * @return {String}\n     */\n    function _parseResponse(res) {\n        try {\n            res = decodeURIComponent(res);\n            res = JSON.parse(res);\n        } catch (exc) {\n        }\n        return res;\n    }\n\n    /**\n     * This function was added because of incompatibility between the JSON.stringify and Prototype.js library\n     * When a costumer uses Prototype.js library, It overrides the Array.prototype.toJSON function the the native JSON\n     * uses. This causes arrays to be double quoted and Shark to fail on those SDEs.\n     * The function accepts a value and and uses the native JSON.stringify\n     * Can throw an exception (same as JSON.stringify).\n     */\n    function _stringify(value) {\n        var stringified, toJSONPrototype;\n        if (typeof Array.prototype.toJSON === 'function') {\n            toJSONPrototype = Array.prototype.toJSON;\n            delete Array.prototype.toJSON;\n            try {\n                stringified = JSON.stringify(value);\n            } catch (e) {\n                Array.prototype.toJSON = toJSONPrototype;\n                throw e;\n            }\n            Array.prototype.toJSON = toJSONPrototype;\n        } else {\n            stringified = JSON.stringify(value);\n        }\n        return stringified;\n    }\n\n    /**\n     * Runs a callback function\n     * @param func\n     * @param data\n     * @param key\n     */\n    function _runCallback(func, data, key) {\n        if (typeof func === 'function') {\n            try {\n                func(data, key);\n            } catch (exc) {\n            }\n        }\n    }\n\n    /**\n     * Binds a DOM event to an object\n     * @param elem\n     * @param eventName\n     * @param callback\n     */\n    function bindEvent(elem, eventName, callback) {\n        if (window.addEventListener) {\n            elem.addEventListener(eventName, callback, false);\n        } else {\n            elem.attachEvent(\"on\" + eventName, callback);\n        }\n    }\n\n    /**\n     * Configures session storage with the same conventions as\n     * attaching an iFrame\n     * @param configuration\n     * @private\n     */\n    function _configureSessionStorage(configuration) {\n        var result = {app: configuration.app, value: \"NONE\"};\n\n        _updateStorageHandlers(sessionStorageStaticDomain, configuration.app, configuration.chosenStorageHandler);\n        if (_isStorageEnabled()) {\n            frames[sessionStorageStaticDomain] = true;\n            result.value = storageTypes.STATICSESSIONSTORAGE;\n        }\n        _handleStorageSelection(result, sessionStorageStaticDomain);\n    }\n\n    /**\n     * Attaches the iFrame to the DOM\n     * and sets it to load\n     * @param configuration - the frame configuration\n     * @param domain - the domain to attach iFrame at\n     * @returns {*}\n     * @private\n     */\n    function _attachFrame(configuration, onFrameLoadedRequest, domain) {\n        var frame,\n            url = configuration.url || configuration.domain,\n            site = configuration.site,\n            providerId = configuration.providerId;\n\n        domain = domain || _getDomain(url);\n\n        if (!frames[domain]) { // 'load' event of the frame not yet happened, thus pendingFrameRequests for the damain not yet cleaned\n            if (pendingFrameRequests[domain]) { // frame was created, but its 'load' event not yet happened\n                _addToPendingFrameRequests(domain, onFrameLoadedRequest);\n            } else { // frame was not created\n                _debug(\"Attaching iFrame: \" + url + \" domain: \" + domain);\n                frame = createIFrame();\n                validResponseDomains[domain] = true;\n                frame.setAttribute(\"src\", _buildCurrentDomainOnUrl(url, site, providerId, configuration));\n                pendingFrameRequests[domain] = [];\n                _addToPendingFrameRequests(domain, onFrameLoadedRequest);\n\n                if (!windowLoaded) {\n                    loadPendingFrames.push(_createBindAndAppend(domain, frame));\n                } else {\n                    _createBindAndAppend(domain, frame)();\n                }\n            }\n        }\n\n        return frame;\n    }\n\n    function _addToPendingFrameRequests(domain, request) {\n        if (request) {\n            pendingFrameRequests[domain].push(request);\n        }\n    }\n\n    function _updateStorageHandlers(domain, app, callback) {\n        if (callback) {\n            chosenStorageHandlers[domain] = chosenStorageHandlers[domain] || {};\n            chosenStorageHandlers[domain][app] = chosenStorageHandlers[domain][app] || [];\n            chosenStorageHandlers[domain][app].push(callback);\n        }\n    }\n\n    /**\n     * Creates an iFrame with all the needed properties\n     * for display and accessibility compliance\n     * @returns {HTMLElement}\n     */\n    function createIFrame() {\n        var frame = document.createElement(\"iframe\"),\n            style = frame.style,\n            id = \"lpSS_\" + Math.floor(Math.random() * 90000000000),\n            props = {//Hide iFrame from screen-readers\n                \"tabIndex\": \"-1\",\n                \"aria-hidden\": \"true\",\n                \"role\": \"presentation\",\n                \"title\": \"Intentionally blank\",\n                \"name\": id,\n                \"id\": id\n            };\n\n        style.width = \"0px\";\n        style.height = \"0px\";\n        style.position = \"absolute\";\n        style.top = \"-1000px\";\n        style.left = \"-1000px\";\n\t\tstyle.display = 'none';\n\n        for (var key in props) {\n            if (props.hasOwnProperty(key)) {\n                frame.setAttribute(key, props[key]);\n            }\n        }\n        return frame;\n    }\n\n    /**\n     * Adds the iFrame to the DOM, adds a timeout listener and\n     * binds to it's load event\n     * @param domain\n     * @param frame\n     * @returns function\n     * @private\n     */\n    function _createBindAndAppend(domain, frame) {\n        return function _bindAndAppend() {\n            var loadTimeout = setTimeout(function () {\n                _frameLoadError(pendingFrameRequests[domain], domain, \"unable to load iFrame for key\");\n            }, frameMaxLoadTime);\n            bindEvent(frame, \"load\", function () {\n                _onFrameLoaded(frame, domain, loadTimeout);\n            });\n            document.body.appendChild(frame);\n        };\n    }\n\n    /**\n     * In case we have an issue loading the iFrame\n     * @param requestsArray\n     * @param domain\n     * @param error\n     * @private\n     */\n    function _frameLoadError(requestsArray, domain, error) {\n        while (requestsArray.length > 0) {\n            var request = requestsArray.shift();\n            if (request.error) {\n                setTimeout(_getAsyncCallback(\n                    request.error, error || {\n                        error: error,\n                        key: request.key\n                    }, request.key), 0);\n            }\n        }\n        _removeIFrame(domain);\n    }\n\n    /**\n     * Runs the callback async\n     * @param func\n     * @param data\n     * @param key\n     * @returns {Function}\n     */\n    function _getAsyncCallback(func, data, key) {\n        return function () {\n            _runCallback(func, data, key);\n        };\n    }\n\n    function _onFrameLoaded(frame, domain, loadTimeout) {\n        if (loadTimeout) {\n            clearTimeout(loadTimeout);\n        }\n        frames[domain] = frame;\n        _debug(\"Loaded frame \" + domain);\n        _runPendingForDomain(domain);\n    }\n\n    /**\n     * Register pointer to frame\n     * Runs all pending requests for a specific iFrame\n     * @param domain\n     * @private\n     */\n    function _runPendingForDomain(domain) {\n        _debug(\"Running pending request for frame \" + domain);\n        if (pendingFrameRequests[domain]) {\n            while (pendingFrameRequests[domain].length > 0) {\n                _handleRequest(pendingFrameRequests[domain].shift());\n            }\n            pendingFrameRequests[domain] = null;\n            delete pendingFrameRequests[domain];\n        }\n    }\n\n    /**\n     * Sets the current domain so we know where we're hosted\n     * @param storagePath\n     * @param site\n     * @param configuration\n     * @return {*}\n     */\n    function _buildCurrentDomainOnUrl(storagePath, site, providerId, configuration) {\n        var port,\n            env,\n            storageFileName,\n            url;\n\n        if (storagePath && typeof storagePath === 'string') {\n            env = _getEnv();\n            storageFileName = _getStorageFileName(configuration);\n            storagePath = _getStoragePath(storagePath);\n            port = (0 < location.port.length ? \":\" + location.port : \"\");\n            url = storagePath + \"/\" + storageFileName + \"?loc=\" +\n                encodeURIComponent(location.protocol + \"//\" + location.hostname + port) +\n                \"&providerId=\" + providerId + \"&site=\" + encodeURIComponent(site) +\n                // TODO: stop passing the initialStorageType and force params after cobrowse move to our CDN\n                (configuration.initialStorageType ? \"&ist=\" + encodeURIComponent(configuration.initialStorageType) : \"\") +\n                (configuration.force ? \"&force=\" + 1 : \"\") +\n                // end of TODO\n                (env ? \"&env=\" + encodeURIComponent(env) : \"\") +\n                (_isCrossDomainEnabled() ? \"&isCrossDomain=true\" : \"\");\n        }\n\n        if(lpTag && lpTag.taglets && lpTag.taglets.caoServiceMap) {\n            url += \"&tagDomain=\" + encodeURIComponent(lpTag.taglets.caoServiceMap.getDomain(\"tagDomain\"));\n        }\n        else {\n            url += \"&tagDomain=\" + encodeURIComponent(\"tag.contactatonce.com\");\n        }\n\n        return url;\n    }\n\n    function _getStoragePath(storageUrl) {\n        var last = storageUrl.lastIndexOf(\"/\"),\n            query,\n            result;\n\n        if (last > 8) {\n            result = storageUrl.substr(0, last);\n        } else {\n            query = storageUrl.indexOf(\"?\");\n            if (query > 0) {\n                result = storageUrl.substr(0, query);\n            }\n        }\n\n        return result;\n    }\n\n    function _getStorageFileName(configuration) {\n        var fileName = \"storage.min.html\"; //Backward compatibility -Last version of secure storage\n\n        if (debugMode) {\n            fileName = \"storage.html\";\n        } else if (configuration.env) { //TODO - sync with coBrowse about storage version\n            fileName = \"storage.secure.min.html\";\n        }\n        return fileName;\n    }\n\n    /**\n     * Gets the domain including protocol\n     * @param url\n     */\n    function _getDomain(url) {\n        //noinspection JSCheckFunctionSignatures\n        var domainRegEx,\n            matches,\n            domain = null;\n\n        if (url === storageTypes.STATICSESSIONSTORAGE) {\n            domain = url;\n        } else {\n            domainRegEx = new RegExp(/(http{1}s{0,1}?:\\/\\/){0,1}([^\\/\\?]+)(\\/?)/ig);\n            matches = domainRegEx.exec(url);\n            if (matches && matches.length >= 3 && matches[2] !== \"\") {\n                domain = matches[1] + matches[2].toLowerCase(); // 0 - full match 1- HTTPS 2- domain\n            }\n        }\n        return domain;\n    }\n\n    /**\n     * Builds an object we can use to run a post message query with\n     * @param request\n     */\n    function _buildPostMessageQuery(request) {\n        var postMessageRequest = {};\n        postMessageRequest.id = request.id;\n        if (request.key) {\n            postMessageRequest.key = request.key;\n        } else if (request.keys) {\n            postMessageRequest.keys = request.keys;\n        }\n        postMessageRequest.site = request.site;\n        postMessageRequest.providerId = request.providerId;\n        postMessageRequest.appName = request.appName || \"*\";\n        postMessageRequest.type = request.type;\n        if (request.type === requestTypes.SELECT_STORAGE) {\n            postMessageRequest.initialStorageType = request.initialStorageType;\n            postMessageRequest.force = request.force;\n        }\n        if (!isNaN(request.ttl)) {\n            postMessageRequest.ttl = request.ttl;\n        }\n        if (!isNaN(request.expires)) { // TODO: remove the expires param from the request after coBrowse is updated\n          postMessageRequest.expires = request.expires;\n        }\n        if (request.app) {\n            postMessageRequest.app = request.app;\n        }\n        if (typeof request.value !== 'undefined') {\n            postMessageRequest.value = request.value;\n            //TODO - remove once coBrowse supports the new structured secure storage\n            postMessageRequest.locations = _addDefaultLocation(request.locations);\n        }\n        return postMessageRequest;\n    }\n\n    /**\n     * The locations where this data will be retrievable\n     * @param locations\n     * @deprecated - locations won't be available when cross-domain feature\n     */\n    function _addDefaultLocation(locations) {\n        if (locations) {\n            locations = locations.constructor === Array ? locations : [locations];\n        } else {\n            locations = [];\n        }\n        locations.push(document.location.hostname);\n        return locations;\n    }\n\n    /**\n     * Sends a post message query if possible\n     * @param request\n     */\n    function _sendPostMessageQuery(request) {\n        var query,\n            domain = _getDomain(request.domain);\n\n        if (frames[domain]) {\n            request.startTime = new Date().getTime();\n            query = _buildPostMessageQuery(request);\n            requestInProgress.set(true, domain);\n            _postTheMessage(query, domain);\n            _setErrorTimeout(true);\n        }\n    }\n\n    /**\n     * Posts the message to the child iFrame\n     * @param request\n     * @param domain\n     */\n    function _postTheMessage(request, domain) {\n        if (frames[domain]) {\n            frames[domain].contentWindow.postMessage(_prepareRequestData(request), domain);\n        }\n    }\n\n    /**\n     * Stringifies and encodes a message before sending it\n     * @param data\n     */\n    function _prepareRequestData(data) {\n        try {\n            data = _stringify(data);\n            data = encodeURIComponent(data);\n        } catch (exc) {\n        }\n        return data;\n    }\n\n    /**\n     * Notifies of load and handles all request prior to\n     * the body element existing\n     */\n    function _loaded() {\n        windowLoaded = true;\n        while (loadPendingFrames.length > 0) {\n            try {\n                loadPendingFrames.shift()();\n            }\n            catch (exc) {\n            }\n        }\n\n        while (windowLoadPendingRequests.length > 0) {\n            try {\n                windowLoadPendingRequests.shift()();\n            }\n            catch (exc) {\n            }\n        }\n    }\n\n    /**\n     * Creates a string Id\n     * @returns {string}\n     */\n    function _createRandomKey() {\n        idCounter++;\n        if (idCounter > 20000) {\n            idCounter = 0;\n        }\n        return \"k\" + idCounter + new Date().getTime() + parseInt(Math.random() * 100, 10);\n    }\n\n    /**\n     * Adds an item to our queue\n     * @param request\n     * @param key\n     */\n    function _addToPendingQueue(request, key) {\n        request.id = key ? key : _createRandomKey();\n        if (typeof request.value !== 'undefined') {\n            request.type = requestTypes.SET;\n        }\n        pendingRequests[request.id] = request;\n    }\n\n    function _isCrossDomainEnabled() {\n        return lpTag.features && typeof lpTag.features.getFeature === \"function\" &&\n            lpTag.features.getFeature(CROSS_DOMAIN_FEATURE);\n    }\n\n    function _getEnv() {\n        return lpTag.env;\n    }\n\n    /**\n     * Log function\n     * @param msg - the text information\n     * @param lvl - INFO or ERROR\n     */\n    function _log(msg, lvl) {\n        if (window.lpTag && lpTag.log) {\n            lpTag.log(msg, lvl, name);\n        }\n    }\n\n    /**\n     * Shorthand for errors\n     * @private\n     */\n    function _error(msg) {\n        _log(msg, logLevel.ERROR);\n    }\n\n    /**\n     * Shorthand for debug\n     * @private\n     */\n    function _debug(msg) {\n        _log(msg, logLevel.DEBUG);\n    }\n\n    /**\n     * Shorthand for info\n     * @private\n     */\n    function _info(msg) {\n        _log(msg, logLevel.INFO);\n    }\n\n    return {\n        storageTypes: storageTypes,\n        getStorageType: getStorageType,\n        getValue: getValue,\n        getValues: getValues,\n        setValue: setValue,\n        touchValue: touchValue,\n        removeValue: removeValue,\n        configure: configure,\n        sessionStorageStaticDomain: sessionStorageStaticDomain,\n        errorTypes: errorTypes,\n        v: version,\n        name: name,\n        init: init,\n        inspect: function () {\n            var configuredFrames = {};\n            for (var key in frames) {\n                if (frames.hasOwnProperty(key)) {\n                    // The configured frame consists of the\n                    // frame url and storageType (if known)\n                    configuredFrames[key] = {\n                        url: key,\n                        storageType: chosenStorages[key]\n                    };\n                }\n            }\n            return {\n                name: name,\n                version: version,\n                configuredFrames: configuredFrames\n            };\n        }\n    };\n})(window);\n","parameters":null},{"name":"caoEngager","code":"window.lpTag = window.lpTag || {};\nlpTag.caoEngager = lpTag.caoEngager || {};\nlpTag.caoEngager.engagements = lpTag.caoEngager.engagements || {};\nlpTag.caoEngager.engagements.embedded = lpTag.caoEngager.engagements.embedded || function () {\n\t\n\tvar _utility = new lpTag.caoEngager.utility();\n\tvar deviceSupportsSMSClientLaunch = new lpTag.unifiedWindow.DeviceDetector().canAttemptSMSClientLaunch();\n\t\n\tvar _embeddedConfigurations = [];\n\tvar _presencePendingElements = [];\n\tvar _engagementLoadedCustomAttribute = 'data-cao-engagement-loaded';\n\t\n\tfunction load(configuration) {\n\t\t\n\t\tif (configuration.embeddedEngagement) {\n\t\t\t\n\t\t\t_embeddedConfigurations[configuration.id] = configuration;\n\t\t\t_presencePendingElements[configuration.id] = [];\n\t\t\t\n\t\t\t_runWhenPageLoaded(function() {\n\t\t\t\t\n\t\t\t\tvar elements = document.querySelectorAll('[data-cao-engref=\\'' + configuration.embeddedEngagement.elementId + '\\']');\n\n\t\t\t\tfor (var i = 0; i < elements.length; i++){\n\t\t\t\t\tif (elements[i].dataset.caoEngagementLoaded !== \"true\") { \n\t\t\t\t\t\telements[i].setAttribute(_engagementLoadedCustomAttribute, \"true\");\n\n\t\t\t\t\t\t_presencePendingElements[configuration.id].push(elements[i]);\n\t\t\t\t\t\tvar configurationClone = JSON.parse(JSON.stringify(configuration));\n\t\t\t\t\t\t_showEmbeddedEngagement(configurationClone, elements[i]);\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(configurationClone.channel == 'mtc' && deviceSupportsSMSClientLaunch) {\n\t\t\t\t\t\t\t_populateMTCProperties(configurationClone);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\t\n\tfunction _showEmbeddedEngagement(configuration, element) {\n\t\t\n\t\t_utility.resolveReferenceId(configuration, element);\n\t\t_utility.resolveLpvars(configuration, element);\n\t\telement.onclick = function() { lpTag.taglets.caoEngager.engClicked(configuration); };\n\t\t\n\t\tlpTag.taglets.caoPresence.getPresence({\n\t\t\treferenceId: configuration.referenceId,\n\t\t\tengagementId: configuration.id,\n\t\t\tdepartmentRef: configuration.departmentRef,\n\t\t\tonSuccess: _presenceSuccessCallback,\n\t\t\tonError: _presenceErrorCallback\n\t\t});\n\t}\n\t\n\tfunction _presenceSuccessCallback(data) {\n\t\t\n\t\tvar elements = _presencePendingElements[data.engagementId];\n\t\tvar configuration = _embeddedConfigurations[data.engagementId];\n\t\t\n\n\t\tfor(var i = 0; i < elements.length; i++) {\t\n\t\t\tif((elements[i].dataset && elements[i].dataset.caoReferenceid && \n\t\t\t\telements[i].dataset.caoReferenceid === data.referenceId) ||\n\t\t\t\t(configuration.referenceId === data.referenceId && (!data.departmentRef || data.departmentRef === configuration.departmentRef))) {\n\t\t\t\t\n\t\t\t\tvar image = _createImageElement();\n                lpTag.taglets.caoEngager.handleEvent(lpTag.providerId, configuration.sessionId, configuration.engagementId, 1); //EMBEDDED_ENGAGEMENT_PRESENCE_CHECKED\n\t\t\t\t\n\t\t\t\tif (data && data.presenceStatus === 'online'){\n\t\t\t\t\timage.src =configuration.embeddedEngagement.agentAvailableImageUrl;\n\t\t\t\t\tconfiguration.isPresenceShown = true;\n\t\t\t\t\tlpTag.taglets.caoEngager.handleEvent(lpTag.providerId, configuration.sessionId, configuration.engagementId, 3);\n\t\t\t\t\tlpTag.taglets.googleAnalytics.sendGoogleAnalyticsEngagementEvent(configuration, 'Display');\n\t\t\t\t} else{\n\t\t\t\t\timage.src = configuration.embeddedEngagement.agentUnavailableImageUrl;\n\t\t\t\t\tconfiguration.isPresenceShown = false;\n\t\t\t\t\tlpTag.taglets.caoEngager.handleEvent(lpTag.providerId, configuration.sessionId, configuration.engagementId, 4);\n\t\t\t\t\tlpTag.taglets.googleAnalytics.sendGoogleAnalyticsEngagementEvent(configuration, 'Display');\n\t\t\t\t}\n\t\t\t\telements[i].appendChild(image);\n\t\t\t\telements.splice(i, 1);\n\t\t\t\ti--;\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction _presenceErrorCallback(data) {\n\t\t\n\t\tvar elements = _presencePendingElements[data.engagementId];\n\t\tvar configuration = _embeddedConfigurations[data.engagementId];\n\t\t\n\t\tfor(var i = 0; i < elements.length; i++) {\n\t\t\tvar image = _createImageElement();\n\t\t\timage.src = configuration.embeddedEngagement.agentUnavailableImageUrl;\n\t\t\telements[i].appendChild(image);\n\t\t\tlog.error('Presence check failed for referenceId: ' + configuration.referenceId + ' and configurationId: ' + configuration.id);\n\t\t}\n\t}\n\t\n\tfunction _createImageElement() {\n\t\tvar image = document.createElement('img');\n\t\timage.style = \"max-width:100%;height:auto;\";\n\t\treturn image;\n\t}\n\t\n\tfunction _populateMTCProperties(configuration) {\n\t\t\n\t\tvar successCallback = function(data) {\n\t\t\tconfiguration.mtc = data.properties;\n\t\t};\n\t\t\n\t\tvar errorCallback = function(data) {\n\t\t\tconsole.log('Error retrieving mtc property data for referenceId: ' + configuration.referenceId);\t\n\t\t};\n\t\t\n\t\tlpTag.taglets.mtcProperties.retrieve({\n\t\t\treferenceId: configuration.referenceId,\n\t\t\tdepartmentRef: configuration.departmentRef,\n\t\t\tlanguage: configuration.language,\n\t\t\tonSuccess: successCallback,\n\t\t\tonError: errorCallback\n\t\t});\n\t}\n\n\tfunction _runWhenPageLoaded(callback) {\n\t\tif (document.readyState === 'complete' || document.readyState === 'loaded') {\n\t\t\tcallback();\n\t\t} else {\n\t\t\tcallback();\n\t\t\tsetTimeout(function() { _runWhenPageLoaded(callback); }, 50);\n\t\t}\n\t}\n\t\n\treturn {\n\t\tload: load,\n\t};\n};\n\n/****************************************************************/\n\nwindow.lpTag = window.lpTag || {};\nlpTag.caoEngager = lpTag.caoEngager || {};\nlpTag.caoEngager.engagements = lpTag.caoEngager.engagements || {};\nlpTag.caoEngager.engagements.popinGenerator = lpTag.caoEngager.engagements.popinGenerator || function () {\n\t\n\tvar POP_IN_ELEMENT_ID = \"iCoder_POP1141877261\";\n\n\tvar _utility = new lpTag.caoEngager.utility();\n\tvar _isPopInSupported = _isSupportForPopIn();\n\t\n\t_popinGeneratorBaseUrl = lpTag.protocol + '//' + lpTag.taglets.caoServiceMap.getDomain('configurationCDN') + '/api/v1.0/configuration';\n\t\n\tfunction load(configuration) {\n\t\tif(!_isPopInSupported) { \n\t\t\treturn; \n\t\t}\n\n\t\tconfiguration.isLoaded = false;\n\t\tconfiguration.isEnabled = true;\n\t\t\n\t\tsetTimeout(checkState, 2000, configuration);\n\t}\n\t\n\tfunction checkState(configuration){\n\t\tvar elements = document.querySelectorAll('[data-cao-engref=\\'cao-overlay\\']');\n\t\tvar overlayElement = null;\n\t\tif(elements && elements.length && elements.length > 0) {\n\t\t\toverlayElement = elements[0];\n\t\t}\n\t\t_utility.resolveReferenceId(configuration, overlayElement);\n\t\t_utility.resolveLpvars(configuration, overlayElement);\n\n\t\tvar successCallback = function(data, state) {\n\t\t\t_DoPopin(configuration, data, state);\n\t\t};\n    \n\t\t_utility.getInstanceState(configuration.referenceId, successCallback);\n\t}\n\n\tfunction show(configuration) {\n\t\tif (!configuration.isLoaded) {\n\t\t\tload(configuration);\n\t\t} else if (objPopIn && !objPopIn.v.popInRunning) {\n\t\t\tobjPopIn.v.popInState = 0;\n\t\t\tiPop1141877261_init1();\n\t\t}\n\t\tif (objPopIn) {\n\t\t\tif(_isPopInHidden()){\n\t\t\t\tif (lpTag.taglets.caoEngager.overlayEngagementSessionId !== undefined){\n\t\t\t\t\tconfiguration.sessionId = lpTag.taglets.caoEngager.overlayEngagementSessionId;\n\t\t\t\t}\n\t\t\t\tlpTag.taglets.caoEngager.handleEvent(lpTag.providerId, configuration.sessionId, configuration.engagementId, 2);\n\t\t\t\tlpTag.taglets.googleAnalytics.sendGoogleAnalyticsEngagementEvent(configuration, 'Display');\n\t\t\t}\n\t\t\t_updatePopInVisibility(\"visible\");\n\t\t\t_updatePopInDisplay(\"block\");\n\t\t}\n\t}\n\t\n\tfunction hide(configuration) {\n\t\tif (configuration.isLoaded) {\n\t\t\tif (objPopIn && !objPopIn.v.popInRunning) {\t\t\t\n\t\t\t\tobjPopIn.v.popInState = 2;\n\t\t\t}\n\t\t\tif (objPopIn) {\n\t\t\t\t_updatePopInVisibility(\"hidden\");\n\t\t\t\t_updatePopInDisplay(\"none\");\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction _isPopInHidden() {\n\t\tvar engagement = document.getElementById(POP_IN_ELEMENT_ID);\n\t\tif (engagement.style.display === \"none\"){\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tfunction _updatePopInDisplay(value) {\n\t\tobjPopIn.v.popinDiv.style.display = value;\n\t\tvar engagement = document.getElementById(POP_IN_ELEMENT_ID);\n\t\tengagement.style.display = value;\n\t\tengagement.style.left = engagement.style.left;\n    }\n\n    function _updatePopInVisibility(value) {\n        objPopIn.v.popinDiv.style.visibility = value;\n        var engagement = document.getElementById(POP_IN_ELEMENT_ID);\n        engagement.style.visibility = value;\n\t\tengagement.style.left = engagement.style.left;\n    }\n\t\n\tfunction _isSupportForPopIn() {\n        var deviceDetector = lpTag.device || lpTag.taglets.lpDeviceDetector;\n        if (deviceDetector) {\n            var disabledBrowser = deviceDetector.browser() === 4 || deviceDetector.browser() === 6; // per LE definition\n            if (disabledBrowser) {\n                log.info(\"Browser does not support pop-in: \", deviceDetector.browserName());\n            }\n            return !disabledBrowser;\n        }\n        return true; // be optimistic\n    }\n\t\n\tfunction _DoPopin(configuration, stateAnalyzerData, state) {\n\t\t//if instance open window has matching referenceId then don't show\n\t\tvar isChatOpen = false;\n\t\ttry{\n\t\t\tif (stateAnalyzerData && typeof(stateAnalyzerData) !== 'undefined'){\n\t\t\t\tvar chatState = stateAnalyzerData.chat;\n\t\t\t\tif (chatState) {\n\t\t\t\t\tswitch (chatState.state)\n\t\t\t\t\t{\n\t\t\t\t\t\tcase 'locationSelector':\n\t\t\t\t\t\tcase 'departmentSelector':\n\t\t\t\t\t\tcase 'chatting':\n\t\t\t\t\t\tcase 'preChat':\n\t\t\t\t\t\tcase 'mtcInitiate':\n\t\t\t\t\t\tcase 'waiting':\n\t\t\t\t\t\tcase 'offline':\n\t\t\t\t\t\tcase 'ended': isChatOpen = true;\n\t\t\t\t\t}\n\t\t\t\t}\t\n\t\t\t}\n\t\t}\n\t\tcatch(exc){\n\t\t\tlog.error(\"Popin display state error\");\n\t\t}\n\t\t\n\t\tif(!isChatOpen){\n\n\t\t\tif(configuration.referenceId && configuration.referenceId !== '') {\n\t\t\t\tvar queryParams = [\n\t\t\t\t\t{ key: 'referenceId', value: configuration.referenceId }, \n\t\t\t\t\t{ key: 'providerId', value: lpTag.providerId },\n\t\t\t\t\t{ key: 'sessionId', value: configuration.sessionId },\n\t\t\t\t\t{ key: 'engagementId', value: configuration.engagementId || configuration.id },\n\t\t\t\t\t{ key: 'originationUrl', value: encodeURIComponent(window.location) }\n\t\t\t\t];\n\t\t\t\tif (configuration.departmentRef) {\n\t\t\t\t\tqueryParams.push({ key: 'departmentRef', value: configuration.departmentRef });\n\t\t\t\t}\n\t\t\t\tvar url = lpTag.taglets.lpUtil.addQueryParams(_popinGeneratorBaseUrl + '/popingenerator', queryParams);\n\t\t\t\t_utility.loadScript(url, function() { configuration.isLoaded = true; }, function() { log.error(\"Failed to load pop-in engagement\"); });\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlog.error(\"No referenceId set for popin generator engagement\");\n\t\t\t}\t\n\t\t}\n\t}\n\t\n\treturn {\n\t\tload: load,\n\t\tshow: show,\n\t\thide: hide\n\t};\n};\n\n/****************************************************************/\n\nwindow.lpTag = window.lpTag || {};\nwindow.lpTag.taglets = window.lpTag.taglets || {};\nwindow.lpTag.taglets.mtcProperties = (function () {\n\t\n\tvar _version = '1.0';\n\tvar _name = 'mtcProperties';\n\t\n\tvar cache = [];\n\t\n\tvar _requests = [];\n\tvar _mtcPropertiesRequestBaseUrl;\n\t\n\tfunction init(config) {\n\t\t_mtcPropertiesRequestBaseUrl = lpTag.protocol + '//' + lpTag.taglets.caoServiceMap.getDomain('configurationCDN') + '/api/v1.0/configuration';\n\t}\n\t\n\tfunction retrieve(propertiesRequest) {\n\t\t\n\t\tvar queryParams = [\n\t\t\t{ key: 'referenceId', value: propertiesRequest.referenceId }, \n\t\t\t{ key: 'providerId', value: lpTag.providerId }\n\t\t];\n\t\t\n\t\tvar cacheKey;\n\t\t\n\t\tif (propertiesRequest.departmentRef) {\n\t\t\tqueryParams.push({ key: 'departmentRef', value: propertiesRequest.departmentRef });\n\t\t\tcacheKey = propertiesRequest.departmentRef;\n\t\t}\n\t\telse {\n\t\t\tcacheKey = propertiesRequest.referenceId;\n\t\t}\n\n\t\tif (propertiesRequest.language) {\n\t\t\tqueryParams.push({ key: 'language', value: propertiesRequest.language });\n\t\t\tcacheKey = cacheKey + '-' + propertiesRequest.language;\n\t\t}\n\t\t\n\t\tif(!cache[cacheKey]) {\n\t\t\t_requests[cacheKey] = [];\n\t\t\tcache[cacheKey] = \n\t\t\t\tfunction(res) \n\t\t\t\t{ \n\t\t\t\t\tcache[cacheKey] = res; \n\t\t\t\t\tfor(var i = 0; i < _requests[cacheKey].length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\t_requests[cacheKey][i].onSuccess(res);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t}\n\t\telse if(typeof cache[cacheKey] !== \"function\") {\n\t\t\tpropertiesRequest.onSuccess(cache[cacheKey]);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t_requests[cacheKey].push(propertiesRequest);\n\t\tqueryParams.push({ key: 'callback', value: 'lpTag.taglets.mtcProperties.cache[\\'' + cacheKey + '\\']' });\n\t\tvar url = lpTag.taglets.lpUtil.addQueryParams(_mtcPropertiesRequestBaseUrl + '/mtcproperties', queryParams);\n\t\t\n\t\tlpTag.taglets.jsLoader.loadJS( {\n\t\t\tloadObj: { mtcProperties: url },\n\t\t\tsuccess: null,\n\t\t\terror: propertiesRequest.onError,\n\t\t\tcontext: window\n\t\t});\n\t}\n\t\n\treturn {\n\t\tv: _version,\n        name: _name,\n        init: init,\n\t\tcache: cache,\n\t\tretrieve: retrieve,\n\t\tsdkDef:[\n\t\t\t{\n\t\t\t\tmethodName: \"getMTCProperties\",\n\t\t\t\tfunc: retrieve\n\t\t\t}\n\t\t],\n        includes: [\n            { name: \"caoServiceMap\" },\n\t\t\t{ name: \"jsLoader\" }\n        ]\n\t};\n})();\n\n/****************************************************************/\n\nwindow.lpTag = window.lpTag || {};\nwindow.lpTag.taglets = window.lpTag.taglets || {};\nwindow.lpTag.taglets.agentProperties = (function () {\n\t\n\tvar _version = '1.0';\n\tvar _name = 'agentProperties';\n\t\n\tvar cache = [];\n\t\n\tvar _requests = [];\n\tvar _agentPropertiesRequestBaseUrl;\n\t\n\tfunction init(config) {\n\t\t_agentPropertiesRequestBaseUrl = lpTag.protocol + '//' + lpTag.taglets.caoServiceMap.getDomain('configurationCDN') + '/api/v1.0/configuration';\n\t}\n\t\n\tfunction retrieve(propertiesRequest) {\n\t\t\n\t\tvar queryParams = [\n\t\t\t{ key: 'referenceId', value: propertiesRequest.referenceId }, \n\t\t\t{ key: 'providerId', value: lpTag.providerId }\n\t\t];\n\t\t\n\t\tvar cacheKey;\n\t\t\n\t\tif (propertiesRequest.departmentRef) {\n\t\t\tqueryParams.push({ key: 'departmentRef', value: propertiesRequest.departmentRef });\n\t\t\tcacheKey = propertiesRequest.departmentRef;\n\t\t}\n\t\telse {\n\t\t\tcacheKey = propertiesRequest.referenceId;\n\t\t}\n\n\t\tif (propertiesRequest.language) {\n\t\t\tqueryParams.push({ key: 'language', value: propertiesRequest.language });\n\t\t\tcacheKey = cacheKey + '-' + propertiesRequest.language;\n\t\t}\n\t\t\n\t\tif(!cache[cacheKey]) {\n\t\t\t_requests[cacheKey] = [];\n\t\t\tcache[cacheKey] = \n\t\t\t\tfunction(res) \n\t\t\t\t{ \n\t\t\t\t\tcache[cacheKey] = res; \n\t\t\t\t\tfor(var i = 0; i < _requests[cacheKey].length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\t_requests[cacheKey][i].onSuccess(res);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t}\n\t\telse if(typeof cache[cacheKey] !== \"function\") {\n\t\t\tpropertiesRequest.onSuccess(cache[cacheKey]);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t_requests[cacheKey].push(propertiesRequest);\n\t\tqueryParams.push({ key: 'callback', value: 'lpTag.taglets.agentProperties.cache[\\'' + cacheKey + '\\']' });\n\t\tvar url = lpTag.taglets.lpUtil.addQueryParams(_agentPropertiesRequestBaseUrl + '/agent', queryParams);\n\t\t\n\t\tlpTag.taglets.jsLoader.loadJS( {\n\t\t\tloadObj: { agentProperties: url },\n\t\t\tsuccess: null,\n\t\t\terror: propertiesRequest.onError,\n\t\t\tcontext: window\n\t\t});\n\t}\n\t\n\treturn {\n\t\tv: _version,\n        name: _name,\n        init: init,\n\t\tcache: cache,\n\t\tretrieve: retrieve,\n\t\tsdkDef:[\n\t\t\t{\n\t\t\t\tmethodName: \"getAgentProperties\",\n\t\t\t\tfunc: retrieve\n\t\t\t}\n\t\t],\n        includes: [\n            { name: \"caoServiceMap\" },\n\t\t\t{ name: \"jsLoader\" }\n        ]\n\t};\n})();\n\n/****************************************************************/\n\nwindow.lpTag.taglets.caoEngager = (function () {\n    var _version = '1.0';\n\tvar _name = 'caoEngager';\n\tvar _engagementBaseUrl;\n\tvar _chatWindowEventsEnabled;\n\tvar _isPopInSupported;\n\tvar _configurations;\n    var POP_IN_ELEMENT_ID = \"iCoder_POP1141877261\";\n\tvar _utility;\n\tvar _popinGenerator;\n\tvar _embedded;\n\tvar _sdkSessionId;\n\tvar _overlayEngagementSessionId;\n\tvar _getOverlayEngagementSessionIdCallNumber = 0;\n\tvar _getEngagementsRetryCounter = 3;\n\tvar _subscribers = [];\n\tvar _eventHistory = [];\n\n\tvar CHAT_WINDOW_EVENTS = [\n\t\t{ appName: \"API\", eventName: \"state\" },\n\t\t{ appName: \"lpUnifiedWindow\", eventName: \"windowClosed\" },\n\t\t{ appName: \"lpUnifiedWindow\", eventName: \"externalWindowOpened\" },\n\t\t{ appName: \"ChatStateManager\", eventName: \"departmentSelector\" },\n\t\t{ appName: \"MtcStateManager\", eventName: \"departmentSelector\" }\n\t];\n\tvar CONFIGURATION_TYPES = { POPIN: 0, EMBEDDED: 1 };\n\n    function init(config) {\n\t\t_engagementBaseUrl = lpTag.protocol + '//' + lpTag.taglets.caoServiceMap.getDomain('configurationCDN') + '/api/v1.0/configuration';\n\t\t_chatWindowEventsEnabled = true;\n\t\t_bindEvents();\n\t\t_utility = new lpTag.caoEngager.utility(_name);\n\t\tlpTag.taglets.mtcProperties.init();\n\t\tlpTag.taglets.agentProperties.init();\n\t\t_getSdkSessionId();\n    }\n\t\n\tfunction start() {\n\t\t_popinGenerator = new lpTag.caoEngager.engagements.popinGenerator();\n\t\t_embedded = new lpTag.caoEngager.engagements.embedded();\n\t\t_loadConfigurations();\n\t}\n\n\tfunction setSdkSessionId(sdkSessionId){\n\t\t_sdkSessionId = sdkSessionId;\n\t\twindow.lpTag.taglets.caoEngager.sdkSessionId = sdkSessionId;\n\t}\n\n\tfunction setOverlayEngagementSessionId(overlayEngagementSessionId){\n\t\t_overlayEngagementSessionId = overlayEngagementSessionId;\n\t\twindow.lpTag.taglets.caoEngager.overlayEngagementSessionId = overlayEngagementSessionId;\n\t}\n\t\n\tfunction loadEngagements(configurations) {\n\n\t\t_configurations = configurations || [];\n\t\tfor (var i = 0; i < _configurations.length; i++) {\n\t\t\ttry {\n\t\t\t\tvar configuration = _configurations[i];\n\t\t\t\tconfiguration.engagementId = configuration.id;\n\t\t\t\tswitch(configuration.type) {\n\t\t\t\t\tcase CONFIGURATION_TYPES.EMBEDDED: _embedded.load(configuration); break;\n\t\t\t\t\tcase CONFIGURATION_TYPES.POPIN: _popinGenerator.load(configuration); break;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\twindow.console.log('Engagement id: ' + configuration.id + ' has unknown or undefined type');\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\twindow.console.log('Error processing engagement configuration: ' + error.message);\n\t\t\t}\n\t\t}\n\t}\n\n    function getEngagement(request) {\n        if (request && request.id && !isNaN(request.id) && request.onSuccess && request.onFailure) {\n\t\t\tif (_configurations) {\n\t\t\t\tfor (var i = 0; i < _configurations.length; i++) {\n\t\t\t\t\tif (_configurations[i].id == request.id || _configurations[i].engagementId == request.id) {\n\t\t\t\t\t\trequest.onSuccess(_configurations[i]);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\trequest.onFailure();\n\t\t\t} else {\n\t\t\t\tif (_getEngagementsRetryCounter > 0) {\n\t\t\t\t\tsetTimeout(function () { getEngagement(request); }, 1000);\n\t\t\t\t\t_getEngagementsRetryCounter--;\n\t\t\t\t}\n\t\t\t}\n        }\n\t}\n\n\tfunction engClickedSdkMethod(configuration) {\n\t\tengClicked(configuration, true);\n\t}\n\n\tfunction engClicked(configuration, sdkMethod) {\n\t\tconfiguration = configuration || {};\n\t\tif(configuration.engagementId) {\n\t\t\tconfiguration.id = configuration.engagementId;\n\t\t}\n\n\t\t_setConfigurationDefaults(configuration);\n\n\t\tif(configuration.referenceId) {\n\t\t\tconfiguration.referenceId = configuration.referenceId.toLowerCase();\n\t\t}\n\n\t\tif(configuration.departmentRef) {\n\t\t\tconfiguration.departmentRef = configuration.departmentRef.toLowerCase();\n\t\t}\n\t\t\n\t\tif(configuration.type === 0) {\n\t\t\tconfiguration.engagementId = configuration.id;//For preConversation event, we need to get the engagementId of the overlay before it gets overridden on the next line\n\t\t\tconfiguration.id = 0; //For legacy reporting we need overlay engagement id to be 0 so that placementId is recorded as 0 in visit table\n\t\t\n\t\t\tif (_overlayEngagementSessionId !== undefined){\n\t\t\t\tconfiguration.sessionId = _overlayEngagementSessionId;\n\t\t\t}\t\t\n\t\t}\n\n\t\t_getOverlayEngagementSessionId();\n\t\t\n\t\tif (sdkMethod){\n\t\t\tconfiguration.sessionId = _sdkSessionId;\n            lpTag.taglets.caoEngager.handleEvent(lpTag.providerId, configuration.sessionId, configuration.engagementId, configuration.channel === 'mtc' ? 15 : 14);\n\t\t} \n\t\telse {\n\t\t\tlpTag.taglets.caoEngager.handleEvent(lpTag.providerId, configuration.sessionId, configuration.engagementId, configuration.channel === 'mtc' ? 6 : 5);\n\t\t\tlpTag.taglets.googleAnalytics.sendGoogleAnalyticsEngagementEvent(configuration, configuration.channel === 'mtc' ? 'SMS_Click' : 'Chat_Click');\n\t\t}\n\n\t\tif (lpTag.taglets.lpUnifiedWindowMulti){\n\t\t\tlpTag.taglets.lpUnifiedWindowMulti.clicked(configuration);\n\t\t} else {\n\t\t\tlpTag.taglets.lpUnifiedWindow.clicked(configuration);\n\t\t}\n\t}\n\n\tfunction disableEvents() {\n\t\t_chatWindowEventsEnabled = false;\n\t}\n\t\n\tfunction enableEvents() {\n\t\t_chatWindowEventsEnabled = true;\n\t}\n\t\n\tfunction getMerchantData(request) {\n\t\tvar merchantConfigManager = _utility.getMerchantConfigurationManager();\n\t\tmerchantConfigManager.getConf(request.onSuccess, request.referenceId, request.departmentRef);\n\t}\n\n\tfunction _setConfigurationDefaults(engagementConfiguration) {\n\t\tif(_configurations)\n\t\t{\n\t\t\tfor(var i = 0; i < _configurations.length; i++) {\n\t\t\t\t\n\t\t\t\tif(_configurations[i].id == engagementConfiguration.id) {\t\t\t\n\t\t\t\t\tif((!engagementConfiguration.referenceId || engagementConfiguration.referenceId === '') && _configurations) {\n\t\t\t\t\t\tengagementConfiguration.referenceId = _configurations[i].referenceId;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tif(_configurations[i].lpVars && _configurations[i].lpVars.length > 0) {\n\t\t\t\t\t\tengagementConfiguration.lpVars = _configurations[i].lpVars;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction _bindEvents() {\n\t\tlpTag.unifiedWindow.publicEvents = lpTag.unifiedWindow.publicEvents || {};\n\t\tvar publicEvents = lpTag.unifiedWindow.publicEvents;\n\t\tfor (var i = CHAT_WINDOW_EVENTS.length - 1; i >= 0; i--) {\n\t\t\tvar chatWindowEvent = CHAT_WINDOW_EVENTS[i];\n\t\t\tchatWindowEvent.func = _onChatWindowEvent;\n\t\t\tif (typeof publicEvents[chatWindowEvent.appName] === 'undefined' || typeof publicEvents[chatWindowEvent.appName][chatWindowEvent.eventName] === 'undefined'){\n\t\t\t\tpublicEvents[chatWindowEvent.appName] = publicEvents[chatWindowEvent.appName] || {};\n\t\t\t\tpublicEvents[chatWindowEvent.appName][chatWindowEvent.eventName] = publicEvents[chatWindowEvent.appName][chatWindowEvent.eventName] || [];\n\t\t\t\tpublicEvents[chatWindowEvent.appName][chatWindowEvent.eventName].push(chatWindowEvent);\t\n\t\t\t}\n\t\t\tlpTag.events.bind(chatWindowEvent);\n\t\t}\n\t}\n\n\tfunction _getSdkSessionId() {\n\t\tvar queryParams = [\n\t\t\t{ key: 'callback', value: 'lpTag.taglets.caoEngager.setSdkSessionId' }\n\t\t];\n\t\tvar url = lpTag.taglets.lpUtil.addQueryParams(_engagementBaseUrl + '/getSdkSessionID', queryParams);\n\t\t_utility.loadScript(url, null, function() { lpTag.unifiedWindow.log.error(\"Failed to get Sdk SessionId\"); });\n\t}\n\n\tfunction _getOverlayEngagementSessionId() {\n\t\t_getOverlayEngagementSessionIdCallNumber = _getOverlayEngagementSessionIdCallNumber + 1;\n\t\tvar queryParams = [\n\t\t\t{ key: 'callback', value: 'lpTag.taglets.caoEngager.setOverlayEngagementSessionId' },\n\t\t\t{ key: '_getOverlayEngagementSessionIdCallNumber', value: _getOverlayEngagementSessionIdCallNumber }\n\t\t];\n\t\tvar url = lpTag.taglets.lpUtil.addQueryParams(_engagementBaseUrl + '/getSdkSessionID', queryParams);\n\t\t_utility.loadScript(url, null, function() { lpTag.unifiedWindow.log.error(\"Failed to get Overlay Engagement SessionId\"); });\n\t}\n\n\tfunction _loadConfigurations() {\n\t\tvar queryParams = [\n\t\t\t{ key: 'providerId', value: lpTag.providerId }, \n\t\t\t{ key: 'callback', value: 'lpTag.taglets.caoEngager.loadEngagements' },\n\t\t\t{ key: 'originationUrl', value: encodeURIComponent(window.location) }\n\t\t];\n\t\tvar url = lpTag.taglets.lpUtil.addQueryParams(_engagementBaseUrl + '/engagement', queryParams);\n\t\t_utility.loadScript(url, null, function() { lpTag.unifiedWindow.log.error(\"Failed to load engagement configurations\"); });\n\t}\n\n\tfunction _onChatWindowEvent(eventData, eventInfo) {\n\t\tif(!_chatWindowEventsEnabled) { return; }\n\n\t\tvar resolvedEventName;\n        if (eventInfo && eventInfo.appName === \"API\" && eventInfo.eventName === \"state\" && eventData) {\n\t\t\tresolvedEventName = eventData.data ? eventData.data : eventData;\n        } else if (eventInfo && (eventInfo.appName === \"lpUnifiedWindow\" || eventInfo.appName === \"ChatStateManager\" || eventInfo.appName === \"MtcStateManager\")) {\n\t\t\tresolvedEventName = eventInfo.eventName;\n        } else if (eventData) {\n\t\t\tresolvedEventName = eventData;\n\t\t}\n\t\t\n\t\tswitch(resolvedEventName)\n\t\t{\n\t\t\tcase \"onLoad\":\n            case \"init\":\n\t\t\tcase \"externalWindowOpened\":\n\t\t\tcase \"departmentSelector\":\n\t\t\tcase \"windowClosed\":\n\t\t\t\t_IntrusiveEngagementVisibility();\n\t\t\t\tbreak;\n\t\t}\n    }\n\t\n\tfunction _IntrusiveEngagementVisibility() {\n\t\tfor (var i = 0; i < _configurations.length; i++) {\n\t\t\ttry {\n\t\t\t\tvar configuration = _configurations[i];\n\t\t\t\tif (!configuration.type || configuration.type === CONFIGURATION_TYPES.POPIN) { // Pop-In type\n\t\t\t\t\t_utility.getInstanceState(configuration.referenceId, popinStateCallback);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tlog.error('Error hiding/showing instrusive engagement: ' + error.message);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction popinStateCallback(stateAnalyzerData, state){\n\t\tfor (var i = 0; i < _configurations.length; i++) {\n\t\t\ttry {\n\t\t\t\tvar configuration = _configurations[i];\n\t\t\t\tif (!configuration.type || configuration.type === CONFIGURATION_TYPES.POPIN) { // Pop-In type\n\t\t\t\t\tif (stateAnalyzerData && typeof(stateAnalyzerData) !== 'undefined'){\n\t\t\t\t\t\tvar chatState = stateAnalyzerData.chat;\n\t\t\t\t\t\tif (chatState) {\n\t\t\t\t\t\t\tswitch (chatState.state)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcase 'initialised' :\n\t\t\t\t\t\t\t\tcase 'locationSelector':\n\t\t\t\t\t\t\t\tcase 'departmentSelector':\n\t\t\t\t\t\t\t\tcase 'chatting':\n\t\t\t\t\t\t\t\tcase 'preChat':\n\t\t\t\t\t\t\t\tcase 'mtcInitiate':\n\t\t\t\t\t\t\t\tcase 'waiting':\n\t\t\t\t\t\t\t\tcase 'offline':\n\t\t\t\t\t\t\t\tcase 'ended': \n\t\t\t\t\t\t\t\t\tconfiguration.isEnabled = false;\n\t\t\t\t\t\t\t\t\t_popinGenerator.hide(configuration);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconfiguration.isEnabled = true;\n\t\t\t\t\t\t\t_popinGenerator.show(configuration);\n\t\t\t\t\t\t}\t\n\t\t\t\t\t} else{\n                        var table = document.getElementById(\"mainTable\");\n                        if(table === null || table.parentElement.id !== POP_IN_ELEMENT_ID){\n                            configuration.isEnabled = true;\n                            _popinGenerator.show(configuration);\n                        }\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tlog.error('Error determining instrusive engagement state: ' + error.message);\n\t\t\t}\n\t\t}\t\n\t}\n\n\tfunction subscribeToEvents(callback){\n    \t_utility._log('Added new subscriber to caoEngager events, callback = '+callback, 'INFO');\n    \t//Notify of previous events\n\t\tif (_eventHistory.length > 0) {\n            _utility._log('Sending previous events to new subscriber', 'INFO');\n\t\t\tfor (var i = 0; i < _eventHistory.length; ++i) {\n                callback(_eventHistory[i]);\n\t\t\t}\n\t\t}\n\n\t\taddSubscriberCallback(callback);\n\t}\n\n\tfunction addSubscriberCallback(callback){\n    \t_subscribers.push(callback);\n\t}\n\n\tfunction handleEvent(providerId, sessionId, engagementId, type){\n    \t_eventHistory.push({\n\t\t\tproviderId: providerId,\n\t\t\tsessionId: sessionId,\n\t\t\tengagementId: engagementId,\n\t\t\ttype: type\n    \t});\n        _utility._log('Storing new event: providerId: '+providerId+', sessionId: '+sessionId+', engagementId: '+engagementId+', type: '+type, 'INFO');\n        lpTag.taglets.eventAPI.sendAnalyticEvent(providerId, sessionId, engagementId, type);\n        sendSubscriberEvent(providerId, sessionId, engagementId, type);\n\t}\n\n\tfunction sendSubscriberEvent(providerId, sessionId, engagementId, type){\n    \tvar event = {\n    \t\tproviderId: providerId,\n\t\t\tsessionId: sessionId,\n\t\t\tengagementId: engagementId,\n\t\t\ttype: type\n    \t};\n\n    \tfor(var i = 0; i < _subscribers.length; ++i){\n    \t\t_subscribers[i](event);\n\t\t}\n\t}\n\n    return {\n        v: _version,\n\t\tname: _name,\n        init: init,\n\t\tstart: start,\n\t\tsetSdkSessionId: setSdkSessionId,\n\t\tsetOverlayEngagementSessionId: setOverlayEngagementSessionId,\n\t\tloadEngagements: loadEngagements,\n\t\tengClicked: engClicked, \n\t\tdisableEvents: disableEvents,\n\t\tenableEvents: enableEvents,\n\t\tsubscribeToEvents: subscribeToEvents,\n\t\thandleEvent: handleEvent,\n\t\tsdkSessionId: _sdkSessionId,\n\t\toverlayEngagementSessionId: _overlayEngagementSessionId,\n\t\tsdkDef:[\n\t\t\t{\n\t\t\t\tmethodName: \"startChat\",\n\t\t\t\tfunc: engClickedSdkMethod\n\t\t\t},\n\t\t\t{\n\t\t\t\tmethodName: \"getEngagement\",\n\t\t\t\tfunc: getEngagement\n\t\t\t},\n\t\t\t{\n\t\t\t\tmethodName: \"getMtcProperties\",\n\t\t\t\tfunc: lpTag.taglets.mtcProperties.retrieve\n\t\t\t},\n\t\t\t{\n\t\t\t\tmethodName: \"getMerchantProperties\",\n\t\t\t\tfunc: getMerchantData\n\t\t\t},\n\t\t\t{\n\t\t\t\tmethodName: \"getAgentProperties\",\n\t\t\t\tfunc: lpTag.taglets.agentProperties.retrieve\n\t\t\t}\n\t\t],\n        includes: [\n            { name: \"caoServiceMap\" },\n\t\t\t{ name: \"lpUnifiedWindow\" },\n\t\t\t{ name: \"jsLoader\" },\n\t\t\t{ name: \"caoPresence\" },\n\t\t\t{ name: \"googleAnalytics\" },\n\t\t\t{ name: \"mtcProperties\" },\n\t\t\t{ name: \"agentProperties\" }\n        ]\n    };\n})();\n\n/****************************************************************/\n\nwindow.lpTag = window.lpTag || {};\nlpTag.caoEngager = lpTag.caoEngager || {};\nlpTag.caoEngager.utility = lpTag.caoEngager.utility || function (_name) {\n\t\n\tfunction resolveReferenceId(configuration, element) {\n\t\tconfiguration = configuration || {};\n\t\tif (element && element.dataset && element.dataset.caoReferenceid) { \n\t\t\tconfiguration.referenceId = element.dataset.caoReferenceid; \n\t\t} else {\n\t\t\tconfiguration.referenceId = configuration.referenceId || lpTag.referenceId;\n\t\t}\n\t\t\n\t\tif(!configuration.referenceId) {\n\t\t\tconsole.log(\"Could not resolve referenceId for engagment \" + configuration.name + \" id:\" + configuration.id + \".\\nWill not be able to start a chat with this engagement.\");\n\t\t}\n\t}\n\t\n\tfunction getInstanceState(referenceId, callback){\n\t\tif (lpTag.taglets.lpUnifiedWindowMulti){\n\t\t\tlpTag.taglets.lpUnifiedWindowMulti.getWindowState(referenceId, callback);\n\t\t} else {\n\t\t\tlpTag.taglets.lpUnifiedWindow.getWindowState(referenceId, callback);\n\t\t}\n\t}\n\n\tfunction resolveLpvars(configuration, element) {\n\t\tconfiguration = configuration || {};\n\t\tif(element && element.dataset && element.dataset.caoLpvars) {\n\t\t\ttry\n\t\t\t{\n\t\t\t\tconfiguration.lpVars = JSON.parse(element.dataset.caoLpvars);\n\t\t\t}\n\t\t\tcatch(exc)\n\t\t\t{\n\t\t\t\tconsole.log(\"Error parsing lpvars for element with engref: \" + element.dataset.caoEngref);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction loadScript(url, successCallback, errorCallback) {\n\t\tlpTag.taglets.jsLoader.loadJS( {\n\t\t\tloadObj: { engager: url },\n\t\t\tsuccess: successCallback,\n\t\t\terror: errorCallback,\n\t\t\tcontext: window\n\t\t});\n\t}\n\t\t\n\tfunction getMerchantConfigurationManager() {\n\t\tvar lpUnifiedWindowConf = lpTag.taglets.lpUnifiedWindow.inspect().conf;\n\t\treturn lpTag.unifiedWindow.MerchantConfigurationManager(lpUnifiedWindowConf);\n\t}\n\n    function _log(message, type) {\n        if (window.lpTag && window.lpTag.log) {\n            window.lpTag.log(message, type, _name);\n        }\n    }\n\n\treturn {\n\t\tresolveReferenceId: resolveReferenceId,\n\t\tresolveLpvars: resolveLpvars,\n\t\tloadScript: loadScript,\n\t\tgetMerchantConfigurationManager: getMerchantConfigurationManager,\n\t\tgetInstanceState: getInstanceState,\n\t\t_log: _log\n\t};\n};","parameters":null},{"name":"cobrowse","code":"/**\r\n *   _     ___    ___       ___\r\n *  | |   | __|  / __| ___ | _ ) _ _  ___ __ __ __ ___ ___\r\n *  | |__ | _|  | (__ / _ \\| _ \\| '_|/ _ \\\\ V  V /(_-</ -_)\r\n *  |____||___|  \\___|\\___/|___/|_|  \\___/ \\_/\\_/ /__/\\___|\r\n *    .-.-.   .-.-.   .-.-.   .-.-.   .-.-.   .-.-.\r\n *   / / \\ \\ / / \\ \\ / / \\ \\ / / \\ \\ / / \\ \\ / LiveEngage  2.0\r\n *  `-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-'   `-`-- Taglet\r\n *\r\n *\r\n * @author cthum\r\n *\r\n * @depend lpSecureStorage\r\n * @depend lp_global_utils\r\n *\r\n * @link lpTag.taglets.cobrowse\r\n *\r\n *  DEPENDENCIES:\r\n *  - lpSecureStorage as cookie replacement for storing data required for the life-cycle of a CoBrowse session\r\n *  - lp_global_utils for converting config options and taglet init parameters (also used by many other taglets)\r\n *\r\n * QA Taglet Respository:       http://tlvrepository.tlv.lpnet.com/liveperson-taglet-qa/cobrowse/\r\n * Release Taglet Repository:   http://tlvrepository.tlv.lpnet.com/liveperson-taglet-release/cobrowse/\r\n *\r\n * CoBrowse Integration for LiveEngage 2.0\r\n *\r\n * This taglet enables CoBrowse for LE 2.0 accounts. The CoBrowse taglet enables matching of agent and visitor. It\r\n * processes events triggered by the Unified Window.\r\n *\r\n * cobrowseOffered  -> loads the CoBrowse visitorApi. The visitorApi establishes a real-time connection with the\r\n *                     CoBrowse servers and uses the best possible transport available in the browser (WebSockets,\r\n *                     CORS Long-Polling, JSONP Long-Polling).\r\n * cobrowseAccepted -> starts the CoBrowse session on both agent and visitor side\r\n * cobrowseDeclined -> signals to the agent that the CoBrowse offer was declined\r\n *\r\n *\r\n * The CoBrowse taglet receives configuration parameter as follows:\r\n * T.B.D\r\n *\r\n * TESTING\r\n * To test the CoBrowse taglet, you can trigger the events listed above manually e.g.,\r\n * lpTag.taglets.cobrowse.testEvent(\"cobrowseOffered\"); or\r\n * lpTag.taglets.cobrowse.testEvent(\"cobrowseAccepted\");\r\n *\r\n *\r\n * If you want to execute custom actions, you need to wait for the CoBrowse Taglet to be loaded. For this, you need to\r\n * listen to the \"LPTAG\", \"TAGLET_STARTED\" event as illustrated in te following example. Because the taglet might have\r\n * already loaded, we provide you with a utility function that checks for the existence of the taglet and fires a call-\r\n * back when it is started.\r\n\r\n\r\n    function waitForTaglet(name, callback) {\r\n        if (window.lpTag) {\r\n            var taglet = lpTag && lpTag.taglets && lpTag.taglets[name];\r\n            if (taglet) {\r\n                callback(taglet);\r\n            } else {\r\n                lpTag.events.bind('LPTAG', 'TAGLET_STARTED', function (event) {\r\n                    if (event.name == name) {\r\n                        callback(lpTag.taglets[name]);\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Example usage\r\n    waitForTaglet(\"cobrowse\", function(cobrowse) {\r\n        console.warn(\"CoBrowse Taglet Started: \" + cobrowse.name);\r\n    });\r\n\r\n    */\r\n\r\n\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\n\r\nlpTag.taglets.cobrowse = lpTag.taglets.cobrowse || (function () {\r\n\r\n    // Bringing this inside the closure for scoping purposes\r\n    var win = window,\r\n    doc = win.document,\r\n    taglets = lpTag.taglets,\r\n    util; // Will only be set in init method to allow more time for other taglets to be loaded.\r\n\r\n    // To activate logging for cobrowse taglet\r\n    // set lpTag.isDebug = true\r\n    if (lpTag.isDebug && win.console && win.console.log) {\r\n        lpTag.log = function (msg, lvl) {\r\n            if (lvl === \"ERROR\") {\r\n                win.console.error(msg);\r\n            } else {\r\n                win.console.log(msg);\r\n            }\r\n        };\r\n    }\r\n\r\n    var version = \"${taglet.version}\", // Will be replaced by taglet build system\r\n        name = \"cobrowse\",\r\n        uwAppName = \"lpUnifiedWindow\",\r\n        secureStorageApp = \"cobrowse\", // If changed must also be changed in storage.js\r\n        visitorApi,\r\n        chatEnded = false,\r\n        caoVisitorId,\r\n        caoSessionId,\r\n        defaultConfig = {\r\n            // optionally test on a specific cobrowse domain and tenantId\r\n            // domain: \"my.synchronite.de\",  // uncomment to debug locally\r\n            // site: \"global\",\r\n            // agentChannelSegment: \"uniqueAgentId\" // used for debugging purposes only\r\n            debugEvents: false,\r\n            autoloadApi: false,                     // load cobrowse visitor api on taglet initialization\r\n            namespace: \"lpTag.cobrowse.visitorApi\",\r\n            cobrowseEngine: \"proxyless\",\r\n            chatEnabled: false,\r\n            skipVisitorConfirmation: true,\r\n            visitorNameRequired: false,\r\n            checkAgentAvailability: false,\r\n            customFlow: true,\r\n            realtimeTracking: false\r\n        },\r\n        config = {};\r\n\r\n\r\n    function init(cfg) {\r\n        // Note: When deployed in the Global Taglet Repository, parameters specified must be in array format e.g.,\r\n        //       [{\"id\":\"site\",\"value\":\"global\"}, {\"id\":\"domain\",\"value\":\"my.synchronite.de\"}]\r\n        //      When invoked on-site, you may also use the simpler JSON format\r\n        //      {\"site\": \"global\", \"domain\": \"my.synchronite.de\"}\r\n\r\n        _info(\"INITIALIZING\");\r\n        _info(\"CONFIG PARAM=\" + cfg);\r\n\r\n        util = taglets.lpUtil || taglets.lp_global_utils;\r\n\r\n        if (cfg && cfg.constructor === Array) {\r\n            // lpTag site configuration\r\n            util.convertConfig(cfg, config);\r\n        } else {\r\n            //external configuration\r\n            config = cfg || config;\r\n        }\r\n\r\n        config = _mixin(defaultConfig, config);\r\n\r\n\r\n        if (config.autoloadApi) {\r\n            _loadVisitorApi();\r\n        }\r\n\r\n        _addLpTagListeners();\r\n\t\t\r\n\t\tif (!lpTag.getDomain) {\r\n            _addLpTagGetDomain();\r\n\t\t}\r\n    }\r\n\r\n\r\n    function start() {\r\n        _info(\"STARTING\");\r\n        lpTag.events.trigger(name, \"ready\", taglets.cobrowse);\r\n\r\n        _resumeSessionIfActive();\r\n    }\r\n\r\n\r\n    var _visitorApiReadyCallbacks = [];\r\n\r\n    function _visitorApiReady() {\r\n        _info(\"_visitorApiReady()\");\r\n        visitorApi = _readNamespace(config.namespace, win);\r\n\r\n        visitorApi.removeDefaultFlow();\r\n\r\n        _addSynchroniteListeners(visitorApi); // idempotent\r\n\r\n        _forEach(_visitorApiReadyCallbacks, function (callback) {\r\n            callback(visitorApi);\r\n        });\r\n\r\n        _visitorApiReadyCallbacks = [];\r\n    }\r\n\r\n    var _lpTagListeners = [];\r\n\r\n    function _addLpTagListeners() {\r\n        // Function is idempotent\r\n        _info(\"_addLpTagListeners()\");\r\n        // For lpTag.events documentation check:\r\n        // https://lpgithub.dev.lprnd.net/WebJedi/lp-events\r\n        _forEach(_lpTagListeners, lpTag.events.unbind, lpTag.events);\r\n\r\n        _lpTagListeners = [\r\n            lpTag.events.bind({\r\n                appName: uwAppName,\r\n                eventName: \"cobrowseOffered\", // lpTag.unifiedWindow.events.coBrowseEvents.offered\r\n                func: _handleOffered\r\n            }),\r\n            lpTag.events.bind({\r\n                appName: uwAppName,\r\n                eventName: \"cobrowseAccepted\", // lpTag.unifiedWindow.events.coBrowseEvents.accepted\r\n                func: _handleAcceptedFromLE2ChatWindow\r\n            }),\r\n            lpTag.events.bind({\r\n                appName: uwAppName,\r\n                eventName: \"cobrowseDeclined\", // lpTag.unifiedWindow.events.coBrowseEvents.decline\r\n                func: _handleDeclined\r\n            }),\r\n            lpTag.events.bind({\r\n                appName: \"API\",\r\n                eventName: \"state\",\r\n                func: _handleChatState\r\n            }),\r\n            lpTag.events.bind({\r\n                appName: \"ChatStateManager\",\r\n                eventName: \"ended\",\r\n                func: _handleChatEnded\r\n            })\r\n        ];\r\n    }\r\n\r\n\r\n    var _synchroniteListeners = [];\r\n\r\n    function _addSynchroniteListeners(visitorApi) {\r\n        _info('_addSynchroniteListeners()');\r\n        _forEach(_synchroniteListeners, function (signal) {\r\n            signal.remove();\r\n        });\r\n\r\n        _synchroniteListeners = [\r\n            visitorApi.on(\"sessionAccepted\", function () { _info('sessionAccepted'); }),\r\n\r\n            visitorApi.on(\"sessionStart\", _handleStart)\r\n        ];\r\n    }\r\n\r\n\r\n    //------------------- CoBrowse Event Handlers -----------------------//\r\n\r\n    function _handleOffered(event) {\r\n        // event properties:\r\n        //    ssid: engConf.ssid,\r\n        //    svid: engConf.svid,\r\n        //    cid: engConf.cid,\r\n        //    agentId: lpModel.get(chatModelPath.AGENT_ID)\r\n        _info(\"_handleOffered \" + (event ? JSON.stringify(event) : \"no event param\"));\r\n        chatEnded = false;\r\n\r\n        var serviceId = event.serviceId || event.ssid;\r\n        _loadVisitorApi(event).then(function (visitorApi) {\r\n            event.serviceId = serviceId;\r\n            visitorApi.removeDefaultFlow();\r\n            visitorApi.emit(\"sessionOffered\", event);\r\n        });\r\n    }\r\n\r\n    function _handleAcceptedFromLE2ChatWindow(event) {\r\n        // event properties:\r\n        //    ssid: engConf.ssid,\r\n        //    svid: engConf.svid,\r\n        //    cid: engConf.cid,\r\n        //    agentId: lpModel.get(chatModelPath.AGENT_ID)\r\n\r\n        if (chatEnded) {\r\n            _info(\"Chat already ended\");\r\n            return;\r\n        }\r\n\r\n        if (event) {\r\n            // Signal to CoBrowse Server that this session was started from an LE 2.0 Chat.\r\n            event.context = \"CAO\";\r\n        }\r\n        _handleAccepted(event);\r\n    }\r\n\r\n    function _handleAccepted(event) {\r\n        event.svid = caoVisitorId = event.svid;\r\n        event.ssid = caoSessionId = event.ssid;\r\n\r\n        var serviceId = event.serviceId || event.svid || event.ssid;\r\n\r\n        _loadVisitorApi(event).then(function (visitorApi) {\r\n            _info(\"_handleAccepted \" + (event ? JSON.stringify(event) : \"no event param\"));\r\n\r\n            event.channelSegment = event.agentId + \"\";\r\n            event.serviceId = serviceId;\r\n            event.visitorAlias = _getVisitorName(event);\r\n\r\n            visitorApi.acceptSupportOffer(event, true);\r\n        });\r\n    }\r\n\r\n    function _handleDeclined(event) {\r\n        // event properties:\r\n        //    ssid: engConf.ssid,\r\n        //    svid: engConf.svid,\r\n        //    cid: engConf.cid,\r\n        //    agentId: lpModel.get(chatModelPath.AGENT_ID)\r\n\r\n        if (chatEnded) {\r\n            _info(\"Chat already ended\");\r\n            return;\r\n        }\r\n\r\n        _info(\"_handleDeclined \" + (event ? JSON.stringify(event) : \"no event param\"));\r\n\r\n        var serviceId = event.serviceId || event.svid || event.ssid;\r\n\r\n        _loadVisitorApi(event).then(function (visitorApi) {\r\n            var params = JSON.parse(JSON.stringify(event));\r\n            params.channelSegment = params.agentId + \"\";\r\n            params.serviceId = serviceId;\r\n            params.visitorAlias = _getVisitorName(params);\r\n            visitorApi.removeDefaultFlow();\r\n\r\n            visitorApi.cancelSupportOffer(params);\r\n        });\r\n    }\r\n\r\n    function _handleStart(params) {\r\n        _info('_handleStart() - ' + JSON.stringify(params));\r\n\r\n        lpTag.events.trigger(name, \"start\", taglets.cobrowse);\r\n\r\n\r\n        var targetWin = (win.opener || win.top || win),\r\n            cobrowseEngine = config.cobrowseEngine || \"proxyless\",\r\n            sessionUrl = params.sessionUrl;\r\n\r\n\r\n        visitorApi.visitorInfo.connectedAgentAlias = null; //clear the support username\r\n        visitorApi.visitorInfo.supportId(null); //clear the support id\r\n\r\n        if (cobrowseEngine == \"proxyless\") {\r\n\r\n            window.proxylessConfig = {\r\n                ticket: params.ticket,\r\n                master: true,\r\n                sid: params.sid,\r\n                username: params.visitorName,\r\n                comet: visitorApi.getComet()\r\n            };\r\n\r\n            _loadScript(_getCobrowseBaseUrl(config.tenantId) + '/js/synchronite/proxyless/run.js?cacheBust=' + encodeURIComponent(version));\r\n            visitorApi.cometCleanUp();\r\n\r\n        } else {\r\n            // FIXED: Open Session in topmost window, not in current window\r\n            win.setTimeout(function () {\r\n                targetWin.location = sessionUrl;\r\n            }, 25);\r\n        }\r\n    }\r\n\r\n    function _handleChatState(params) {\r\n        _info('_handleChatState() - ' + JSON.stringify(params));\r\n        if (params.data == \"ended\") {\r\n            _endSession();\r\n        }\r\n    }\r\n\r\n    function _handleChatEnded() {\r\n        _info('_handleChatEnded()');\r\n        _endSession();\r\n    }\r\n\r\n\r\n    //------------------- Standalone CoBrowse Functions -----------------------//\r\n    function _setServiceId(callback) {\r\n        var visitorId = caoVisitorId;\r\n        var visitorName = _getVisitorName();\r\n\r\n        _loadVisitorApi().then(function (visitorApi) {\r\n            callback = callback || function (event) {\r\n                _info(\"ServiceId set: \" + event);\r\n            };\r\n\r\n            visitorApi.visitorInfo.setFullname(visitorName);\r\n            visitorApi.createServiceId(visitorId, callback);\r\n        });\r\n    }\r\n\r\n\r\n    function _requestCobrowse() {\r\n        var visitorId = caoVisitorId;\r\n        var visitorName = _getVisitorName();\r\n\r\n        var requestProps = {\r\n            agentServiceId: visitorId,\r\n            fullname: visitorName\r\n        };\r\n\r\n        _info('_requestCobrowse ' + JSON.stringify(requestProps));\r\n        _loadVisitorApi(event).then(function (visitorApi) {\r\n            visitorApi.requestSupport(requestProps,\r\n                function (e) {\r\n                    if (e) {\r\n                        _info('REQUESTEDSUPPORT SUCCESS ');\r\n                    } else {\r\n                        _info('REQUESTEDSUPPORT FAILED - SERVICE ID UNKNOWN');\r\n                    }\r\n                });\r\n        });\r\n    }\r\n\r\n    function _onBeforeNavigation() {\r\n        var newUrl = lpTag.url;\r\n        if (window.proxyless && window.proxyless.newPage) {\r\n            window.proxyless.newPage(newUrl);\r\n        }\r\n    }\r\n\r\n    ////////////////////////////////////////////////////////////////////////\r\n    //------------------- Utility/Helper Functions -----------------------//\r\n    ////////////////////////////////////////////////////////////////////////\r\n\r\n    // lpTag utility functions\r\n    function _getSite() {\r\n        var site = config.site;\r\n\r\n        if (!site) {\r\n            // Order is important because of clone accounts will have the redirected siteId stored\r\n            // in a cookie (JCPENNEY) or as \"lpNumber\" (RBS)\r\n\r\n            // site = visitorCommon.getRedirectedSiteId(win);\r\n            // if (site) {\r\n            //     return site;\r\n            // }\r\n\r\n            // site = win.lpMTagConfig && win.lpMTagConfig.lpNumber;\r\n            // if (site) {\r\n            //     return site;\r\n            // }\r\n\r\n            site = win.lpTag && win.lpTag.site;\r\n            if (site) {\r\n                return site;\r\n            }\r\n        }\r\n\r\n        if (!site) {\r\n            if (win.lp && win.lp.urlParams && win.urlParams.lpnumber) {  // engagement window\r\n                site = win.urlParams.lpnumber;\r\n            }\r\n        }\r\n\r\n        return site;\r\n    }\r\n\r\n\r\n    function _getVisitorName(event) {\r\n        if (event && event.visitorName) {\r\n            return event.visitorName;\r\n        }\r\n\r\n        if (win.lp && win.lp.chatApi && win.lp.chatApi.getVisitorName) {\r\n            return win.lp.chatApi.getVisitorName(); // engagement window\r\n        }\r\n\r\n        return \"Visitor\";\r\n    }\r\n\r\n\r\n    //cobrowse utility functions\r\n    function _loadVisitorApi(offeredEvent) {\r\n        _info(\"_loadVisitorApi()\");\r\n\r\n        offeredEvent = offeredEvent || {};\r\n\r\n        if (!visitorApi) {\r\n            var tenantId = offeredEvent.siteId || _getSite();\r\n            config.tenantId = tenantId;\r\n            config.readyCallback = _visitorApiReady;\r\n\r\n            // synchronite visitorApi expects this object to be present\r\n            win.synchroniteConfig = _mixin(win.synchroniteConfig || {}, config);\r\n\r\n            _loadScript(_getCobrowseBaseUrl(tenantId) + '/js/synchronite/integration.js?cacheBust=' + encodeURIComponent(version), \"cobrowse-integration\");\r\n        }\r\n\r\n        // returns a simple javascript promise to improve code readability over chains of callbacks\r\n        return {\r\n            then: function (callback) {\r\n                if (callback) {\r\n                    if (visitorApi) {\r\n                        callback(visitorApi);\r\n                    } else {\r\n                        _visitorApiReadyCallbacks.push(callback);\r\n                    }\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n    function _resumeSessionIfActive() {\r\n        _isActiveSessionInCache(function (data) {\r\n            if (data) {\r\n                _loadProxylessApp();\r\n            }\r\n        });\r\n\r\n    }\r\n\r\n    function _endSession() {\r\n        chatEnded = true;\r\n        if (win.proxyless && win.proxyless.endSession) {\r\n            win.proxyless.endSession();\r\n        }\r\n    }\r\n\r\n    function _loadProxylessApp() {\r\n        _loadScript(_getCobrowseBaseUrl(_getSite()) + '/js/synchronite/proxyless/run.js?cacheBust=' + encodeURIComponent(version));\r\n    }\r\n\r\n    function _isActiveSessionInCache(callback) {\r\n        if (win.lpTag && win.lpTag.taglets && win.lpTag.taglets.lpSecureStorage) {\r\n\r\n            var secureStorageTaglet = win.lpTag.taglets.lpSecureStorage;\r\n            var contentDomain = win.lpTag.taglets.caoServiceMap.getDomain(\"contentCDN\");\r\n            var secureStorageDomain = \"https://\" + contentDomain + \"/le_secure_storage/\";\r\n\r\n            win.proxyless = win.proxyless || {};\r\n            win.proxyless.useCdn = true;\r\n\r\n            //init SecureStorage\r\n            try {\r\n                var secureStorageConf = {\r\n                    url: secureStorageDomain,\r\n                    site: _getSite(),\r\n                    initialStorageType: \"sessionStorage\",\r\n                    app: secureStorageApp,\r\n                    env: win.lpTag.env\r\n                };\r\n\t\t\t\t\r\n                lpTag.taglets.lpSecureStorage.configure({\r\n                    conf: secureStorageConf,\r\n                    error: function(e) {\r\n                        _log(\"Error initializing secure storage: \" + e, 'ERROR');\r\n                    }\r\n                });\r\n\r\n            } catch (e) {\r\n                _log(\"Error initializing secure storage: \" + e, 'ERROR');\r\n            }\r\n\r\n            lpTag.taglets.lpSecureStorage.getValue({\r\n                site: _getSite(),\r\n                appName: \"cobrowse\",\r\n                app: secureStorageApp,\r\n                key: \"s.tid\",\r\n                domain: secureStorageDomain,\r\n                success: callback\r\n            });\r\n        }\r\n    }\r\n\r\n    function _getCoBrowseDomain() {\r\n        var serviceName = 'coBrowse';\r\n        var domain = config.domain;\r\n\r\n        if (!domain) {\r\n            if (win.lpTag && win.lpTag.taglets && win.lpTag.taglets.caoServiceMap) {  // standard (webagent, le 2.0)\r\n                return win.lpTag.taglets.caoServiceMap.getDomain(serviceName);\r\n            }\r\n        }\r\n\r\n        return domain;\r\n    }\r\n\r\n    function _getCobrowseBaseUrl(site, domain) {\r\n        site = site || _getSite();\r\n        domain = domain || _getCoBrowseDomain();\r\n\r\n        return 'https://' + site + '.' + domain;\r\n    }\r\n\r\n    //log functions\r\n    function _log(msg, lvl) {\r\n        if (win.lpTag && win.lpTag.log) {\r\n            win.lpTag.log(msg, lvl, name + \" taglet\");\r\n        }\r\n    }\r\n\r\n    function _info(msg) {\r\n        _log(msg, 'INFO');\r\n    }\r\n\r\n    //dom functions\r\n    function _loadScript(url, id) {\r\n\r\n        if (id && doc.getElementById(id)) {\r\n            return;\r\n        }\r\n\r\n        var script = doc.createElement(\"script\");\r\n        script.setAttribute(\"type\", \"text/javascript\");\r\n        script.setAttribute(\"charset\", \"UTF-8\");\r\n        script.setAttribute(\"src\", url);\r\n\r\n        if (id) {\r\n            script.setAttribute(\"id\", id);\r\n        }\r\n\r\n        var body = doc.body || doc.getElementsByTagName('body')[0];\r\n        body.appendChild(script);\r\n    }\r\n\r\n\r\n    // object and array functions\r\n    function _forEach(arr, callback, thisObject) {\r\n        var i = 0, l = arr && arr.length || 0;\r\n        if (l && typeof arr == \"string\") {\r\n            arr = arr.split(\"\");\r\n        }\r\n\r\n        if (thisObject) {\r\n            for (; i < l; ++i) {\r\n                callback.call(thisObject, arr[i], i, arr);\r\n            }\r\n        } else {\r\n            for (; i < l; ++i) {\r\n                callback(arr[i], i, arr);\r\n            }\r\n        }\r\n    }\r\n\r\n    function _mixin(objectA, objectB) {\r\n        if (!objectA || !objectB) {\r\n            return objectA;\r\n        }\r\n\r\n        for (var key in objectB) {\r\n            if (objectB.hasOwnProperty(key)) {\r\n                objectA[key] = objectB[key];\r\n            }\r\n        }\r\n        return objectA;\r\n    }\r\n\r\n    function _readNamespace(path, global) {\r\n        global = global || win;\r\n        if (typeof path == \"string\") {\r\n            path = path.split('.');\r\n        }\r\n\r\n        var obj = global;\r\n        if (path && path.length) {\r\n            for (var i = 0; i < path.length; i++) {\r\n                if (typeof obj[path[i]] !== \"undefined\") {\r\n                    obj = obj[path[i]];\r\n                } else {\r\n                    return undefined;\r\n                }\r\n            }\r\n        }\r\n\r\n        return obj;\r\n    }\r\n\t\r\n    function _addLpTagGetDomain() {\r\n        lpTag.getDomain = function(serviceName) {\r\n            return lpTag.taglets.caoServiceMap.getDomain(serviceName);\r\n        };\r\n    }\r\n\r\n    return {\r\n        v: version,\r\n        name: name,\r\n        init: init,     // 1. Called after evaluating the taglet code. After all taglets have been initiaized, lpTag\r\n        //    triggers the \"LPTAG\" \"ON_READY\" event.\r\n        start: start,   // 2. Called after initializing the taglet codeAfter all taglets have been started, lpTag\r\n        //    triggers the \"LPTAG\" \"ON_STARTED\" event.\r\n        config: config,\r\n        loadApi: function (callback) {\r\n            _loadVisitorApi().then(callback);\r\n        },\r\n        onBeforeNavigation: function () {\r\n            _onBeforeNavigation();\r\n        },\r\n\r\n        // When developing taglets a new addition called ‘includes’ was added to an interface. This parameter is\r\n        // optional and if exists has to contain either an object or an array of objects in the form:\r\n        // { ‘name’ : ‘TAGLET_NAME’}.\r\n        // This will allow order of dependency resolution on the client side. WARNING: DO NOT ADD TAGLETS\r\n        // TO INCLUDES THAT MIGHT NOT BE DEFINED.\r\n        // see: https://docs.google.com/document/d/1cbYwmFKaQkXbQFE6--SwDX-cR2bJTAV0O5bfn-XB79g/edit\r\n        includes: [\r\n            //    LESSON LEARNED: DO NOT INCLUDE LP_VARS AS IT IS ONLY DEFINED FOR LEGACY CLONE ACCOUNTS!\r\n            //    name: \"lp_vars\" // for clone account detection\r\n            {\r\n                name: \"lp_global_utils\" // for converting taglet parameters\r\n            },\r\n            {\r\n                name: \"lpSecureStorage\" // for storing session data\r\n            }\r\n        ],\r\n        inspect: function () {\r\n            // exposed for testing and debugging\r\n            return {\r\n                _setServiceId: _setServiceId,\r\n                _requestCobrowse: _requestCobrowse,\r\n                config: config\r\n            };\r\n        },\r\n        accept: function (event) {\r\n            _handleAccepted(event);\r\n        },\r\n        testEvent: function (text) {\r\n            win.lpTag.events.trigger(uwAppName, text,\r\n                {\r\n                    svid: caoVisitorId,\r\n                    visitorName: _getVisitorName()\r\n                });\r\n        }\r\n    };\r\n\r\n\r\n})();\r\n\r\n\r\n","parameters":null},{"name":"caoPresence","code":"window.lpTag.taglets.caoPresence = (function () {\n    var _v = '1.0',\n\t\t_name = 'caoPresence',\n\t\t_increment = 0,\n\t\t_cache = [],\n\t\t_requestState = {\n\t\t\twaiting: \"waiting\",\n\t\t\tready: \"ready\",\n\t\t\terror: \"error\"\n\t\t};\n\t\n    function init() {\n\n\t}\n\t\n\tfunction getPresenceSdkMethod(presenceRequest) {\n\t\tlpTag.taglets.eventAPI.sendAnalyticEvent(lpTag.providerId, lpTag.taglets.caoEngager.sdkSessionId, presenceRequest.engagementId, 13);\n\t\tgetPresence(presenceRequest);\n\t}\n\t\n\tfunction getPresence(presenceRequest) {\n\t\tif (!presenceRequest || !presenceRequest.referenceId ||\n\t\t\t!presenceRequest.onSuccess || !presenceRequest.onError ||\n\t\t\t!lpTag.taglets || !lpTag.taglets.caoServiceMap || !lpTag.taglets.jsLoader) {\n\t\t\t\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tvar cacheKey = 'p-' + lpTag.providerId + 'ref-' + presenceRequest.referenceId;\n\t\t\n\t\tif(presenceRequest.departmentRef) {\n\t\t\tcacheKey += 'dref-' + presenceRequest.departmentRef;\n\t\t}\n\t\t\n\t\tif(presenceRequest.engagementId) {\n\t\t\tcacheKey += 'eng-' + presenceRequest.engagementId;\n\t\t}\n\t\t\n\t\tif(presenceRequest.refreshCache === undefined || !presenceRequest.refreshCache) {\n\t\t\tvar cachedRequest = _cache[cacheKey];\n\t\t\tif (cachedRequest) {\n\t\t\t\thandleCachedRequest(cachedRequest, presenceRequest.onSuccess, presenceRequest.onError);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t\n\t\tcacheRequest(cacheKey, presenceRequest);\n\t\t\n\t\tvar presenceUrl = createPresenceUrl(cacheKey, presenceRequest);\n\t\tvar request = createRequest(cacheKey, presenceUrl, presenceRequest.onError);\n\t\tlpTag.taglets.jsLoader.loadJS(request);\n\t}\n\n    function clearPresenceData() {\n        _increment++;\n        var keys = Object.keys(_cache);\n        for(var i = 0; i < keys.length; i++) {\n            delete _cache[keys[i]];\n        }\n    }\n\n\tfunction getCache() {\n\t\treturn _cache;\n\t}\n\t\n\tfunction cacheRequest(cacheKey, presenceRequest) {\n\t\t_cache[cacheKey] = {\n\t\t\tcallback: function(response) {\n\t\t\t\t\n\t\t\t\tvar callbackData = {\n\t\t\t\t\treferenceId: presenceRequest.referenceId,\n\t\t\t\t\tpresenceStatus: response.presenceStatus,\n\t\t\t\t\tengagementId: presenceRequest.engagementId\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\tif(presenceRequest.departmentRef) {\n\t\t\t\t\tcallbackData.departmentRef = presenceRequest.departmentRef;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvar cacheValue = _cache[cacheKey];\n\t\t\t\tcacheValue.callbackData = callbackData;\n\t\t\t\tcacheValue.requestState = _requestState.ready;\n\t\t\t\tpresenceRequest.onSuccess(callbackData);\n\t\t\t\t\n\t\t\t\tif (cacheValue.waitingCallbacks) {\n\t\t\t\t\twhile (cacheValue.waitingCallbacks.length > 0) {\n\t\t\t\t\t\tcacheValue.waitingCallbacks.pop().success(callbackData);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\trequestState: _requestState.waiting\n\t\t};\n\t}\n\t\n\tfunction handleCachedRequest(cachedRequest, onSuccess, onError) {\n\t\tswitch(cachedRequest.requestState) {\n\t\t\t\tcase _requestState.ready:\n\t\t\t\t\tonSuccess(cachedRequest.callbackData);\n\t\t\t\t\tbreak;\n\t\t\t\tcase _requestState.waiting:\n\t\t\t\t\tcachedRequest.waitingCallbacks = cachedRequest.waitingCallbacks || [];\n\t\t\t\t\tcachedRequest.waitingCallbacks.push({\n\t\t\t\t\t\tsuccess: onSuccess,\n\t\t\t\t\t\terror: onError\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tonError(cachedRequest.error);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t}\n\t\n\tfunction createPresenceUrl(cacheKey, presenceRequest) {\n\t\tvar url = lpTag.protocol + '//' + lpTag.taglets.caoServiceMap.getDomain('presence') + '/api/v1.0/presence/agentpresence' +\n\t\t\t'?referenceId=' + presenceRequest.referenceId +\n\t\t\t'&placementId=' + presenceRequest.engagementId +\n\t\t\t'&providerId=' + lpTag.providerId +\n\t\t\t'&increment=' + (_increment++) +\n\t\t\t'&callback=lpTag.taglets.caoPresence.cache[\"' + cacheKey + '\"].callback';\n\t\t\t\n\t\tif(presenceRequest.departmentRef) {\n\t\t\turl += '&departmentRef=' + presenceRequest.departmentRef;\n\t\t}\n\t\t\n\t\treturn url;\n\t}\n\t\n\tfunction createRequest(cacheKey, presenceUrl, onError) {\n\t\treturn {\n\t\t\tloadObj: {\n\t\t\t\tpresence: presenceUrl\n\t\t\t},\n\t\t\tsuccess: function(res) {\n\t\t\t\t\n\t\t\t},\n\t\t\terror: function(res) {\n\t\t\t\tvar cacheValue = _cache[cacheKey];\n\t\t\t\tcacheValue.error = res;\n\t\t\t\tcacheValue.requestState = _requestState.error;\n\t\t\t\tonError(res);\n\t\t\t\t\n\t\t\t\tif (cacheValue.waitingCallbacks) {\n\t\t\t\t\twhile (cacheValue.waitingCallbacks.length > 0) {\n\t\t\t\t\t\tcacheValue.waitingCallbacks.pop().error(res);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tcontext: window\n\t\t};\n\t}\n\n    return {\n        v: _v,\n        name: _name,\n        init: init,\n\t\tgetPresence: getPresence,\n\t\tgetCache: getCache,\n\t\tclearPresenceData: clearPresenceData,\n\t\tcache: _cache,\n\t\tsdkDef: [\n\t\t\t{\n\t\t\t\tmethodName: \"getPresence\",\n\t\t\t\tfunc: getPresenceSdkMethod\n\t\t\t},\n\t\t\t{\n\t\t\t\tmethodName: \"clearPresenceData\",\n\t\t\t\tfunc: clearPresenceData\n\t\t\t}\n\t\t],\n\t\tincludes: [\n            {\n                name: \"caoServiceMap\"\n            },\n\t\t\t{\n\t\t\t\tname: \"jsLoader\"\n\t\t\t}\n        ]\n    };\n})();","parameters":null},{"name":"googleAnalytics","code":"/**\r\n * trackingUtil.js (CAO-trackingUtil)\r\n * Common methods for tracking taglets\r\n * \r\n * @author Larry Parks\r\n * @depend lpTag.log\r\n * @depend lpTag.unifiedWindow\r\n * @depend lpTag.taglets.jsLoader\r\n*/\r\n\r\nwindow.lpTag = window.lpTag || {};\r\nlpTag.taglets = lpTag.taglets || {};\r\nwindow.lpTag.taglets.trackingUtil = window.lpTag.taglets.trackingUtil || (function () {\r\n    var _version = '1.0';\r\n    var _name = 'trackingUtil';\r\n    \r\n    function setSessionItem(sessionName, referenceId, itemName, itemValue){\r\n        if (sessionName){\r\n            var sessionObject = retrieveSessionObject(sessionName);\r\n\r\n            if (!sessionObject.hasOwnProperty(referenceId)){\r\n                sessionObject[referenceId] = {};\r\n            }\r\n            \r\n            //Only store items that have value\r\n            if (itemValue && itemValue !== 0 && itemValue !== '0'){\r\n                sessionObject[referenceId][itemName] = itemValue;\r\n            } else if (sessionObject[referenceId].hasOwnProperty(itemName)){\r\n                delete sessionObject[referenceId][itemName];\r\n            }\r\n            \r\n            sessionStorage.setItem(sessionName, JSON.stringify(sessionObject));\r\n        }\r\n    }\r\n    \r\n    function getSessionItem(sessionName, referenceId, itemName){\r\n        if (sessionName){\r\n            var sessionObject = retrieveSessionObject(sessionName);\r\n\r\n            if (sessionObject.hasOwnProperty(referenceId) && sessionObject[referenceId].hasOwnProperty(itemName)){\r\n                return sessionObject[referenceId][itemName];\r\n            }\r\n            else{\r\n                return null;\r\n            }\r\n        }\r\n    }\r\n    \r\n    function removeMerchantSession(sessionName, referenceId){\r\n        if (sessionName){\r\n            var sessionObject = retrieveSessionObject(sessionName);\r\n\r\n            if (sessionObject.hasOwnProperty(referenceId)){\r\n                delete sessionObject[referenceId];\r\n            }\r\n\r\n            sessionStorage.setItem(sessionName, JSON.stringify(sessionObject));\r\n        }\r\n    }\r\n\r\n    function retrieveSessionObject(sessionName){\r\n        var jsonString = sessionStorage.getItem(sessionName);\r\n        var sessionObject = {};\r\n        if (jsonString){\r\n            sessionObject = JSON.parse(jsonString);\r\n        }\r\n        \r\n        return sessionObject;\r\n    }\r\n\r\n\tfunction bindUnifiedWindowEvents(targeted_events, callback) {\r\n\t\tlpTag.unifiedWindow.publicEvents = lpTag.unifiedWindow.publicEvents || {};\r\n        var publicEvents = lpTag.unifiedWindow.publicEvents;\r\n        \r\n\t\tfor (var i = targeted_events.length - 1; i >= 0; i--) {\r\n\t\t\tvar unifiedWindowEvent = targeted_events[i];\r\n            unifiedWindowEvent.func = callback;\r\n            \r\n            if (typeof publicEvents[unifiedWindowEvent.appName] === 'undefined' || typeof publicEvents[unifiedWindowEvent.appName][unifiedWindowEvent.eventName] === 'undefined'){\r\n                publicEvents[unifiedWindowEvent.appName] = publicEvents[unifiedWindowEvent.appName] || {};\r\n                publicEvents[unifiedWindowEvent.appName][unifiedWindowEvent.eventName] = publicEvents[unifiedWindowEvent.appName][unifiedWindowEvent.eventName] || [];\r\n                publicEvents[unifiedWindowEvent.appName][unifiedWindowEvent.eventName].push(unifiedWindowEvent);\r\n            }\r\n\t\t\tlpTag.events.bind(unifiedWindowEvent);\r\n        }\r\n\t}\r\n\r\n    function log(message, type, name) {\r\n        if (window.lpTag && window.lpTag.log) {\r\n            window.lpTag.log(message, type, name || _name);\r\n        }\r\n    }\r\n\r\n    function runWhenConditionIsMet(successCallback, conditionFunction, failureCallback, numberOfAttempts) {\r\n        try { \r\n            failureCallback = failureCallback || function () {};\r\n            numberOfAttempts = numberOfAttempts || 1000;\r\n            if (conditionFunction()) {\r\n                successCallback();\r\n            } else if (numberOfAttempts > 0) {\r\n                numberOfAttempts--;\r\n                setTimeout(function() { _runWhenConditionIsMet(successCallback, conditionFunction, failureCallback, numberOfAttempts); }, 50);\r\n            } else {\r\n                failureCallback();\r\n            }\r\n        } catch (error) { \r\n            log('Base Tracking Taglet exception: ' + error.message, 'ERROR'); \r\n        }\r\n    }\r\n\r\n    function isDocumentReady() {\r\n        return document.readyState === 'complete' || document.readyState === 'loaded';\r\n    }\r\n\r\n    return {\r\n        v: _version,\r\n        name: _name,\r\n        setSessionItem: setSessionItem,\r\n        getSessionItem: getSessionItem,\r\n        removeMerchantSession: removeMerchantSession,\r\n        bindUnifiedWindowEvents: bindUnifiedWindowEvents,\r\n        runWhenConditionIsMet: runWhenConditionIsMet,\r\n        retrieveSessionObject: retrieveSessionObject,\r\n        log: log,\r\n        isDocumentReady: isDocumentReady,\r\n\r\n        includes: [\r\n\t\t\t{ name: \"lpUnifiedWindow\" },\r\n\t\t\t{ name: \"jsLoader\" }\r\n        ]\r\n    };\r\n})();\n\n/****************************************************************/\n\n/**\n * googleAnalytics.js (CAO-GoogleAnalytics)\n * This is a JavaScript taglet for Google Analytics integration into Contact At Once's unified window system.\n * This taglet enables Google Analytics reporting for Contact At Once and optionally an account withing CAO. \n * \n * @author Larry Parks\n * @depend lpTag.log\n * @depend lpTag.taglets.lpUtil\n * @depend lpTag.unifiedWindow\n * @depend lpTag.taglets.jsLoader\n*/\n\nwindow.lpTag = window.lpTag || {};\nlpTag.taglets = lpTag.taglets || {};\nwindow.lpTag.taglets.googleAnalytics = (function () {\n    var _version = '1.0';\n\tvar _name = 'googleAnalytics';\n    var _configuration;\n    var _isResuming;\n    var UNIFIED_WINDOW_EVENTS = [{ appName: 'API', eventName: 'userLine' },\n                                 { appName: 'API', eventName: 'line'},\n                                 { appName: 'API', eventName: 'chatInfo' },\n                                 { appName: 'API', eventName: 'trackingState'}\n                                ];\n    var GOOGLE_ANALYTICS_EVENTS = {\n        CHAT_START: { CATEGORY: 'CAO Chat', NAME: 'Conversation Started' },\n        CHAT_CONSUMER_FIRST_MESSAGE: { CATEGORY: 'CAO Chat', NAME: 'Consumer First Message Sent' },\n        CHAT_AGENT_FIRST_MESSAGE: { CATEGORY: 'CAO Chat', NAME: 'Agent First Message Sent' },\n        CHAT_END: { CATEGORY: 'CAO Chat', NAME: 'Conversation Ended' }\n    };\n    var SESSION_NAME = 'CAO' + _name;\n    var AGENT_SENT_FIRST_MESSAGE = 'Agent1stMsg';\n    var CONSUMER_SENT_FIRST_MESSAGE = 'User1stMsg';\n    var CHAT_ACCEPTED = 'ChatAccepted';\n    var MERCHANTID = 'MerchantId';\n    var PROVIDERID = 'ProviderId';\n    var VISITID = 'VisitId';\n    var trackingUtil;\n    var _gaRetryNumbers;\n    var _googleAnalyticsClientId;\n\n    function init(configuration) {\n        _configuration = configuration || {};\n        trackingUtil = window.lpTag.taglets.trackingUtil;\n        _util = lpTag.taglets.lpUtil;\n        _isResuming = {};\n\n        if (configuration.referenceId){\n            setAgentMessageIsSent(_configuration.gaAgentSent === true || getAgentMessageIsSent(), configuration.referenceId);\n            setConsumerMessageIsSent(_configuration.gaConsumerSent === true || getConsumerMessageIsSent(), configuration.referenceId);\n            setHasAgentAccepted(_configuration.gaAgentAccepted === true || getHasAgentAccepted(), configuration.referenceId);    \n        }\n\n        setGoogleAnalyticsClientId(_configuration);\n        trackingUtil.bindUnifiedWindowEvents(UNIFIED_WINDOW_EVENTS, _onUnifiedWindowEvent);\n    }\n\t\n\tfunction start() {\n        try {\n            _googleAnalytics.initialize(); \n        } catch (error) {\n            trackingUtil.log('Taglet start exception: ' + error.message, 'ERROR', _name);\n        }\n    }\n\n    function getAgentMessageIsSent(referenceId) {\n        return trackingUtil.getSessionItem(SESSION_NAME, referenceId, AGENT_SENT_FIRST_MESSAGE) === 1;\n    }\n\n    function setAgentMessageIsSent(isSent, referenceId) {\n        var itemValue = isSent ? 1 : 0;\n        trackingUtil.setSessionItem(SESSION_NAME, referenceId, AGENT_SENT_FIRST_MESSAGE, itemValue);\n    }\n\n    function getConsumerMessageIsSent(referenceId) {\n        return trackingUtil.getSessionItem(SESSION_NAME, referenceId, CONSUMER_SENT_FIRST_MESSAGE) === 1;\n    }\n\n    function setConsumerMessageIsSent(isSent, referenceId) {\n        var itemValue = isSent ? 1 : 0;\n        trackingUtil.setSessionItem(SESSION_NAME, referenceId, CONSUMER_SENT_FIRST_MESSAGE, itemValue);\n    }\n\n    function getHasAgentAccepted(referenceId) {\n        return trackingUtil.getSessionItem(SESSION_NAME, referenceId, CHAT_ACCEPTED) === 1;\n    }\n\n    function setHasAgentAccepted(hasAccepted, referenceId) {\n        var itemValue = hasAccepted ? 1 : 0;\n        trackingUtil.setSessionItem(SESSION_NAME, referenceId, CHAT_ACCEPTED, itemValue);\n    }\n\n    function setGoogleAnalyticsClientId(_configuration) {\n        if (_configuration.gaClientId){\n            _googleAnalyticsClientId = _configuration.gaClientId;\n        }\n        else {\n            _gaRetryNumbers = 0;\n            tryToGetGoogleAnalyticsClientIdFromGATracker();\n        }\n    }\n\n    function tryToGetGoogleAnalyticsClientIdFromGATracker() {\n        if (_googleAnalyticsClientId === undefined){\n            var _clientIdFromGATracker = getGoogleAnalyticsClientIdFromGATracker();\n            if (_clientIdFromGATracker) {\n                _googleAnalyticsClientId = _clientIdFromGATracker;\n            }\n            else if (_gaRetryNumbers < 8) {\n                _gaRetryNumbers++;\n                setTimeout(tryToGetGoogleAnalyticsClientIdFromGATracker, 500);\n            }\n        }\n    }\n\n    function getGoogleAnalyticsClientIdFromGATracker() {\n        if (window.ga && typeof window.ga === 'function' && typeof window.ga.getAll === 'function') {\n            if (window.ga.getAll() && window.ga.getAll()[0]) {\n                return window.ga.getAll()[0].get('clientId');\n            }\n        }\n\n        return undefined;\n    }\n\n    function getGoogleAnalyticsClientId() {\n        return _googleAnalyticsClientId;\n    }\n\n\tfunction _onUnifiedWindowEvent(eventData, eventInfo) {\n        eventInfo = eventInfo || {};\n        eventData = eventData || {};\n        var referenceId;\n\n        // trackingUtil.log('eventData:' + JSON.stringify(eventData) + ',\\n eventInfo: ' + JSON.stringify(eventInfo), 'INFO', _name);\n\n        if (eventData.eventName === 'chatInfo'){\n            referenceId = eventData.data.referenceId ?  eventData.data.referenceId : lpTag.taglets.lpUnifiedWindow.inspect().conf.referenceId;\n            if (eventData.data.accountMerchantId && eventData.data.accountName && eventData.data.accountProviderId){               \n                trackingUtil.setSessionItem(SESSION_NAME, referenceId, MERCHANTID, eventData.data.accountMerchantId);\n                trackingUtil.setSessionItem(SESSION_NAME, referenceId, PROVIDERID, eventData.data.accountProviderId);\n            }\n            if (eventData.data.rtSessionId && eventData.data.rtSessionId !== '' &&  eventData.data.rtSessionId != 'undefined'){\n                //Always get the lastest visitId for new chats\n                var visitId = trackingUtil.getSessionItem(SESSION_NAME, referenceId, VISITID);\n                if (Number(eventData.data.rtSessionId) === visitId && _isResuming.hasOwnProperty(referenceId)){\n                    delete _isResuming[referenceId];\n                } else {\n                    trackingUtil.setSessionItem(SESSION_NAME, referenceId, VISITID, Number(eventData.data.rtSessionId));\n                }\n            }\n        } else if (eventInfo.eventName === 'trackingState' && eventData && eventData.data) { // state events\n            referenceId = eventData.data.referenceId ?  eventData.data.referenceId : lpTag.taglets.lpUnifiedWindow.inspect().conf.referenceId;\n            if (eventData.data.state === 'resume') {\n                _isResuming[referenceId] = true;\n            } else if (eventData.data.state === 'waiting' && !_isResuming.hasOwnProperty(referenceId)) {\n                trackingUtil.log('Chat started, no event sent', 'INFO', _name);\n                setHasAgentAccepted(false, referenceId);\n                setAgentMessageIsSent(false, referenceId);\n                setConsumerMessageIsSent(false, referenceId);\n            } else if (eventData.data.state === 'ended') {\n                trackingUtil.log('Chat ended, no event sent', 'INFO', _name);\n                trackingUtil.removeMerchantSession(SESSION_NAME, referenceId);\n                if(_isResuming.hasOwnProperty(referenceId)){\n                    delete _isResuming[referenceId];\n                }\n                // Chat Ended event will be reported from the ChatActivityReporter\n            } else if (eventData.data.state === 'chatting' && getHasAgentAccepted(referenceId) === false){\n                //Agent has accepted and start listening for agent first message\n                trackingUtil.log(\"Agent has accepted, no event sent\", 'INFO', _name);\n                setHasAgentAccepted(true, referenceId);\n            }\n        } else if (eventInfo.eventName === 'line' && eventData.data.source === 'visitor') { \n            referenceId = eventData.data.referenceId ?  eventData.data.referenceId : lpTag.taglets.lpUnifiedWindow.inspect().conf.referenceId;\n            if (getConsumerMessageIsSent(referenceId) !== true){\n                //Consumer sent first message\n                trackingUtil.log('First consumer message event sent', 'INFO', _name);\n                _googleAnalytics.sendConversationEvent(GOOGLE_ANALYTICS_EVENTS.CHAT_CONSUMER_FIRST_MESSAGE.NAME, referenceId);\n                setConsumerMessageIsSent(true, referenceId);\n            }\n        } else if (eventInfo.eventName === 'line' && eventData.data.source === 'agent') {\n            referenceId = eventData.data.referenceId ?  eventData.data.referenceId : lpTag.taglets.lpUnifiedWindow.inspect().conf.referenceId;\n            if (getHasAgentAccepted(referenceId) === true && getAgentMessageIsSent(referenceId) !== true){\n                //Agent sent first message\n                trackingUtil.log('First agent message event sent', 'INFO', _name);\n                _googleAnalytics.sendConversationEvent(GOOGLE_ANALYTICS_EVENTS.CHAT_AGENT_FIRST_MESSAGE.NAME, referenceId);\n                setAgentMessageIsSent(true, referenceId);\n            }\n        }\n    }\n\n    var _googleAnalytics = (function () {\n        var _engagementPresenceDictionary = {};\n        var _overlayEngagement;\n        var _eventsToCancel = [];\n\n        function initialize() {\n            try {\n                trackingUtil.log('Starting initialization of Google Analytics', 'INFO', _name);\n            } catch (error) {\n                trackingUtil.log('Google Analytics initialization exception: ' + error.message, 'ERROR', _name);\n            }\n        }\n\n        function sendConversationEvent(chatAction, referenceId){\n            var merchantId = trackingUtil.getSessionItem(SESSION_NAME, referenceId, MERCHANTID);\n            var providerId = trackingUtil.getSessionItem(SESSION_NAME, referenceId, PROVIDERID);\n            var visitId = trackingUtil.getSessionItem(SESSION_NAME, referenceId, VISITID);\n\n            var originationUrl = encodeURIComponent(window.location.href);\n            var request = new XMLHttpRequest();\n\t\t\t\t\trequest.open('POST', 'https://' + lpTag.taglets.caoServiceMap.getDomain(\"chatAPI\") + '/api/v1.0/taglet/event/googleanalyticflow', true);\n\t\t\t\t\trequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');\n\t\t\t\t\trequest.send('chatAction=' + chatAction + '&merchantId=' + merchantId + '&providerId=' + providerId + '&conversationId=' + visitId + '&originationUrl=' + originationUrl);\n        }\n\n        function sendEngagementEvent(engagement, eventName) {\n            if (_isCancelledEvent(eventName)) { return; }\n            if (_isFilteredOutEngagement(engagement)) { return; }\n\n            _storeEngagementPresence(engagement);\n            _storeOverlayEngagement(engagement);\n\n            if (engagement && eventName) {\n                var body =\n                'engagementId=' + engagement.id + '&' +\n                'engagementUniqueId=' + _getEngagementUniqueId(engagement) + '&' +\n                'engagementFileName=' + encodeURIComponent(engagement.fileName) + '&' +\n                'engagementType=' + _getEngagementType(engagement) + '&' +\n                'eventAction=' + encodeURIComponent(eventName) + '&' +\n                'merchantId=' + (!isNaN(engagement.referenceId) ? engagement.referenceId : '') + '&' +\n                'providerId=' + lpTag.providerId + '&' +\n                'isMobile=' + _isMobile() + '&' +\n                'isPresenceShown=' + _isEngagementPresenceShown(engagement) + '&' +\n                'originationUrl=' + encodeURIComponent(window.location.href) + '&' +\n                'previousUrl=' + encodeURIComponent(document.referrer) + '&' +\n                'clientId=' + _googleAnalyticsClientId + '&' +\n                'pageTitle=' + encodeURIComponent(document.title) + '&' +\n                'userAgent=' + encodeURIComponent(navigator.userAgent);\n                trackingUtil.log('Sending Google Analytics engagement event for: ' + body, 'INFO', _name);\n\n                var request = new XMLHttpRequest();\n                request.open('POST', 'https://' + lpTag.taglets.caoServiceMap.getDomain(\"chatAPI\") + '/api/v1.0/taglet/event/googleanalytics/engagement', true);\n                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');\n                request.send(body);\n            }\n        }\n\n        function sendSecondaryOverlayEngagementEvent(eventName) {\n            if (_overlayEngagement) {\n                var secondaryOverlayEngagement = JSON.parse(JSON.stringify(_overlayEngagement));\n                secondaryOverlayEngagement.isSecondary = true;\n                sendEngagementEvent(secondaryOverlayEngagement, eventName);\n                if (eventName == 'Chat_Click' || eventName == 'SMS_Click') {\n                    // cancel next overlay engagement click event due to already being called for secondary overlay\n                    // this is because the secondary overlay calls the click function on the overlay engagement, causing the event to fire again :(\n                    _eventsToCancel.push(eventName);\n                }\n            } else {\n                trackingUtil.log('Could not find original overlay data when trying to send secondary overlay event: ' + eventName, 'ERROR', _name);\n            }\n        }\n\n        function _isCancelledEvent(eventName) {\n            if (_eventsToCancel.indexOf(eventName) !== -1) {\n                var index = _eventsToCancel.indexOf(eventName);\n                if (index !== -1) { _eventsToCancel.splice(index, 1); }\n                trackingUtil.log('Cancelled Google Analytic event do to already being called by secondary overlay: ' + eventName, 'INFO', _name);\n                return true;\n            }\n            return false;\n        }\n\n        function _isFilteredOutEngagement(engagement) {\n            return engagement.type === 1 ||\n                (engagement.type === 0 && !engagement.fileName) ||\n                (engagement.type === 0 && !(engagement.fileName.indexOf('GMCL') === 0 || engagement.fileName.indexOf('CAO') === 0 || engagement.fileName.indexOf('LPA') === 0));\n        }\n\n        function _isEngagementPresenceShown(engagement) {\n            if (engagement && engagement.id) {\n                return _engagementPresenceDictionary[engagement.id];\n            }\n            return undefined;\n        }\n\n        function _storeEngagementPresence(engagement) {\n            if (engagement && engagement.id && engagement.isPresenceShown !== undefined) {\n                _engagementPresenceDictionary[engagement.id] = engagement.isPresenceShown;\n            }\n        }\n\n        function _storeOverlayEngagement(engagement) {\n            if (engagement && engagement.type === 0) {\n                _overlayEngagement = engagement;\n            }\n        }\n\n        function _getEngagementUniqueId(engagement) {\n            if (engagement && engagement.embeddedEngagement && engagement.embeddedEngagement.elementId) {\n                return encodeURIComponent(engagement.embeddedEngagement.elementId);\n            }\n            return undefined;\n        }\n\n        // mapping engagement configuration types to Google Analytic engagement types\n        function _getEngagementType(engagement) {\n            if (!engagement) { return 0; }\n            switch (engagement.type) {\n                case 0: return engagement.isSecondary ? 1 : 0;\n                case 1: return _isEngagementPresenceShown(engagement) ? 2 : 3;\n                case 2: return 4;\n                default: return engagement.type < 5 ? 5 : engagement.type;\n            }\n        }\n\n        // this mobile detection was copied from the engagements\n        // needs to be exactly the same so that reporting isn't out-of-sync from what was shown\n        function _isMobile() {\n            var isAndroid = navigator.userAgent.match(/Android/i);\n            var isBlackBerry = navigator.userAgent.match(/BlackBerry/i);\n            var isIOS = navigator.userAgent.match(/iPhone|iPad|iPod/i);\n            var isOpera = navigator.userAgent.match(/Opera Mini/i);\n            var isWindows = navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);\n            return (isAndroid || isBlackBerry || isIOS || isOpera || isWindows) ? true : false;\n        }\n\n        return {\n            initialize: initialize,\n            sendConversationEvent: sendConversationEvent,\n            sendEngagementEvent: sendEngagementEvent,\n            sendSecondaryOverlayEngagementEvent: sendSecondaryOverlayEngagementEvent\n        };\n    })();\n\n    return {\n        v: _version,\n        name: _name,\n        init: init,\n        start: start,\n        getAgentMessageIsSent: getAgentMessageIsSent,\n        getConsumerMessageIsSent: getConsumerMessageIsSent,\n        getHasAgentAccepted: getHasAgentAccepted,\n        getGoogleAnalyticsClientId: getGoogleAnalyticsClientId,\n        getGoogleAnalyticsClientIdFromGATracker: getGoogleAnalyticsClientIdFromGATracker,\n        sendGoogleAnalyticsEngagementEvent: _googleAnalytics.sendEngagementEvent,\n        sendGoogleAnalyticsSecondaryOverlayEngagementEvent: _googleAnalytics.sendSecondaryOverlayEngagementEvent,\n        includes: [\n\t\t\t{ name: \"lpUnifiedWindow\" },\n\t\t\t{ name: \"jsLoader\" }\n        ]\n    };\n})();","parameters":{"caoTrackingId":"UA-123581995-30","trackingId":""}}],"retry":false});